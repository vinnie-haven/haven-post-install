<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haven Energy - Post-Install Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    .edit-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; z-index: 50; min-width: 250px; max-height: 400px; overflow-y: auto; background: #1e293b; border: 1px solid #334155; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); margin-top: 4px; }
    .dropdown-menu.open { display: block; }
    .checkbox-item { padding: 6px 12px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px; }
    .checkbox-item:hover { background: #334155; }
    .checkbox-item input { accent-color: #10b981; width: 16px; height: 16px; }
    .filter-active { color: #10b981 !important; }
    .table-container { max-height: calc(100vh - 380px); overflow-y: auto; }
    .sticky-header th { position: sticky; top: 0; background: #0f172a; z-index: 10; }
    .upload-zone { border: 2px dashed #475569; transition: all 0.2s; min-height: 80px; }
    .upload-zone:hover, .upload-zone.dragover { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
    .editable { cursor: pointer; transition: all 0.15s; }
    .editable:hover { background: rgba(16, 185, 129, 0.1); border-radius: 4px; }
    .sync-btn.syncing { animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .subtab { transition: all 0.15s; }
    .subtab:hover { background: rgba(255,255,255,0.05); }
    .subtab.active { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.5); }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
  <!-- Password Protection Screen -->
  <div id="loginScreen" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-[200]">
    <div class="bg-slate-800 rounded-xl p-8 max-w-sm w-full mx-4 border border-slate-700 shadow-2xl">
      <div class="flex justify-center mb-6">
        <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-emerald-500 to-cyan-500 flex items-center justify-center">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
        </div>
      </div>
      <h1 class="text-2xl font-bold text-center bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent mb-2">Haven Energy</h1>
      <p class="text-center text-slate-400 text-sm mb-6">Post-Install Portal</p>
      <form onsubmit="checkPassword(event)">
        <label class="block text-sm font-medium text-slate-400 mb-2">Enter Password</label>
        <input type="password" id="passwordInput" class="w-full px-4 py-3 rounded-lg bg-slate-900 border border-slate-700 text-slate-100 focus:outline-none focus:border-emerald-500 mb-4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autofocus>
        <p id="passwordError" class="text-red-400 text-sm mb-4 hidden">Incorrect password. Please try again.</p>
        <button type="submit" class="w-full py-3 bg-gradient-to-r from-emerald-500 to-cyan-500 rounded-lg font-semibold text-white hover:from-emerald-600 hover:to-cyan-600 transition-all">
          Access Dashboard
        </button>
      </form>
    </div>
  </div>

  <div id="uploadModal" class="edit-modal hidden">
    <div class="bg-slate-800 rounded-xl p-6 max-w-lg w-full mx-4 border border-slate-700">
      <h2 class="text-xl font-bold mb-4">üì§ Update SGIP Data</h2>
      <p class="text-sm text-slate-400 mb-3">Upload a new SGIP export to replace the saved data.</p>
      <div class="mb-4">
        <h3 class="font-semibold text-cyan-400 mb-2">SGIP Export (CSV)</h3>
        <div id="sgipUploadZone" class="upload-zone rounded-lg p-3 text-center cursor-pointer flex flex-col items-center justify-center">
          <p class="text-xs text-slate-400">Drop SGIP .csv here</p>
        </div>
        <p id="sgipStatus" class="text-xs text-slate-500 mt-1"></p>
      </div>
      <div id="matchStats" class="p-3 bg-slate-900 rounded-lg text-xs hidden">
        <div class="font-semibold mb-1">Match Statistics:</div>
        <div id="matchStatsContent"></div>
      </div>
      <div class="flex gap-3 mt-4">
        <button onclick="closeUploadModal()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Close</button>
      </div>
    </div>
  </div>

  <div id="correctionModal" class="edit-modal hidden">
    <div class="bg-slate-800 rounded-xl p-6 max-w-lg w-full mx-4 border border-slate-700">
      <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Manage Corrections</h2>
      <p class="text-sm text-slate-400 mb-3">Upload a correction sheet to permanently save manual matches and exclusions.</p>
      <div id="currentCorrections" class="mb-4 p-3 bg-slate-900 rounded-lg text-xs">
        <div class="font-semibold mb-1">Current Corrections in Database:</div>
        <div id="correctionCounts"></div>
      </div>
      <div class="mb-4">
        <h3 class="font-semibold text-amber-400 mb-2">Upload New Corrections (Excel)</h3>
        <p class="text-xs text-slate-400 mb-2">Columns: Email, SGIP Status (code, "Not in SGIP portal", or "Not an SGIP project")</p>
        <div id="correctionUploadZone" class="upload-zone rounded-lg p-3 text-center cursor-pointer flex flex-col items-center justify-center">
          <p class="text-xs text-slate-400">Drop correction .xlsx here</p>
        </div>
        <p id="correctionUploadStatus" class="text-xs text-slate-500 mt-1"></p>
      </div>
      <div class="flex gap-3 mt-4">
        <button onclick="closeCorrectionModal()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Close</button>
      </div>
    </div>
  </div>

  <div id="editModal" class="edit-modal hidden">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700">
      <h3 id="editModalTitle" class="text-lg font-bold mb-4">Edit Field</h3>
      <div id="editModalContent"></div>
      <div class="flex gap-3 mt-6">
        <button onclick="saveEdit()" class="flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-medium">Save</button>
        <button onclick="closeEditModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">Cancel</button>
      </div>
    </div>
  </div>

  <div id="app">Loading...</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <script>
const SUPABASE_URL = 'https://vnxerxefgodekwjdxfqc.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_BjuP0L7Bw2_903MXWqf6Ag_c5QOuB3r';
const HUBSPOT_PORTAL_ID = '23929498';

let DATA = { matched: [], hubspotWithoutSgip: [] };
let HUBSPOT_DATA = [];
let SGIP_DATA = [];
let CORRECTIONS = { manualMatches: {}, notInSgip: new Set(), notSgipProject: new Set() };
let SEARCH_INDEX = [];
let MATCH_STATS = { byEmail: 0, byAddress: 0, byManual: 0, noMatch: 0, excluded: 0 };
let state = { 
  tab: 'installed', 
  statsSubTab: 'activity',
  icfSubTab: 'summary',
  icfSortBy: 'daysSincePto',
  icfSortDir: 'desc',
  ptoSubTab: 'summary',
  ptoSortBy: null,
  ptoSortDir: 'desc',
  search: '', 
  filters: { permitStatus: [], inspectionStatus: [], ptoStatus: [], sgipStage: [], sgipStatus: [], sgipProgress: [], installer: [], installMonth: [], utility: [] },
  sortBy: 'daysSinceInstall', 
  sortDir: 'desc', 
  editingDeal: null, 
  editingField: null,
  syncing: false,
  lastSync: null,
  sgipLoaded: false,
  sgipLastUpdated: null
};

let searchTimeout = null;

async function loadSgipFromSupabase() {
  try {
    let allApplications = [];
    let offset = 0;
    const limit = 1000;
    while (true) {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/sgip_applications?select=*&limit=${limit}&offset=${offset}`, {
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
      });
      if (!response.ok) break;
      const batch = await response.json();
      if (!Array.isArray(batch) || batch.length === 0) break;
      allApplications = allApplications.concat(batch);
      if (batch.length < limit) break;
      offset += limit;
    }
    if (allApplications.length > 0) {
      SGIP_DATA = allApplications.map(a => ({
        email: (a.email || '').toLowerCase().trim(),
        applicationCode: a.application_code || '',
        sgipStage: a.stage || '',
        sgipStatus: a.status || '',
        fullyQualifiedState: a.fully_qualified_state || '',
        currentIncentive: a.current_incentive || '',
        finalIncentive: a.final_incentive || '',
        nextDueDate: a.next_due_date || '',
        siteAddress: a.site_address || '',
        utility: a.utility || '',
        icfSubmittedDate: a.icf_submitted_date || '',
        icfResubmittedDate: a.icf_resubmitted_date || '',
        icfPendingPaymentDate: a.icf_pending_payment_date || '',
        icfSuspendedDate: a.icf_suspended_date || '',
        icfInspectionDate: a.icf_inspection_date || '',
        inspectionDate: a.inspection_date || '',
        paymentAmount: a.payment_amount || '',
        paymentDate: a.payment_date || '',
        paymentCompletedDate: a.payment_completed_date || '',
        budgetCategory: a.budget_category || ''
      }));
      state.sgipLoaded = true;
      const maxUpdated = allApplications.reduce((max, a) => { const t = new Date(a.updated_at).getTime(); return t > max ? t : max; }, 0);
      if (maxUpdated) state.sgipLastUpdated = new Date(maxUpdated).toLocaleString();
      return true;
    }
  } catch (e) { console.error('Failed to load SGIP:', e); }
  return false;
}

async function saveSgipToSupabase(sgipData) {
  if (!sgipData || sgipData.length === 0) return false;
  const records = sgipData.map(s => ({
    application_code: s.applicationCode, email: s.email, stage: s.sgipStage, status: s.sgipStatus,
    fully_qualified_state: s.fullyQualifiedState || null,
    current_incentive: s.currentIncentive, final_incentive: s.finalIncentive, next_due_date: s.nextDueDate,
    site_address: s.siteAddress, utility: s.utility, icf_submitted_date: s.icfSubmittedDate || null,
    icf_resubmitted_date: s.icfResubmittedDate || null, icf_pending_payment_date: s.icfPendingPaymentDate || null,
    icf_suspended_date: s.icfSuspendedDate || null,
    icf_inspection_date: s.icfInspectionDate || null,
    inspection_date: s.inspectionDate || null,
    payment_amount: s.paymentAmount || null, payment_date: s.paymentDate || null,
    payment_completed_date: s.paymentCompletedDate || null,
    budget_category: s.budgetCategory || null,
    updated_at: new Date().toISOString()
  })).filter(r => r.application_code);
  if (records.length === 0) return false;
  try {
    await fetch(`${SUPABASE_URL}/rest/v1/sgip_applications?application_code=neq.IMPOSSIBLE`, {
      method: 'DELETE', headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
    });
    for (let i = 0; i < records.length; i += 500) {
      const batch = records.slice(i, i + 500);
      const response = await fetch(`${SUPABASE_URL}/rest/v1/sgip_applications`, {
        method: 'POST',
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
        body: JSON.stringify(batch)
      });
      if (!response.ok) return false;
    }
    state.sgipLastUpdated = new Date().toLocaleString();
    return true;
  } catch (e) { console.error('Failed to save SGIP:', e); return false; }
}

async function loadCorrectionsFromSupabase() {
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/corrections?select=*`, {
      headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
    });
    const corrections = await response.json();
    if (Array.isArray(corrections)) {
      CORRECTIONS = { manualMatches: {}, notInSgip: new Set(), notSgipProject: new Set() };
      corrections.forEach(c => {
        const email = c.email.toLowerCase().trim();
        if (c.correction_type === 'manual_match' && c.sgip_code) CORRECTIONS.manualMatches[email] = c.sgip_code;
        else if (c.correction_type === 'not_in_portal') CORRECTIONS.notInSgip.add(email);
        else if (c.correction_type === 'not_sgip_project') CORRECTIONS.notSgipProject.add(email);
      });
      return true;
    }
  } catch (e) { console.error('Failed to load corrections:', e); }
  return false;
}

async function saveCorrectionsToSupabase(newCorrections) {
  const records = [];
  for (const [email, code] of Object.entries(newCorrections.manualMatches)) records.push({ email: email.toLowerCase().trim(), correction_type: 'manual_match', sgip_code: code });
  for (const email of newCorrections.notInSgip) records.push({ email: email.toLowerCase().trim(), correction_type: 'not_in_portal', sgip_code: null });
  for (const email of newCorrections.notSgipProject) records.push({ email: email.toLowerCase().trim(), correction_type: 'not_sgip_project', sgip_code: null });
  if (records.length === 0) return false;
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/corrections`, {
      method: 'POST',
      headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
      body: JSON.stringify(records)
    });
    return response.ok;
  } catch (e) { console.error('Failed to save corrections:', e); return false; }
}

async function loadFromSupabase() {
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/deals?select=*`, {
      headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
    });
    const deals = await response.json();
    if (Array.isArray(deals)) {
      HUBSPOT_DATA = deals.map(d => ({
        dealId: String(d.id), dealName: d.deal_name, customerName: parseCustomerName(d.deal_name),
        email: (d.email || '').toLowerCase().trim(), installDate: d.install_date,
        permitStatus: mapPermit(d.permit_status), ptoDate: d.pto_date,
        inspectionStatus: mapInspection(d.inspection_status), sgipStatusHubspot: d.sgip_status_hubspot, installer: d.installer
      }));
      const syncResponse = await fetch(`${SUPABASE_URL}/rest/v1/sync_log?select=completed_at&order=completed_at.desc&limit=1`, {
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
      });
      const syncLog = await syncResponse.json();
      if (syncLog?.[0]?.completed_at) state.lastSync = new Date(syncLog[0].completed_at).toLocaleString();
      return true;
    }
  } catch (e) { console.error('Failed to load from Supabase:', e); }
  return false;
}

async function triggerSync() {
  state.syncing = true; render();
  try {
    const response = await fetch(`${SUPABASE_URL}/functions/v1/sync-hubspot`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
    const result = await response.json();
    if (result.success) { state.lastSync = new Date().toLocaleString(); await loadFromSupabase(); mergeData(); alert(`Synced ${result.deals_synced} deals, ${result.emails_fetched} emails`); }
    else alert('Sync failed: ' + (result.error || 'Unknown error'));
  } catch (e) { alert('Sync failed: ' + e.message); }
  state.syncing = false; render();
}

function normalizeAddress(addr) {
  if (!addr) return '';
  let normalized = addr.split('\n')[0].split(',')[0];
  normalized = normalized.toLowerCase().trim().replace(/\s+/g, ' ').replace(/\bstreet\b/g, 'st').replace(/\bavenue\b/g, 'ave').replace(/\bdrive\b/g, 'dr').replace(/\broad\b/g, 'rd').replace(/\bcourt\b/g, 'ct').replace(/\bcircle\b/g, 'cir').replace(/\blane\b/g, 'ln').replace(/\bplace\b/g, 'pl').replace(/\bboulevard\b/g, 'blvd').replace(/\./g, '').replace(/,/g, '').trim();
  return normalized;
}

function extractAddressFromDealName(dealName) {
  if (!dealName) return '';
  const parts = dealName.split(':');
  return parts.length > 1 ? normalizeAddress(parts[1].trim()) : '';
}

function parseCustomerName(dealName) {
  if (!dealName) return null;
  let name = dealName.split(':')[0].trim().replace(/\s*\(.*?\)\s*/g, '').trim();
  if (name.includes(',')) { const [last, first] = name.split(',', 2); return first ? `${first.trim()} ${last.trim()}` : last.trim(); }
  return name;
}

const permitMap = { 'DONE: Permit approved': 'Approved', 'Permit Rejected': 'Rejected', 'Permit Submitted': 'Submitted', 'Permit Resubmitted': 'Resubmitted', 'Permit revisions in progress': 'Revisions in progress' };
const inspectionMap = { 'Inspection passed': 'Passed', 'Inspection failed': 'Failed', 'Inspection Scheduled': 'Scheduled', 'Inspection requested': 'Requested', 'Inspection Pending HO Action': 'Pending HO Action', 'Meter collar needed': 'Meter Collar Needed' };
function mapPermit(s) { return permitMap[s] || s; }
function mapInspection(s) { return inspectionMap[s] || s; }

function mergeData() {
  const sgipByEmail = {}, sgipByAddress = {}, sgipByCode = {};
  SGIP_DATA.forEach(s => {
    const email = (s.email || '').toLowerCase().trim();
    if (email) sgipByEmail[email] = s;
    const addr = normalizeAddress(s.siteAddress);
    if (addr) sgipByAddress[addr] = s;
    if (s.applicationCode) sgipByCode[s.applicationCode] = s;
  });
  const matched = [], hubspotWithoutSgip = [];
  MATCH_STATS = { byEmail: 0, byAddress: 0, byManual: 0, noMatch: 0, excluded: 0 };
  HUBSPOT_DATA.forEach(h => {
    const email = (h.email || '').toLowerCase().trim();
    const hubspotAddr = extractAddressFromDealName(h.dealName);
    if (CORRECTIONS.notSgipProject.has(email)) { MATCH_STATS.excluded++; return; }
    const isNotInPortal = CORRECTIONS.notInSgip.has(email);
    let sgip = null, matchType = null;
    if (CORRECTIONS.manualMatches[email]) { sgip = sgipByCode[CORRECTIONS.manualMatches[email]]; if (sgip) matchType = 'manual'; }
    if (!sgip && !isNotInPortal) { sgip = sgipByEmail[email]; if (sgip) matchType = 'email'; }
    if (!sgip && !isNotInPortal && hubspotAddr) { sgip = sgipByAddress[hubspotAddr]; if (sgip) matchType = 'address'; }
    const record = { ...h, applicationCode: sgip?.applicationCode || '', sgipStage: sgip?.sgipStage || '', sgipStatus: sgip?.sgipStatus || '', currentIncentive: sgip?.currentIncentive || '', finalIncentive: sgip?.finalIncentive || '', nextDueDate: sgip?.nextDueDate || '', siteAddress: sgip?.siteAddress || '', utility: sgip?.utility || '', sgipProgress: sgip?.fullyQualifiedState || '', budgetCategory: sgip?.budgetCategory || '', icfSubmittedDate: sgip?.icfSubmittedDate || '', icfResubmittedDate: sgip?.icfResubmittedDate || '', icfPendingPaymentDate: sgip?.icfPendingPaymentDate || '', icfSuspendedDate: sgip?.icfSuspendedDate || '', icfInspectionDate: sgip?.icfInspectionDate || '', inspectionDate: sgip?.inspectionDate || '', paymentDate: sgip?.paymentDate || '', paymentCompletedDate: sgip?.paymentCompletedDate || '', paymentAmount: sgip?.paymentAmount || '', matchType, notInPortal: isNotInPortal };
    if (sgip?.applicationCode) { matched.push(record); if (matchType === 'email') MATCH_STATS.byEmail++; else if (matchType === 'address') MATCH_STATS.byAddress++; else if (matchType === 'manual') MATCH_STATS.byManual++; }
    else { hubspotWithoutSgip.push(record); MATCH_STATS.noMatch++; }
  });
  DATA = { matched, hubspotWithoutSgip };
  buildSearchIndex();
  updateMatchStatsDisplay();
  render();
}

function updateMatchStatsDisplay() {
  const statsDiv = document.getElementById('matchStats'), contentDiv = document.getElementById('matchStatsContent');
  if (statsDiv && contentDiv) {
    statsDiv.classList.remove('hidden');
    contentDiv.innerHTML = `<span class="text-emerald-400">‚úì ${MATCH_STATS.byEmail} by email</span> ¬∑ <span class="text-cyan-400">‚úì ${MATCH_STATS.byAddress} by address</span> ¬∑ <span class="text-purple-400">‚úì ${MATCH_STATS.byManual} manual</span><br><span class="text-amber-400">${MATCH_STATS.noMatch} unmatched</span> ¬∑ <span class="text-slate-500">${MATCH_STATS.excluded} excluded</span>`;
  }
}

function getAllInstalled() {
  return [...DATA.matched, ...DATA.hubspotWithoutSgip];
}

function buildSearchIndex() {
  const allInstalled = getAllInstalled();
  SEARCH_INDEX = allInstalled.map((d, i) => ({ idx: i, text: [d.dealName||'', d.customerName||'', d.applicationCode||'', d.email||'', d.installer||'', d.siteAddress||''].join(' ').toLowerCase() }));
}

function showUploadModal() {
  document.getElementById('uploadModal').classList.remove('hidden');
  document.getElementById('sgipStatus').innerHTML = state.sgipLoaded ? `<span class="text-emerald-400">‚úì ${SGIP_DATA.length} records (saved ${state.sgipLastUpdated || 'unknown'})</span>` : '<span class="text-slate-500">Not loaded</span>';
  updateMatchStatsDisplay();
  setTimeout(setupSgipUpload, 50);
}
function closeUploadModal() { document.getElementById('uploadModal').classList.add('hidden'); }

function showCorrectionModal() {
  document.getElementById('correctionModal').classList.remove('hidden');
  document.getElementById('correctionCounts').innerHTML = `<span class="text-purple-400">${Object.keys(CORRECTIONS.manualMatches).length} manual matches</span> ¬∑ <span class="text-amber-400">${CORRECTIONS.notInSgip.size} not in portal</span> ¬∑ <span class="text-slate-500">${CORRECTIONS.notSgipProject.size} excluded</span>`;
  document.getElementById('correctionUploadStatus').innerHTML = '';
  setTimeout(setupCorrectionUpload, 50);
}
function closeCorrectionModal() { document.getElementById('correctionModal').classList.add('hidden'); }

function setupSgipUpload() {
  const sgipZone = document.getElementById('sgipUploadZone');
  if (sgipZone._initialized) return;
  sgipZone._initialized = true;
  const sgipInput = document.createElement('input');
  sgipInput.type = 'file'; sgipInput.accept = '.csv'; sgipInput.style.display = 'none';
  sgipZone.appendChild(sgipInput);
  sgipZone.onclick = () => sgipInput.click();
  sgipZone.ondragover = (e) => { e.preventDefault(); sgipZone.classList.add('dragover'); };
  sgipZone.ondragleave = () => sgipZone.classList.remove('dragover');
  sgipZone.ondrop = (e) => { e.preventDefault(); sgipZone.classList.remove('dragover'); handleSgipFile(e.dataTransfer.files[0]); };
  sgipInput.onchange = () => handleSgipFile(sgipInput.files[0]);
}

function setupCorrectionUpload() {
  const corrZone = document.getElementById('correctionUploadZone');
  if (corrZone._initialized) return;
  corrZone._initialized = true;
  const corrInput = document.createElement('input');
  corrInput.type = 'file'; corrInput.accept = '.xlsx,.xls'; corrInput.style.display = 'none';
  corrZone.appendChild(corrInput);
  corrZone.onclick = () => corrInput.click();
  corrZone.ondragover = (e) => { e.preventDefault(); corrZone.classList.add('dragover'); };
  corrZone.ondragleave = () => corrZone.classList.remove('dragover');
  corrZone.ondrop = (e) => { e.preventDefault(); corrZone.classList.remove('dragover'); handleCorrectionFile(e.dataTransfer.files[0]); };
  corrInput.onchange = () => handleCorrectionFile(corrInput.files[0]);
}

async function handleSgipFile(file) {
  if (!file) return;
  document.getElementById('sgipStatus').innerHTML = '<span class="text-blue-400">Processing...</span>';
  Papa.parse(file, {
    header: true, skipEmptyLines: true,
    complete: async function(results) {
      const newSgipData = results.data.map(row => ({
        email: (row['Host Customer Email'] || '').toLowerCase().trim(),
        applicationCode: row['Application Code'] || '', sgipStage: row['Stage'] || '', sgipStatus: row['Status'] || '',
        fullyQualifiedState: row['Fully Qualified State'] || '',
        currentIncentive: row['Current Incentive ($)'] || '', finalIncentive: row['Final Incentive (ICF)'] || '',
        nextDueDate: row['Next Due Date'] || '', siteAddress: row['Site Address'] || '', utility: row['SGIP Administrator'] || '',
        icfSubmittedDate: row['ICF Submitted Date'] || '', icfResubmittedDate: row['Last ICF Resubmitted Date'] || '',
        icfPendingPaymentDate: row['ICF Pending Payment Date'] || '',
        icfSuspendedDate: row['ICF Suspended Date'] || '',
        icfInspectionDate: row['ICF Inspection Date'] || '',
        inspectionDate: row['Inspection Date'] || '',
        paymentAmount: row['Total Project Incentive Payment'] || '',
        paymentDate: row['Most Recent Payment Date'] || '',
        paymentCompletedDate: row['Payment Completed Date'] || '',
        budgetCategory: row['Budget Category'] || ''
      })).filter(s => s.applicationCode);
      document.getElementById('sgipStatus').innerHTML = '<span class="text-blue-400">Saving to database...</span>';
      const saved = await saveSgipToSupabase(newSgipData);
      if (saved) { SGIP_DATA = newSgipData; state.sgipLoaded = true; document.getElementById('sgipStatus').innerHTML = `<span class="text-emerald-400">‚úì Saved ${SGIP_DATA.length} records!</span>`; mergeData(); }
      else document.getElementById('sgipStatus').innerHTML = `<span class="text-red-400">Failed to save. Check console.</span>`;
    },
    error: function(err) { document.getElementById('sgipStatus').innerHTML = `<span class="text-red-400">Error: ${err.message}</span>`; }
  });
}

async function handleCorrectionFile(file) {
  if (!file) return;
  document.getElementById('correctionUploadStatus').innerHTML = '<span class="text-blue-400">Processing...</span>';
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const workbook = XLSX.read(e.target.result, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
      let headerIdx = 0;
      for (let i = 0; i < Math.min(5, rows.length); i++) { if (rows[i].some(c => String(c).toLowerCase().includes('email'))) { headerIdx = i; break; } }
      const headers = rows[headerIdx].map(h => String(h).toLowerCase().trim());
      const emailIdx = headers.findIndex(h => h.includes('email'));
      const sgipIdx = headers.findIndex(h => h.includes('sgip'));
      const newCorrections = { manualMatches: {}, notInSgip: new Set(), notSgipProject: new Set() };
      for (let i = headerIdx + 1; i < rows.length; i++) {
        const row = rows[i];
        const email = (row[emailIdx] || '').toLowerCase().trim();
        const sgipStatus = (row[sgipIdx] || '').trim();
        if (!email) continue;
        if (sgipStatus.toLowerCase() === 'not an sgip project') newCorrections.notSgipProject.add(email);
        else if (sgipStatus.toLowerCase() === 'not in sgip portal') newCorrections.notInSgip.add(email);
        else if (sgipStatus && sgipStatus.includes('SGIP')) newCorrections.manualMatches[email] = sgipStatus;
      }
      const totalCount = Object.keys(newCorrections.manualMatches).length + newCorrections.notInSgip.size + newCorrections.notSgipProject.size;
      document.getElementById('correctionUploadStatus').innerHTML = '<span class="text-blue-400">Saving to database...</span>';
      const saved = await saveCorrectionsToSupabase(newCorrections);
      if (saved) {
        Object.assign(CORRECTIONS.manualMatches, newCorrections.manualMatches);
        newCorrections.notInSgip.forEach(e => CORRECTIONS.notInSgip.add(e));
        newCorrections.notSgipProject.forEach(e => CORRECTIONS.notSgipProject.add(e));
        document.getElementById('correctionUploadStatus').innerHTML = `<span class="text-emerald-400">‚úì Saved ${totalCount} corrections!</span>`;
        document.getElementById('correctionCounts').innerHTML = `<span class="text-purple-400">${Object.keys(CORRECTIONS.manualMatches).length} manual matches</span> ¬∑ <span class="text-amber-400">${CORRECTIONS.notInSgip.size} not in portal</span> ¬∑ <span class="text-slate-500">${CORRECTIONS.notSgipProject.size} excluded</span>`;
        mergeData();
      } else document.getElementById('correctionUploadStatus').innerHTML = `<span class="text-red-400">Failed to save.</span>`;
    } catch (err) { document.getElementById('correctionUploadStatus').innerHTML = `<span class="text-red-400">Error: ${err.message}</span>`; }
  };
  reader.readAsArrayBuffer(file);
}

const STAGES = [
  { key: '', label: 'Not Started', color: '#64748b', stage: 0 },
  { key: 'RRF: Draft', label: 'RRF Draft', color: '#f59e0b', stage: 1 },
  { key: 'RRF: Submitted', label: 'RRF Submitted', color: '#3b82f6', stage: 1 },
  { key: 'RRF: Review', label: 'RRF Review', color: '#3b82f6', stage: 1 },
  { key: 'RRF: Technical Review', label: 'RRF Tech Review', color: '#3b82f6', stage: 1 },
  { key: 'RRF: Suspended', label: 'RRF Suspended', color: '#ef4444', stage: 1 },
  { key: 'RRF: Resubmitted', label: 'RRF Resubmitted', color: '#f59e0b', stage: 1 },
  { key: 'RRF: Confirmed', label: 'RRF Confirmed', color: '#10b981', stage: 2 },
  { key: 'RRF: Reserved', label: 'RRF Reserved', color: '#10b981', stage: 2 },
  { key: 'ICF: Draft', label: 'ICF Draft', color: '#f59e0b', stage: 3 },
  { key: 'ICF: Submitted', label: 'ICF Submitted', color: '#3b82f6', stage: 3 },
  { key: 'ICF: Review', label: 'ICF Review', color: '#3b82f6', stage: 3 },
  { key: 'ICF: Technical Review', label: 'ICF Tech Review', color: '#3b82f6', stage: 3 },
  { key: 'ICF: Suspended', label: 'ICF Suspended', color: '#ef4444', stage: 3 },
  { key: 'ICF: Resubmitted', label: 'ICF Resubmitted', color: '#f59e0b', stage: 3 },
  { key: 'ICF: Inspection', label: 'ICF Inspection', color: '#8b5cf6', stage: 4 },
  { key: 'ICF: Inspection Suspended', label: 'Insp Suspended', color: '#ef4444', stage: 4 },
  { key: 'ICF: Pending Payment', label: 'Pending Payment', color: '#06b6d4', stage: 5 },
  { key: 'Payment: Completed', label: 'Paid', color: '#22c55e', stage: 6 },
  { key: 'Payment: Processing', label: 'Processing', color: '#06b6d4', stage: 5 },
  { key: 'Cancelled', label: 'Cancelled', color: '#ef4444', stage: -1 },
];

const getStageInfo = k => {
  if (!k) return STAGES[0];
  const found = STAGES.find(s => s.key === k);
  if (found) return found;
  // Handle unknown values with sensible defaults based on prefix
  if (k.startsWith('RRF:')) return { key: k, label: k.replace('RRF: ', ''), color: '#3b82f6', stage: 1 };
  if (k.startsWith('ICF:')) return { key: k, label: k.replace('ICF: ', ''), color: '#3b82f6', stage: 3 };
  if (k.startsWith('Payment:')) return { key: k, label: k.replace('Payment: ', ''), color: '#06b6d4', stage: 5 };
  return { key: k, label: k, color: '#64748b', stage: 0 };
};
const parseNum = v => v ? parseFloat(String(v).replace(/[$,]/g, '')) || 0 : 0;
const fmtCurrency = v => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(v);
const getDaysSince = d => { if (!d || d === 'None') return null; try { return Math.floor((new Date() - new Date(d)) / 86400000); } catch { return null; } };
const parseDate = d => { if (!d || d === 'None' || d === '(No value)') return null; try { if (String(d).includes('/')) { const [m, day, y] = String(d).split('/'); return new Date(2000 + parseInt(y), parseInt(m) - 1, parseInt(day)); } return new Date(d); } catch { return null; } };
const getHubSpotUrl = id => id ? `https://app.hubspot.com/contacts/${HUBSPOT_PORTAL_ID}/deal/${id}` : null;

function getInstallMonth(dateStr) { const d = parseDate(dateStr); if (!d) return null; return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; }
function formatMonthLabel(monthKey) { if (!monthKey) return '(No date)'; const [year, month] = monthKey.split('-'); const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']; return `${monthNames[parseInt(month) - 1]} ${year}`; }

function getFilterCounts(field, transform = v => v) {
  const counts = {};
  const allInstalled = getAllInstalled();
  allInstalled.forEach(d => { let val = transform(d[field]); if (!val || val === '(No value)' || val === 'None') val = '(empty)'; counts[val] = (counts[val] || 0) + 1; });
  return Object.entries(counts).sort((a,b) => b[1] - a[1]);
}

function getInstallMonthCounts() {
  const counts = {};
  const allInstalled = getAllInstalled();
  allInstalled.forEach(d => { const month = getInstallMonth(d.installDate); const key = month || '(No date)'; counts[key] = (counts[key] || 0) + 1; });
  return Object.entries(counts).sort((a, b) => { if (a[0] === '(No date)') return 1; if (b[0] === '(No date)') return -1; return b[0].localeCompare(a[0]); });
}

function getFilteredData() {
  const allInstalled = getAllInstalled();
  let indices = state.search ? SEARCH_INDEX.filter(s => s.text.includes(state.search.toLowerCase())).map(s => s.idx) : allInstalled.map((_, i) => i);
  let r = indices.map(i => ({ ...allInstalled[i], _index: i, daysSinceInstall: getDaysSince(allInstalled[i].installDate) }));
  if (state.filters.permitStatus.length > 0) r = r.filter(d => state.filters.permitStatus.includes(d.permitStatus || '(empty)') || (!d.permitStatus && state.filters.permitStatus.includes('(empty)')));
  if (state.filters.inspectionStatus.length > 0) r = r.filter(d => { let v = d.inspectionStatus; if (!v || v === '(No value)') v = '(empty)'; return state.filters.inspectionStatus.includes(v); });
  if (state.filters.ptoStatus.length > 0) r = r.filter(d => { const has = d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None'; return state.filters.ptoStatus.includes(has ? 'Complete' : 'Pending'); });
  if (state.filters.sgipStage.length > 0) r = r.filter(d => state.filters.sgipStage.includes(d.sgipStage || '(empty)'));
  if (state.filters.sgipStatus.length > 0) r = r.filter(d => state.filters.sgipStatus.includes(d.sgipStatus || '(empty)'));
  if (state.filters.sgipProgress.length > 0) r = r.filter(d => state.filters.sgipProgress.includes(d.sgipProgress || '(empty)'));
  if (state.filters.installer.length > 0) r = r.filter(d => { let v = d.installer; if (!v || v === '(No value)') v = '(empty)'; return state.filters.installer.includes(v); });
  if (state.filters.installMonth.length > 0) r = r.filter(d => { const month = getInstallMonth(d.installDate) || '(No date)'; return state.filters.installMonth.includes(month); });
  if (state.filters.utility.length > 0) r = r.filter(d => { const u = getUtility(d) || '(empty)'; return state.filters.utility.includes(u); });
  r.sort((a, b) => {
    let av, bv;
    if (state.sortBy === 'daysSinceInstall') { av = a.daysSinceInstall ?? -1; bv = b.daysSinceInstall ?? -1; }
    else if (state.sortBy === 'installDate') { const da = parseDate(a.installDate), db = parseDate(b.installDate); av = da ? da.getTime() : (state.sortDir === 'asc' ? Infinity : -Infinity); bv = db ? db.getTime() : (state.sortDir === 'asc' ? Infinity : -Infinity); }
    else if (state.sortBy === 'incentive') { av = parseNum(a.currentIncentive); bv = parseNum(b.currentIncentive); }
    else if (state.sortBy === 'name') { av = a.customerName || ''; bv = b.customerName || ''; }
    else if (state.sortBy === 'stage') { av = getStageInfo(a.sgipProgress).stage; bv = getStageInfo(b.sgipProgress).stage; }
    else if (state.sortBy === 'nextDue') { const da = parseDate(a.nextDueDate), db = parseDate(b.nextDueDate); av = da ? da.getTime() : (state.sortDir === 'asc' ? Infinity : -Infinity); bv = db ? db.getTime() : (state.sortDir === 'asc' ? Infinity : -Infinity); }
    if (typeof av === 'string') return state.sortDir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
    return state.sortDir === 'asc' ? av - bv : bv - av;
  });
  return r;
}

function getPeriodicStats() {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
  const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
  const dayOfWeek = today.getDay();
  const weekStart = new Date(today); weekStart.setDate(weekStart.getDate() - dayOfWeek);
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  const lastWeekEnd = new Date(weekStart);
  const lastWeekStart = new Date(weekStart); lastWeekStart.setDate(lastWeekStart.getDate() - 7);
  const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 1);
  const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const cutoffDate = new Date('2025-04-01');
  
  const parseAnyDate = (dateStr) => { if (!dateStr) return null; let d; if (dateStr.includes('/')) { const parts = dateStr.split('/'); if (parts.length === 3) { let year = parseInt(parts[2]); if (year < 100) year += 2000; d = new Date(year, parseInt(parts[0]) - 1, parseInt(parts[1])); } } else d = new Date(dateStr); return (d && !isNaN(d.getTime())) ? d : null; };
  const isInRange = (dateStr, start, end) => { const d = parseAnyDate(dateStr); if (!d) return false; return d >= start && d < end; };
  const isYesterday = (dateStr) => isInRange(dateStr, yesterday, today);
  const isWTD = (dateStr) => isInRange(dateStr, weekStart, tomorrow);
  const isMTD = (dateStr) => isInRange(dateStr, monthStart, tomorrow);
  const isLastWeek = (dateStr) => isInRange(dateStr, lastWeekStart, lastWeekEnd);
  const isLastMonth = (dateStr) => isInRange(dateStr, lastMonthStart, lastMonthEnd);
  const hasDate = (dateStr) => { const d = parseAnyDate(dateStr); return d !== null; };
  const isAfterCutoff = (dateStr) => { const d = parseAnyDate(dateStr); return d && d >= cutoffDate; };
  
  const allDeals = [...DATA.matched, ...DATA.hubspotWithoutSgip];
  
  // Filter deals installed after 4/1/2025 for lifetime counts
  const postCutoffDeals = allDeals.filter(d => isAfterCutoff(d.installDate));
  const postCutoffCodes = new Set(DATA.matched.filter(d => isAfterCutoff(d.installDate)).map(d => d.applicationCode).filter(c => c));
  
  // Installs lifetime (only after cutoff)
  const installsLifetime = postCutoffDeals.length;
  
  // PTOs - check if ptoDate exists and is valid
  const hasPto = (d) => d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None' && parseAnyDate(d.ptoDate);
  const ptoLifetime = postCutoffDeals.filter(d => hasPto(d)).length;
  const ptoYesterday = allDeals.filter(d => isYesterday(d.ptoDate)).length;
  const ptoWTD = allDeals.filter(d => isWTD(d.ptoDate)).length;
  const ptoMTD = allDeals.filter(d => isMTD(d.ptoDate)).length;
  const ptoLastWeek = allDeals.filter(d => isLastWeek(d.ptoDate)).length;
  const ptoLastMonth = allDeals.filter(d => isLastMonth(d.ptoDate)).length;
  
  // ICF lifetime counts - only for projects with install date after cutoff
  const icfSubmittedLifetime = SGIP_DATA.filter(d => hasDate(d.icfSubmittedDate) && postCutoffCodes.has(d.applicationCode)).length;
  const icfResubmittedLifetime = SGIP_DATA.filter(d => hasDate(d.icfResubmittedDate) && postCutoffCodes.has(d.applicationCode)).length;
  const icfApprovedLifetime = SGIP_DATA.filter(d => hasDate(d.icfPendingPaymentDate) && postCutoffCodes.has(d.applicationCode)).length;
  
  // Payment amounts - use finalIncentive for projects with icfPendingPaymentDate (approved)
  const hasIcfApproval = (d) => d.icfPendingPaymentDate && d.finalIncentive;
  const approvedSgip = SGIP_DATA.filter(d => hasIcfApproval(d));
  
  const sumApprovedByDate = (filterFn) => approvedSgip.filter(d => filterFn(d.icfPendingPaymentDate)).reduce((sum, d) => sum + parseNum(d.finalIncentive), 0);
  const sumApprovedLifetime = approvedSgip.filter(d => postCutoffCodes.has(d.applicationCode)).reduce((sum, d) => sum + parseNum(d.finalIncentive), 0);
  const totalAllApproved = approvedSgip.reduce((sum, d) => sum + parseNum(d.finalIncentive), 0);
  
  return {
    installs: { yesterday: allDeals.filter(d => isYesterday(d.installDate)).length, wtd: allDeals.filter(d => isWTD(d.installDate)).length, mtd: allDeals.filter(d => isMTD(d.installDate)).length, lastWeek: allDeals.filter(d => isLastWeek(d.installDate)).length, lastMonth: allDeals.filter(d => isLastMonth(d.installDate)).length, lifetime: installsLifetime },
    ptos: { yesterday: ptoYesterday, wtd: ptoWTD, mtd: ptoMTD, lastWeek: ptoLastWeek, lastMonth: ptoLastMonth, lifetime: ptoLifetime },
    icfSubmitted: { yesterday: SGIP_DATA.filter(d => isYesterday(d.icfSubmittedDate)).length, wtd: SGIP_DATA.filter(d => isWTD(d.icfSubmittedDate)).length, mtd: SGIP_DATA.filter(d => isMTD(d.icfSubmittedDate)).length, lastWeek: SGIP_DATA.filter(d => isLastWeek(d.icfSubmittedDate)).length, lastMonth: SGIP_DATA.filter(d => isLastMonth(d.icfSubmittedDate)).length, lifetime: icfSubmittedLifetime },
    icfResubmitted: { yesterday: SGIP_DATA.filter(d => isYesterday(d.icfResubmittedDate)).length, wtd: SGIP_DATA.filter(d => isWTD(d.icfResubmittedDate)).length, mtd: SGIP_DATA.filter(d => isMTD(d.icfResubmittedDate)).length, lastWeek: SGIP_DATA.filter(d => isLastWeek(d.icfResubmittedDate)).length, lastMonth: SGIP_DATA.filter(d => isLastMonth(d.icfResubmittedDate)).length, lifetime: icfResubmittedLifetime },
    icfApproved: { yesterday: SGIP_DATA.filter(d => isYesterday(d.icfPendingPaymentDate)).length, wtd: SGIP_DATA.filter(d => isWTD(d.icfPendingPaymentDate)).length, mtd: SGIP_DATA.filter(d => isMTD(d.icfPendingPaymentDate)).length, lastWeek: SGIP_DATA.filter(d => isLastWeek(d.icfPendingPaymentDate)).length, lastMonth: SGIP_DATA.filter(d => isLastMonth(d.icfPendingPaymentDate)).length, lifetime: icfApprovedLifetime },
    paymentAmount: { yesterday: sumApprovedByDate(isYesterday), wtd: sumApprovedByDate(isWTD), mtd: sumApprovedByDate(isMTD), lastWeek: sumApprovedByDate(isLastWeek), lastMonth: sumApprovedByDate(isLastMonth), lifetime: sumApprovedLifetime, allTime: totalAllApproved },
    weekStart: weekStart.toLocaleDateString(), monthStart: monthStart.toLocaleDateString(),
    lastWeekStart: lastWeekStart.toLocaleDateString(), lastWeekEnd: new Date(lastWeekEnd.getTime() - 86400000).toLocaleDateString(),
    lastMonthStart: lastMonthStart.toLocaleDateString(), lastMonthEnd: new Date(lastMonthEnd.getTime() - 86400000).toLocaleDateString()
  };
}

function getStatusCounts() {
  const allDeals = [...DATA.matched, ...DATA.hubspotWithoutSgip];
  const permitApproved = allDeals.filter(d => d.permitStatus === 'Approved').length;
  const inspectionComplete = allDeals.filter(d => d.inspectionStatus === 'Passed').length;
  const inspectionScheduled = allDeals.filter(d => d.inspectionStatus === 'Scheduled' || d.inspectionStatus === 'Requested').length;
  const inspectionMeterCollar = allDeals.filter(d => d.inspectionStatus === 'Meter Collar Needed' || (d.inspectionStatus && d.inspectionStatus.toLowerCase().includes('meter collar'))).length;
  const inspectionNotComplete = allDeals.filter(d => !d.inspectionStatus || d.inspectionStatus === '(No value)' || d.inspectionStatus === 'Failed' || d.inspectionStatus === 'Pending HO Action').length;
  const ptoComplete = allDeals.filter(d => d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None').length;
  const ptoPending = allDeals.filter(d => !d.ptoDate || d.ptoDate === '(No value)' || d.ptoDate === 'None');
  const ptoPendingSubmitted = ptoPending.filter(d => d.ptoSubmittedDate && d.ptoSubmittedDate !== '(No value)' && d.ptoSubmittedDate !== 'None').length;
  const ptoPendingNotSubmitted = ptoPending.length - ptoPendingSubmitted;
  return {
    permit: { approved: permitApproved, notApproved: allDeals.length - permitApproved },
    inspection: { complete: inspectionComplete, scheduled: inspectionScheduled, meterCollar: inspectionMeterCollar, notComplete: inspectionNotComplete },
    pto: { complete: ptoComplete, pendingSubmitted: ptoPendingSubmitted, pendingNotSubmitted: ptoPendingNotSubmitted },
    total: allDeals.length
  };
}

function getInstallsByMonth() {
  const allDeals = [...DATA.matched, ...DATA.hubspotWithoutSgip];
  const byMonth = {};
  allDeals.forEach(d => {
    const month = getInstallMonth(d.installDate);
    if (!month) return;
    if (!byMonth[month]) byMonth[month] = { total: 0, icfComplete: 0, icfPending: 0, inspectionComplete: 0, ptoComplete: 0 };
    byMonth[month].total++;
    const sgipProgress = (d.sgipProgress || '').toLowerCase();
    // ICF Complete = Pending Payment or Payment Completed (any variation)
    if (sgipProgress.includes('pending payment') || sgipProgress.includes('payment') && sgipProgress.includes('completed')) byMonth[month].icfComplete++;
    else byMonth[month].icfPending++;
    // Inspection complete = Passed
    if (d.inspectionStatus === 'Passed') byMonth[month].inspectionComplete++;
    // PTO complete = has a valid PTO date
    if (d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None') byMonth[month].ptoComplete++;
  });
  return Object.entries(byMonth).sort((a, b) => b[0].localeCompare(a[0])).map(([month, data]) => ({ month, ...data }));
}

function getActionItems() {
  const allDeals = [...DATA.matched, ...DATA.hubspotWithoutSgip];
  const notPermitted = allDeals.filter(d => d.permitStatus !== 'Approved');
  const meterCollar = allDeals.filter(d => d.inspectionStatus === 'Meter Collar Needed' || (d.inspectionStatus && d.inspectionStatus.toLowerCase().includes('meter collar')));
  const awaitingInspection = allDeals.filter(d => { const status = d.inspectionStatus; return status === 'Failed' || status === 'Scheduled' || status === 'Requested' || status === 'Pending HO Action' || !status || status === '(No value)'; });
  // Only show projects that have NOT been submitted for ICF (RRF stages or ICF Draft only)
  const isNotYetSubmittedForIcf = (progress) => { 
    const p = (progress || '').toLowerCase(); 
    // Include if no progress, or in RRF stages, or ICF Draft
    return !p || p.includes('rrf') || p === 'icf: draft' || p === 'icf draft';
  };
  const ptoButNoIcf = allDeals.filter(d => { const hasPto = d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None'; return hasPto && isNotYetSubmittedForIcf(d.sgipProgress); });
  const inspectionPassedNoPto = allDeals.filter(d => { const hasPto = d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None'; return d.inspectionStatus === 'Passed' && !hasPto; });
  return { notPermitted, meterCollar, awaitingInspection, ptoButNoIcf, inspectionPassedNoPto };
}

function getStats() {
  const m = getAllInstalled();
  const cutoffDate = new Date('2025-04-01');
  const isAfterCutoff = (dateStr) => { if (!dateStr) return false; let d; if (dateStr.includes('/')) { const parts = dateStr.split('/'); if (parts.length === 3) { let year = parseInt(parts[2]); if (year < 100) year += 2000; d = new Date(year, parseInt(parts[0]) - 1, parseInt(parts[1])); } } else d = new Date(dateStr); return d && !isNaN(d.getTime()) && d >= cutoffDate; };
  const postCutoffCodes = new Set(m.filter(d => isAfterCutoff(d.installDate)).map(d => d.applicationCode).filter(c => c));
  const icfSubmittedTotal = SGIP_DATA.filter(d => d.icfSubmittedDate && postCutoffCodes.has(d.applicationCode)).length;
  const icfApprovedTotal = SGIP_DATA.filter(d => d.icfPendingPaymentDate && postCutoffCodes.has(d.applicationCode)).length;
  const isPaid = (d) => (d.sgipProgress || '').toLowerCase().includes('payment') && (d.sgipProgress || '').toLowerCase().includes('completed');
  return { total: m.length, paid: m.filter(d => isPaid(d)).length, suspended: m.filter(d => (d.sgipProgress || '').includes('Suspended')).length, totalIncentive: m.reduce((s, d) => s + parseNum(d.currentIncentive), 0), paidIncentive: m.filter(d => isPaid(d)).reduce((s, d) => s + parseNum(d.finalIncentive), 0), ptoComplete: m.filter(d => d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None').length, permitted: m.filter(d => d.permitStatus === 'Approved').length, icfSubmitted: icfSubmittedTotal, icfApproved: icfApprovedTotal };
}

const getPermitStyle = s => { if (!s) return 'bg-slate-800 text-slate-500 border-slate-700'; if (s === 'Approved') return 'bg-green-900/50 text-green-400 border-green-800'; if (s === 'Rejected') return 'bg-red-900/50 text-red-400 border-red-800'; if (s === 'Submitted' || s === 'Resubmitted') return 'bg-blue-900/50 text-blue-400 border-blue-800'; return 'bg-amber-900/50 text-amber-400 border-amber-800'; };
const getInspectionStyle = s => { if (!s || s === '(No value)') return 'bg-slate-800 text-slate-500 border-slate-700'; if (s === 'Passed') return 'bg-green-900/50 text-green-400 border-green-800'; if (s === 'Failed' || (s && s.includes('Needed')) || s === 'Pending HO Action') return 'bg-red-900/50 text-red-400 border-red-800'; if (s === 'Scheduled' || s === 'Requested') return 'bg-blue-900/50 text-blue-400 border-blue-800'; return 'bg-amber-900/50 text-amber-400 border-amber-800'; };
const getPTOStyle = d => (!d || d === '(No value)' || d === 'None') ? 'bg-slate-800 text-slate-500 border-slate-700' : 'bg-green-900/50 text-green-400 border-green-800';
const getDaysColor = d => d === null ? 'text-slate-600' : d > 90 ? 'text-red-400' : d > 60 ? 'text-amber-400' : d > 30 ? 'text-yellow-400' : 'text-slate-300';

function setTab(t) { state.tab = t; state.search = ''; render(); }
function setStatsSubTab(t) { state.statsSubTab = t; render(); }
function setIcfSubTab(t) { state.icfSubTab = t; state.icfSortBy = null; state.icfSortDir = 'desc'; render(); }
function setIcfSort(col) { if (state.icfSortBy === col) state.icfSortDir = state.icfSortDir === 'asc' ? 'desc' : 'asc'; else { state.icfSortBy = col; state.icfSortDir = 'desc'; } render(); }
function updateSearch(v) { state.search = v; if (searchTimeout) clearTimeout(searchTimeout); searchTimeout = setTimeout(() => render(), 150); }
function setSort(col) { if (state.sortBy === col) state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc'; else { state.sortBy = col; state.sortDir = 'desc'; } closeAllDropdowns(); render(); }

let openDropdownId = null;
function toggleDropdown(id, event) { event.stopPropagation(); const menu = document.getElementById(id); if (!menu) return; if (menu.classList.contains('open')) { menu.classList.remove('open'); openDropdownId = null; } else { closeAllDropdowns(); menu.classList.add('open'); openDropdownId = id; } }
function closeAllDropdowns() { document.querySelectorAll('.dropdown-menu.open').forEach(m => m.classList.remove('open')); openDropdownId = null; }
document.addEventListener('click', function(e) { if (!e.target.closest('.dropdown')) closeAllDropdowns(); });

function toggleFilterKeepOpen(key, val) { const idx = state.filters[key].indexOf(val); if (idx >= 0) state.filters[key].splice(idx, 1); else state.filters[key].push(val); renderKeepDropdown(); }
function selectAllFilterKeepOpen(key, options) { state.filters[key] = options.map(o => o[0]); renderKeepDropdown(); }
function clearFilterKeyKeepOpen(key) { state.filters[key] = []; renderKeepDropdown(); }
function renderKeepDropdown() { const currentOpenId = openDropdownId; render(); if (currentOpenId) { const menu = document.getElementById(currentOpenId); if (menu) menu.classList.add('open'); } }
function toggleFilter(key, val) { const idx = state.filters[key].indexOf(val); if (idx >= 0) state.filters[key].splice(idx, 1); else state.filters[key].push(val); render(); }
function selectAllFilter(key, options) { state.filters[key] = options.map(o => o[0]); render(); }
function clearFilterKey(key) { state.filters[key] = []; render(); }
function clearFilters() { Object.keys(state.filters).forEach(k => state.filters[k] = []); state.search = ''; render(); }
function hasActiveFilters() { return state.search || Object.values(state.filters).some(v => v.length > 0); }

const PERMIT_OPTIONS = ['Approved', 'Rejected', 'Submitted', 'Resubmitted', 'Revisions in progress'];
const INSPECTION_OPTIONS = ['Passed', 'Failed', 'Scheduled', 'Requested', 'Pending HO Action', 'Meter Collar Needed'];

function openEditModal(idx, field) {
  const deal = getFilteredData()[idx];
  state.editingDeal = idx; state.editingField = field;
  document.getElementById('editModalTitle').textContent = `Edit ${field === 'inspectionStatus' ? 'Inspection' : field === 'permitStatus' ? 'Permit' : 'PTO'}`;
  let html = '';
  if (field === 'inspectionStatus') html = `<select id="editValue" class="w-full px-4 py-2 rounded-lg bg-slate-900 border border-slate-700">${INSPECTION_OPTIONS.map(o => `<option ${deal.inspectionStatus === o ? 'selected' : ''}>${o}</option>`).join('')}</select>`;
  else if (field === 'permitStatus') html = `<select id="editValue" class="w-full px-4 py-2 rounded-lg bg-slate-900 border border-slate-700">${PERMIT_OPTIONS.map(o => `<option ${deal.permitStatus === o ? 'selected' : ''}>${o}</option>`).join('')}</select>`;
  else if (field === 'ptoDate') html = `<input type="date" id="editValue" class="w-full px-4 py-2 rounded-lg bg-slate-900 border border-slate-700" value="${deal.ptoDate || ''}">`;
  html += `<p class="text-xs text-slate-500 mt-2">${deal.customerName || deal.dealName}</p>`;
  document.getElementById('editModalContent').innerHTML = html;
  document.getElementById('editModal').classList.remove('hidden');
}
function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }
function saveEdit() {
  const val = document.getElementById('editValue').value;
  const deal = getFilteredData()[state.editingDeal];
  // Try to find in matched first, then in hubspotWithoutSgip
  let idx = DATA.matched.findIndex(d => d.dealId === deal.dealId);
  if (idx >= 0) { DATA.matched[idx][state.editingField] = val; }
  else {
    idx = DATA.hubspotWithoutSgip.findIndex(d => d.dealId === deal.dealId);
    if (idx >= 0) DATA.hubspotWithoutSgip[idx][state.editingField] = val;
  }
  buildSearchIndex(); closeEditModal(); render();
}

function filterHeader(label, filterKey, sortKey, options, editable = false) {
  const cnt = state.filters[filterKey].length;
  const isFiltered = cnt > 0;
  const isSorted = state.sortBy === sortKey;
  const dropdownId = `dropdown-${filterKey}`;
  return `<th class="px-2 py-3 text-left text-xs font-semibold uppercase"><div class="dropdown"><span class="cursor-pointer hover:text-slate-200 ${isFiltered ? 'filter-active' : 'text-slate-400'}" onclick="toggleDropdown('${dropdownId}', event)">${label}${isSorted ? (state.sortDir === 'asc' ? ' ‚Üë' : ' ‚Üì') : ''}${isFiltered ? ` (${cnt})` : ''}${editable ? ' ‚úé' : ''}<svg class="w-3 h-3 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></span><div id="${dropdownId}" class="dropdown-menu" onclick="event.stopPropagation()">${sortKey ? `<div class="p-2 border-b border-slate-700"><div class="text-[10px] text-slate-500 uppercase mb-1">Sort</div><div class="dropdown-item rounded px-2 py-1 cursor-pointer hover:bg-slate-700 ${isSorted && state.sortDir === 'desc' ? 'bg-slate-700' : ''}" onclick="setSort('${sortKey}')">Highest First</div><div class="dropdown-item rounded px-2 py-1 cursor-pointer hover:bg-slate-700 ${isSorted && state.sortDir === 'asc' ? 'bg-slate-700' : ''}" onclick="state.sortBy='${sortKey}';state.sortDir='asc';closeAllDropdowns();render();">Lowest First</div></div>` : ''}<div class="p-2"><div class="flex justify-between items-center mb-2"><div class="text-[10px] text-slate-500 uppercase">Filter</div><div class="flex gap-1"><button onclick="selectAllFilterKeepOpen('${filterKey}',${JSON.stringify(options).replace(/"/g,'&quot;')})" class="text-[10px] px-2 py-0.5 bg-slate-700 hover:bg-slate-600 rounded">All</button><button onclick="clearFilterKeyKeepOpen('${filterKey}')" class="text-[10px] px-2 py-0.5 bg-slate-700 hover:bg-slate-600 rounded">None</button></div></div>${options.map(([v,c]) => `<label class="checkbox-item rounded" onclick="event.stopPropagation()"><input type="checkbox" ${state.filters[filterKey].includes(v) ? 'checked' : ''} onchange="toggleFilterKeepOpen('${filterKey}','${v.replace(/'/g,"\\'")}')"><span class="flex-1">${v.length > 25 ? v.slice(0,23)+'..' : v}</span><span class="text-slate-500">(${c})</span></label>`).join('')}</div></div></div></th>`;
}

function installMonthFilterHeader() {
  const options = getInstallMonthCounts();
  const cnt = state.filters.installMonth.length;
  const isFiltered = cnt > 0;
  const isSorted = state.sortBy === 'installDate';
  const dropdownId = 'dropdown-installMonth';
  return `<th class="px-2 py-3 text-left text-xs font-semibold uppercase"><div class="dropdown"><span class="cursor-pointer hover:text-slate-200 ${isFiltered ? 'filter-active' : 'text-slate-400'}" onclick="toggleDropdown('${dropdownId}', event)">Install${isSorted ? (state.sortDir === 'asc' ? ' ‚Üë' : ' ‚Üì') : ''}${isFiltered ? ` (${cnt})` : ''}<svg class="w-3 h-3 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></span><div id="${dropdownId}" class="dropdown-menu" onclick="event.stopPropagation()"><div class="p-2 border-b border-slate-700"><div class="text-[10px] text-slate-500 uppercase mb-1">Sort</div><div class="dropdown-item rounded px-2 py-1 cursor-pointer hover:bg-slate-700 ${isSorted && state.sortDir === 'desc' ? 'bg-slate-700' : ''}" onclick="setSort('installDate')">Newest First</div><div class="dropdown-item rounded px-2 py-1 cursor-pointer hover:bg-slate-700 ${isSorted && state.sortDir === 'asc' ? 'bg-slate-700' : ''}" onclick="state.sortBy='installDate';state.sortDir='asc';closeAllDropdowns();render();">Oldest First</div></div><div class="p-2"><div class="flex justify-between items-center mb-2"><div class="text-[10px] text-slate-500 uppercase">Filter by Month</div><div class="flex gap-1"><button onclick="selectAllFilterKeepOpen('installMonth',${JSON.stringify(options).replace(/"/g,'&quot;')})" class="text-[10px] px-2 py-0.5 bg-slate-700 hover:bg-slate-600 rounded">All</button><button onclick="clearFilterKeyKeepOpen('installMonth')" class="text-[10px] px-2 py-0.5 bg-slate-700 hover:bg-slate-600 rounded">None</button></div></div>${options.map(([v,c]) => `<label class="checkbox-item rounded" onclick="event.stopPropagation()"><input type="checkbox" ${state.filters.installMonth.includes(v) ? 'checked' : ''} onchange="toggleFilterKeepOpen('installMonth','${v.replace(/'/g,"\\'")}')"><span class="flex-1">${v === '(No date)' ? v : formatMonthLabel(v)}</span><span class="text-slate-500">(${c})</span></label>`).join('')}</div></div></div></th>`;
}

function getUtility(d) {
  // First check if utility is in the data from SGIP export (SGIP Administrator column)
  let utility = (d.utility || '').trim();
  if (utility) {
    // Normalize long names to short codes
    if (utility.includes('Pacific Gas') || utility === 'PG&E') return 'PG&E';
    if (utility.includes('Southern California Edison') || utility === 'SCE') return 'SCE';
    if (utility.includes('San Diego Gas') || utility === 'SDG&E' || utility === 'SDGE') return 'SDG&E';
    if (utility.includes('SoCalGas') || utility.includes('Southern California Gas') || utility === 'SCG') return 'SoCalGas';
    if (utility.toLowerCase().includes('sacramento') || utility === 'SMUD') return 'SMUD';
    if (utility.includes('LA Dept') || utility.includes('Los Angeles Department') || utility === 'LADWP') return 'LADWP';
    if (utility.includes('Peninsula Clean Energy') || utility === 'PCE') return 'PCE';
    if (utility.includes('Clean Energy Alliance') || utility === 'CEA') return 'CEA';
    if (utility.includes('Silicon Valley Clean Energy') || utility === 'SVCE') return 'SVCE';
    if (utility.includes('East Bay Community Energy') || utility === 'EBCE') return 'EBCE';
    if (utility.includes('Marin Clean Energy') || utility === 'MCE') return 'MCE';
    if (utility.includes('San Jose Clean Energy') || utility === 'SJCE') return 'SJCE';
    if (utility.includes('CleanPowerSF') || utility === 'CPSF') return 'CleanPowerSF';
    if (utility.includes('Central Coast Community Energy') || utility === '3CE') return '3CE';
    if (utility.includes('Sonoma Clean Power') || utility === 'SCP') return 'SCP';
    return utility; // Return as-is if no match
  }
  // Otherwise derive from application code prefix
  const code = d.applicationCode || '';
  if (code.startsWith('PGE-SGIP')) return 'PG&E';
  if (code.startsWith('SCE-SGIP')) return 'SCE';
  if (code.startsWith('SD-SGIP') || code.startsWith('SDGE-SGIP')) return 'SDG&E';
  if (code.startsWith('SCG-SGIP')) return 'SCG';
  if (code.startsWith('SMUD-SGIP')) return 'SMUD';
  return '';
}

function getUtilityStyle(utility) {
  const styles = {
    'PG&E': 'bg-blue-900/50 text-blue-400 border-blue-800',
    'SCE': 'bg-amber-900/50 text-amber-400 border-amber-800',
    'SDG&E': 'bg-purple-900/50 text-purple-400 border-purple-800',
    'SoCalGas': 'bg-emerald-900/50 text-emerald-400 border-emerald-800',
    'SMUD': 'bg-cyan-900/50 text-cyan-400 border-cyan-800',
    'LADWP': 'bg-orange-900/50 text-orange-400 border-orange-800',
    'PCE': 'bg-teal-900/50 text-teal-400 border-teal-800',
    'CEA': 'bg-pink-900/50 text-pink-400 border-pink-800',
    'SVCE': 'bg-lime-900/50 text-lime-400 border-lime-800',
    'EBCE': 'bg-indigo-900/50 text-indigo-400 border-indigo-800',
    'MCE': 'bg-rose-900/50 text-rose-400 border-rose-800',
    'SJCE': 'bg-sky-900/50 text-sky-400 border-sky-800',
    'CleanPowerSF': 'bg-fuchsia-900/50 text-fuchsia-400 border-fuchsia-800',
    '3CE': 'bg-violet-900/50 text-violet-400 border-violet-800',
    'SCP': 'bg-yellow-900/50 text-yellow-400 border-yellow-800'
  };
  return styles[utility] || 'bg-slate-800 text-slate-400 border-slate-700';
}

function customerCell(d) {
  const url = getHubSpotUrl(d.dealId);
  const name = d.customerName || d.dealName || '‚Äî';
  let badge = '';
  if (d.matchType === 'address') badge = '<span class="ml-1 text-[9px] px-1 py-0.5 bg-cyan-900/50 text-cyan-400 rounded">addr</span>';
  else if (d.matchType === 'manual') badge = '<span class="ml-1 text-[9px] px-1 py-0.5 bg-purple-900/50 text-purple-400 rounded">manual</span>';
  return url ? `<a href="${url}" target="_blank" class="font-medium text-cyan-400 hover:text-cyan-300 hover:underline">${name}</a>${badge}` : `<span class="font-medium">${name}</span>${badge}`;
}

function render() {
  const stats = getStats();
  const allInstalled = getAllInstalled();
  const filtered = state.tab === 'installed' ? getFilteredData() : [];
  const stageCounts = {}; allInstalled.forEach(d => stageCounts[d.sgipProgress || '(empty)'] = (stageCounts[d.sgipProgress || '(empty)'] || 0) + 1);
  const activeStages = STAGES.filter(s => stageCounts[s.key] > 0 && s.stage >= 0);
  const permitOpts = getFilterCounts('permitStatus');
  const inspectOpts = getFilterCounts('inspectionStatus', v => (!v || v === '(No value)') ? '(empty)' : v);
  const ptoOpts = [['Complete', allInstalled.filter(d => d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None').length], ['Pending', allInstalled.filter(d => !d.ptoDate || d.ptoDate === '(No value)' || d.ptoDate === 'None').length]];
  const sgipStageOpts = getFilterCounts('sgipStage', v => v || '(empty)');
  const sgipStatusOpts = getFilterCounts('sgipStatus', v => v || '(empty)');
  const icfOpts = getFilterCounts('sgipProgress', v => v || '(empty)');
  const installerOpts = getFilterCounts('installer', v => (!v || v === '(No value)') ? '(empty)' : v);
  // Build utility options using getUtility function
  const utilityCounts = {};
  allInstalled.forEach(d => { const u = getUtility(d) || '(empty)'; utilityCounts[u] = (utilityCounts[u] || 0) + 1; });
  const utilityOpts = Object.entries(utilityCounts).sort((a, b) => b[1] - a[1]);

  document.getElementById('app').innerHTML = `
    <div class="bg-slate-800/80 border-b border-slate-700/50 sticky top-0 z-30">
      <div class="max-w-[1920px] mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-emerald-500 to-cyan-500 flex items-center justify-center"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div>
          <div><h1 class="text-lg font-bold bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">Haven Energy</h1><p class="text-xs text-slate-400">Post-Install Portal</p></div>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="triggerSync()" class="sync-btn ${state.syncing ? 'syncing' : ''} px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-500 rounded-lg font-medium" ${state.syncing ? 'disabled' : ''}>${state.syncing ? '‚ü≥ Syncing...' : '‚ü≥ Sync HubSpot'}</button>
          <button onclick="showUploadModal()" class="px-3 py-1.5 text-xs bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">üì§ Update SGIP</button>
          <span class="text-xs text-slate-500">${state.lastSync ? 'HubSpot: '+state.lastSync : ''} ${state.sgipLastUpdated ? '‚Ä¢ SGIP: '+state.sgipLastUpdated : ''}</span>
        </div>
      </div>
    </div>
    <div class="max-w-[1920px] mx-auto px-4 py-4">
      <div class="flex gap-2 mb-4 flex-wrap">
        <button onclick="setTab('installed')" class="px-4 py-2 rounded-lg text-sm font-medium ${state.tab === 'installed' ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/40' : 'bg-slate-800/50 text-slate-400 border border-slate-700/50'}">Installed (${allInstalled.length})</button>
        <button onclick="setTab('stats')" class="px-4 py-2 rounded-lg text-sm font-medium ${state.tab === 'stats' ? 'bg-blue-500/20 text-blue-400 border border-blue-500/40' : 'bg-slate-800/50 text-slate-400 border border-slate-700/50'}">üìä Stats & Reports</button>
        <button onclick="setTab('ptoFunnel')" class="px-4 py-2 rounded-lg text-sm font-medium ${state.tab === 'ptoFunnel' ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/40' : 'bg-slate-800/50 text-slate-400 border border-slate-700/50'}">üéØ PTO Funnel</button>
        <button onclick="setTab('icfDeepDive')" class="px-4 py-2 rounded-lg text-sm font-medium ${state.tab === 'icfDeepDive' ? 'bg-purple-500/20 text-purple-400 border border-purple-500/40' : 'bg-slate-800/50 text-slate-400 border border-slate-700/50'}">üîç ICF Deep Dive</button>
      </div>
      ${state.tab === 'installed' ? renderInstalledTab(stats, filtered, activeStages, stageCounts, permitOpts, inspectOpts, ptoOpts, sgipStageOpts, sgipStatusOpts, icfOpts, installerOpts, utilityOpts) : state.tab === 'ptoFunnel' ? renderPtoFunnelTab() : state.tab === 'icfDeepDive' ? renderIcfDeepDiveTab() : renderStatsTab()}
    </div>
  `;
}

function renderInstalledTab(stats, filtered, activeStages, stageCounts, permitOpts, inspectOpts, ptoOpts, sgipStageOpts, sgipStatusOpts, icfOpts, installerOpts, utilityOpts) {
  return `
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2 mb-4">
      <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Total</p><p class="text-lg font-bold">${stats.total}</p></div>
      <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Permitted</p><p class="text-lg font-bold">${stats.permitted}</p></div>
      <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">PTO Done</p><p class="text-lg font-bold">${stats.ptoComplete}</p></div>
      <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">ICF Submitted</p><p class="text-lg font-bold text-blue-400">${stats.icfSubmitted}</p></div>
      <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">ICF Approved</p><p class="text-lg font-bold text-purple-400">${stats.icfApproved}</p></div>
      <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Pipeline</p><p class="text-lg font-bold">${fmtCurrency(stats.totalIncentive)}</p></div>
      <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Paid</p><p class="text-lg font-bold text-emerald-400">${fmtCurrency(stats.paidIncentive)}</p></div>
      <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Suspended</p><p class="text-lg font-bold text-red-400">${stats.suspended}</p></div>
    </div>
    ${activeStages.length > 0 ? '<div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50 mb-4"><div class="flex rounded overflow-hidden h-6 bg-slate-900">'+activeStages.map(s => { const cnt = stageCounts[s.key] || 0, pct = (cnt / stats.total) * 100; return pct < 0.5 ? '' : '<div style="width:'+pct+'%;background:'+s.color+';min-width:18px" class="flex items-center justify-center text-white text-xs font-bold">'+cnt+'</div>'; }).join('')+'</div><div class="flex flex-wrap gap-2 mt-2">'+activeStages.map(s => '<span class="flex items-center gap-1 text-xs"><span class="w-2 h-2 rounded-full" style="background:'+s.color+'"></span><span class="text-slate-500">'+s.label+'</span></span>').join('')+'</div></div>' : ''}
    <div class="flex flex-wrap gap-3 mb-4 items-center">
      <input type="text" placeholder="Search customer, code, email, installer..." class="flex-1 min-w-[250px] max-w-md px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm" value="${state.search}" oninput="updateSearch(this.value)">
      ${hasActiveFilters() ? '<button onclick="clearFilters()" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm font-medium">‚úï Clear Filters</button>' : ''}
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
      <div class="px-3 py-2 border-b border-slate-700/50 text-sm"><span class="font-semibold">${filtered.length}</span> deals ${hasActiveFilters() ? '<span class="text-emerald-400">(filtered)</span>' : ''}</div>
      <div class="table-container overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="sticky-header"><tr>
            <th class="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer" onclick="setSort('name')">Customer ${state.sortBy === 'name' ? (state.sortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>
            ${filterHeader('Utility', 'utility', null, utilityOpts)}
            ${installMonthFilterHeader()}
            <th class="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer" onclick="setSort('daysSinceInstall')">Days ${state.sortBy === 'daysSinceInstall' ? (state.sortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>
            ${filterHeader('Permit', 'permitStatus', null, permitOpts, true)}
            ${filterHeader('Inspection', 'inspectionStatus', null, inspectOpts, true)}
            ${filterHeader('PTO', 'ptoStatus', null, ptoOpts, true)}
            ${filterHeader('SGIP Stage', 'sgipStage', null, sgipStageOpts)}
            ${filterHeader('SGIP Status', 'sgipStatus', null, sgipStatusOpts)}
            ${filterHeader('SGIP Progress', 'sgipProgress', 'stage', icfOpts)}
            <th class="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer" onclick="setSort('nextDue')">Next Due ${state.sortBy === 'nextDue' ? (state.sortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>
            <th class="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer" onclick="setSort('incentive')">Incentive ${state.sortBy === 'incentive' ? (state.sortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>
            ${filterHeader('Installer', 'installer', null, installerOpts)}
          </tr></thead>
          <tbody class="divide-y divide-slate-700/30">${filtered.length === 0 ? '<tr><td colspan="13" class="p-8 text-center text-slate-500">No deals found.</td></tr>' : filtered.map((d, i) => {
            const info = getStageInfo(d.sgipProgress);
            const utility = getUtility(d);
            return '<tr class="hover:bg-slate-800/50"><td class="px-2 py-2"><div class="min-w-[150px]">'+customerCell(d)+(d.applicationCode?'<br><span class="text-xs text-slate-500 mono">'+d.applicationCode+'</span>':'')+'</div></td><td class="px-2 py-2"><span class="px-1.5 py-0.5 rounded text-xs border '+getUtilityStyle(utility)+'">'+(utility||'‚Äî')+'</span></td><td class="px-2 py-2 text-xs mono">'+(d.installDate||'‚Äî')+'</td><td class="px-2 py-2"><span class="font-semibold '+getDaysColor(d.daysSinceInstall)+'">'+(d.daysSinceInstall!==null?d.daysSinceInstall+'d':'‚Äî')+'</span></td><td class="px-2 py-2"><span class="editable px-1.5 py-0.5 rounded text-xs border '+getPermitStyle(d.permitStatus)+'" onclick="openEditModal('+i+',\'permitStatus\')">'+(d.permitStatus||'‚Äî')+'</span></td><td class="px-2 py-2"><span class="editable px-1.5 py-0.5 rounded text-xs border '+getInspectionStyle(d.inspectionStatus)+'" onclick="openEditModal('+i+',\'inspectionStatus\')">'+(d.inspectionStatus&&d.inspectionStatus!=='(No value)'?d.inspectionStatus:'‚Äî')+'</span></td><td class="px-2 py-2"><span class="editable px-1.5 py-0.5 rounded text-xs border '+getPTOStyle(d.ptoDate)+'" onclick="openEditModal('+i+',\'ptoDate\')">'+(d.ptoDate&&d.ptoDate!=='(No value)'&&d.ptoDate!=='None'?d.ptoDate:'Pending')+'</span></td><td class="px-2 py-2 text-xs">'+(d.sgipStage||'‚Äî')+'</td><td class="px-2 py-2 text-xs text-slate-400">'+(d.sgipStatus||'‚Äî')+'</td><td class="px-2 py-2"><span class="px-1.5 py-0.5 rounded text-xs font-medium" style="background:'+info.color+'20;color:'+info.color+'">'+info.label+'</span></td><td class="px-2 py-2 text-xs mono">'+(d.nextDueDate||'‚Äî')+'</td><td class="px-2 py-2 text-right"><span class="'+((d.sgipProgress||'').toLowerCase().includes('payment')&&(d.sgipProgress||'').toLowerCase().includes('completed')?'text-emerald-400':'text-slate-300')+'">'+(d.currentIncentive||'‚Äî')+'</span></td><td class="px-2 py-2 text-xs text-slate-400">'+(d.installer||'‚Äî')+'</td></tr>';
          }).join('')}</tbody>
        </table>
      </div>
    </div>
  `;
}

function renderNoSgipTab() {
  return `
    <div class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 mb-4"><h3 class="font-semibold text-amber-400">Not in SGIP Portal</h3><p class="text-sm text-slate-400 mt-1">${DATA.hubspotWithoutSgip.length} deals that couldn't be matched.</p></div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
      <div class="table-container overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="sticky-header"><tr><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Customer</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Email</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Install</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Permit</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Inspection</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Installer</th></tr></thead>
          <tbody class="divide-y divide-slate-700/30">${DATA.hubspotWithoutSgip.map(d => `<tr class="hover:bg-slate-800/50"><td class="px-3 py-2">${customerCell(d)}</td><td class="px-3 py-2 text-xs mono text-slate-400">${d.email||'‚Äî'}</td><td class="px-3 py-2 mono text-xs">${d.installDate||'‚Äî'}</td><td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getPermitStyle(d.permitStatus)}">${d.permitStatus||'‚Äî'}</span></td><td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getInspectionStyle(d.inspectionStatus)}">${d.inspectionStatus||'‚Äî'}</span></td><td class="px-3 py-2 text-xs text-slate-400">${d.installer||'‚Äî'}</td></tr>`).join('')}</tbody>
        </table>
      </div>
    </div>
  `;
}

function renderStatsTab() {
  return `
    <div class="flex gap-2 mb-4 flex-wrap">
      <button onclick="setStatsSubTab('activity')" class="subtab px-3 py-1.5 rounded-lg text-sm font-medium border ${state.statsSubTab === 'activity' ? 'active border-blue-500/40 text-blue-400' : 'border-slate-700/50 text-slate-400'}">üìä Activity</button>
      <button onclick="setStatsSubTab('status')" class="subtab px-3 py-1.5 rounded-lg text-sm font-medium border ${state.statsSubTab === 'status' ? 'active border-purple-500/40 text-purple-400' : 'border-slate-700/50 text-slate-400'}">üìã Status Counts</button>
      <button onclick="setStatsSubTab('monthly')" class="subtab px-3 py-1.5 rounded-lg text-sm font-medium border ${state.statsSubTab === 'monthly' ? 'active border-cyan-500/40 text-cyan-400' : 'border-slate-700/50 text-slate-400'}">üìÖ Installs by Month</button>
      <button onclick="setStatsSubTab('budget')" class="subtab px-3 py-1.5 rounded-lg text-sm font-medium border ${state.statsSubTab === 'budget' ? 'active border-emerald-500/40 text-emerald-400' : 'border-slate-700/50 text-slate-400'}">üí∞ Budget Category</button>
      <button onclick="setStatsSubTab('action')" class="subtab px-3 py-1.5 rounded-lg text-sm font-medium border ${state.statsSubTab === 'action' ? 'active border-amber-500/40 text-amber-400' : 'border-slate-700/50 text-slate-400'}">‚ö° Action Items</button>
    </div>
    ${state.statsSubTab === 'activity' ? renderActivityStats() : 
      state.statsSubTab === 'status' ? renderStatusCounts() : 
      state.statsSubTab === 'monthly' ? renderMonthlyStats() : 
      state.statsSubTab === 'budget' ? renderBudgetCategoryStats() :
      renderActionItems()}
  `;
}

function renderActivityStats() {
  const ps = getPeriodicStats();
  return `
    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-blue-400">üìä Activity Summary</h3>
      <p class="text-sm text-slate-400 mt-1">Current week starting ${ps.weekStart} ‚Ä¢ Current month starting ${ps.monthStart}</p>
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-slate-700">
            <th class="px-4 py-4 text-left text-sm font-semibold text-slate-300">Metric</th>
            <th class="px-3 py-4 text-center text-sm font-semibold text-slate-300">Yesterday</th>
            <th class="px-3 py-4 text-center text-sm font-semibold text-slate-300">Week to Date</th>
            <th class="px-3 py-4 text-center text-sm font-semibold text-slate-300">Month to Date</th>
            <th class="px-3 py-4 text-center text-sm font-semibold text-slate-400 border-l border-slate-700">Last Week<br><span class="text-[10px] font-normal">${ps.lastWeekStart} - ${ps.lastWeekEnd}</span></th>
            <th class="px-3 py-4 text-center text-sm font-semibold text-slate-400">Last Month<br><span class="text-[10px] font-normal">${ps.lastMonthStart}</span></th>
            <th class="px-3 py-4 text-center text-sm font-semibold text-emerald-400 border-l border-slate-700">Lifetime<br><span class="text-[10px] font-normal">Since 4/1/2025</span></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-700/30">
          <tr class="hover:bg-slate-800/50">
            <td class="px-4 py-4 font-medium text-emerald-400">Installs Completed</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.installs.yesterday}</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.installs.wtd}</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.installs.mtd}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-slate-400 border-l border-slate-700">${ps.installs.lastWeek}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-slate-400">${ps.installs.lastMonth}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-emerald-400 border-l border-slate-700">${ps.installs.lifetime}</td>
          </tr>
          <tr class="hover:bg-slate-800/50">
            <td class="px-4 py-4 font-medium text-cyan-400">PTOs Completed</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.ptos.yesterday}</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.ptos.wtd}</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.ptos.mtd}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-slate-400 border-l border-slate-700">${ps.ptos.lastWeek}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-slate-400">${ps.ptos.lastMonth}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-emerald-400 border-l border-slate-700">${ps.ptos.lifetime}</td>
          </tr>
          <tr class="hover:bg-slate-800/50">
            <td class="px-4 py-4 font-medium text-blue-400">ICFs Submitted</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.icfSubmitted.yesterday}</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.icfSubmitted.wtd}</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.icfSubmitted.mtd}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-slate-400 border-l border-slate-700">${ps.icfSubmitted.lastWeek}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-slate-400">${ps.icfSubmitted.lastMonth}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-emerald-400 border-l border-slate-700">${ps.icfSubmitted.lifetime}</td>
          </tr>
          <tr class="hover:bg-slate-800/50">
            <td class="px-4 py-4 font-medium text-amber-400">ICFs Resubmitted</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.icfResubmitted.yesterday}</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.icfResubmitted.wtd}</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.icfResubmitted.mtd}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-slate-400 border-l border-slate-700">${ps.icfResubmitted.lastWeek}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-slate-400">${ps.icfResubmitted.lastMonth}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-emerald-400 border-l border-slate-700">${ps.icfResubmitted.lifetime}</td>
          </tr>
          <tr class="hover:bg-slate-800/50">
            <td class="px-4 py-4 font-medium text-purple-400">ICFs Approved</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.icfApproved.yesterday}</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.icfApproved.wtd}</td>
            <td class="px-3 py-4 text-center text-2xl font-bold">${ps.icfApproved.mtd}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-slate-400 border-l border-slate-700">${ps.icfApproved.lastWeek}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-slate-400">${ps.icfApproved.lastMonth}</td>
            <td class="px-3 py-4 text-center text-xl font-bold text-emerald-400 border-l border-slate-700">${ps.icfApproved.lifetime}</td>
          </tr>
          <tr class="hover:bg-slate-800/50 bg-slate-800/30">
            <td class="px-4 py-4 font-medium text-green-400">üí∞ Payment Amount</td>
            <td class="px-3 py-4 text-center text-lg font-bold text-green-400">${fmtCurrency(ps.paymentAmount.yesterday)}</td>
            <td class="px-3 py-4 text-center text-lg font-bold text-green-400">${fmtCurrency(ps.paymentAmount.wtd)}</td>
            <td class="px-3 py-4 text-center text-lg font-bold text-green-400">${fmtCurrency(ps.paymentAmount.mtd)}</td>
            <td class="px-3 py-4 text-center text-base font-bold text-slate-400 border-l border-slate-700">${fmtCurrency(ps.paymentAmount.lastWeek)}</td>
            <td class="px-3 py-4 text-center text-base font-bold text-slate-400">${fmtCurrency(ps.paymentAmount.lastMonth)}</td>
            <td class="px-3 py-4 text-center text-base font-bold text-emerald-400 border-l border-slate-700">${fmtCurrency(ps.paymentAmount.lifetime)}<br><span class="text-[10px] text-slate-500">All: ${fmtCurrency(ps.paymentAmount.allTime)}</span></td>
          </tr>
        </tbody>
      </table>
    </div>
    <p class="text-xs text-slate-500 mt-4">Data sources: Installs & PTOs from HubSpot ‚Ä¢ ICF dates & Payment amounts from SGIP export</p>
  `;
}

function renderStatusCounts() {
  const sc = getStatusCounts();
  return `
    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-purple-400">üìã Status Breakdown</h3>
      <p class="text-sm text-slate-400 mt-1">Count of all ${sc.total} projects by workflow status</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 p-4">
        <h4 class="font-semibold text-slate-300 mb-4 flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span>Permit Status</h4>
        <div class="space-y-3">
          <div class="flex justify-between items-center"><span class="text-slate-400">Approved</span><span class="text-2xl font-bold text-green-400">${sc.permit.approved}</span></div>
          <div class="flex justify-between items-center"><span class="text-slate-400">Not Approved</span><span class="text-2xl font-bold text-amber-400">${sc.permit.notApproved}</span></div>
          <div class="h-2 bg-slate-900 rounded-full overflow-hidden"><div class="h-full bg-green-500" style="width: ${(sc.permit.approved / sc.total * 100)}%"></div></div>
        </div>
      </div>
      <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 p-4">
        <h4 class="font-semibold text-slate-300 mb-4 flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-500"></span>Inspection Status</h4>
        <div class="space-y-3">
          <div class="flex justify-between items-center"><span class="text-slate-400">Complete (Passed)</span><span class="text-xl font-bold text-green-400">${sc.inspection.complete}</span></div>
          <div class="flex justify-between items-center"><span class="text-slate-400">Scheduled/Requested</span><span class="text-xl font-bold text-blue-400">${sc.inspection.scheduled}</span></div>
          <div class="flex justify-between items-center"><span class="text-slate-400">Meter Collar Needed</span><span class="text-xl font-bold text-red-400">${sc.inspection.meterCollar}</span></div>
          <div class="flex justify-between items-center"><span class="text-slate-400">Not Complete</span><span class="text-xl font-bold text-slate-400">${sc.inspection.notComplete}</span></div>
          <div class="h-2 bg-slate-900 rounded-full overflow-hidden flex">
            <div class="h-full bg-green-500" style="width: ${(sc.inspection.complete / sc.total * 100)}%"></div>
            <div class="h-full bg-blue-500" style="width: ${(sc.inspection.scheduled / sc.total * 100)}%"></div>
            <div class="h-full bg-red-500" style="width: ${(sc.inspection.meterCollar / sc.total * 100)}%"></div>
          </div>
        </div>
      </div>
      <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 p-4">
        <h4 class="font-semibold text-slate-300 mb-4 flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-cyan-500"></span>PTO Status</h4>
        <div class="space-y-3">
          <div class="flex justify-between items-center"><span class="text-slate-400">Complete</span><span class="text-2xl font-bold text-green-400">${sc.pto.complete}</span></div>
          <div class="flex justify-between items-center"><span class="text-slate-400">Submitted</span><span class="text-2xl font-bold text-blue-400">${sc.pto.pendingSubmitted}</span></div>
          <div class="flex justify-between items-center"><span class="text-slate-400">Not Submitted</span><span class="text-2xl font-bold text-amber-400">${sc.pto.pendingNotSubmitted}</span></div>
          <div class="h-2 bg-slate-900 rounded-full overflow-hidden flex">
            <div class="h-full bg-green-500" style="width: ${(sc.pto.complete / sc.total * 100)}%"></div>
            <div class="h-full bg-blue-500" style="width: ${(sc.pto.pendingSubmitted / sc.total * 100)}%"></div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderMonthlyStats() {
  const monthlyData = getInstallsByMonth();
  return `
    <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-cyan-400">üìÖ Installs by Month</h3>
      <p class="text-sm text-slate-400 mt-1">Total installs per month with completion status for each milestone</p>
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-slate-700">
            <th class="px-4 py-3 text-left text-sm font-semibold text-slate-300">Month</th>
            <th class="px-4 py-3 text-center text-sm font-semibold text-slate-300">Total Installs</th>
            <th class="px-4 py-3 text-center text-sm font-semibold text-blue-400">Inspection Complete</th>
            <th class="px-4 py-3 text-center text-sm font-semibold text-cyan-400">PTO Complete</th>
            <th class="px-4 py-3 text-center text-sm font-semibold text-green-400">ICF Complete</th>
            <th class="px-4 py-3 text-center text-sm font-semibold text-amber-400">ICF Pending</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-slate-300">ICF Progress</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-700/30">
          ${monthlyData.map(m => `
            <tr class="hover:bg-slate-800/50">
              <td class="px-4 py-3 font-medium">${formatMonthLabel(m.month)}</td>
              <td class="px-4 py-3 text-center text-xl font-bold">${m.total}</td>
              <td class="px-4 py-3 text-center text-xl font-bold text-blue-400">${m.inspectionComplete}</td>
              <td class="px-4 py-3 text-center text-xl font-bold text-cyan-400">${m.ptoComplete}</td>
              <td class="px-4 py-3 text-center text-xl font-bold text-green-400">${m.icfComplete}</td>
              <td class="px-4 py-3 text-center text-xl font-bold text-amber-400">${m.icfPending}</td>
              <td class="px-4 py-3">
                <div class="flex items-center gap-2">
                  <div class="flex-1 h-3 bg-slate-900 rounded-full overflow-hidden flex">
                    <div class="h-full bg-green-500" style="width: ${m.total > 0 ? (m.icfComplete / m.total * 100) : 0}%"></div>
                  </div>
                  <span class="text-xs text-slate-400 w-12">${m.total > 0 ? Math.round(m.icfComplete / m.total * 100) : 0}%</span>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    <p class="text-xs text-slate-500 mt-4">Inspection Complete = Passed ‚Ä¢ PTO Complete = Has PTO date ‚Ä¢ ICF Complete = ICF: Pending Payment or Payment: Completed</p>
  `;
}

function getInstallsByBudgetCategory() {
  const allDeals = getAllInstalled();
  // Debug: log first few budget categories
  const withBudget = allDeals.filter(d => d.budgetCategory);
  console.log('Deals with budget category:', withBudget.length, 'of', allDeals.length);
  if (withBudget.length > 0) console.log('Sample budget categories:', withBudget.slice(0, 5).map(d => d.budgetCategory));
  
  const byMonth = {};
  allDeals.forEach(d => {
    const month = getInstallMonth(d.installDate);
    if (!month) return;
    if (!byMonth[month]) byMonth[month] = { total: 0, resStorage: 0, equityResiliency: 0, rsse: 0, other: 0 };
    byMonth[month].total++;
    const cat = (d.budgetCategory || '').toLowerCase();
    if (cat.includes('residential storage') && cat.includes('equity') && !cat.includes('solar')) {
      byMonth[month].resStorage++;
    } else if (cat.includes('equity resiliency') || cat.includes('equity resilience')) {
      byMonth[month].equityResiliency++;
    } else if (cat.includes('residential') && cat.includes('solar') && cat.includes('storage') && cat.includes('equity')) {
      byMonth[month].rsse++;
    } else if (d.budgetCategory) {
      byMonth[month].other++;
    }
  });
  return Object.entries(byMonth).sort((a, b) => b[0].localeCompare(a[0])).map(([month, data]) => ({ month, ...data }));
}

function renderBudgetCategoryStats() {
  const budgetData = getInstallsByBudgetCategory();
  // Calculate totals
  const totals = budgetData.reduce((acc, m) => ({
    total: acc.total + m.total,
    resStorage: acc.resStorage + m.resStorage,
    equityResiliency: acc.equityResiliency + m.equityResiliency,
    rsse: acc.rsse + m.rsse,
    other: acc.other + m.other
  }), { total: 0, resStorage: 0, equityResiliency: 0, rsse: 0, other: 0 });
  
  return `
    <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-emerald-400">üí∞ Installs by Budget Category</h3>
      <p class="text-sm text-slate-400 mt-1">Monthly breakdown by SGIP budget category</p>
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-slate-700">
            <th class="px-4 py-3 text-left text-sm font-semibold text-slate-300">Month</th>
            <th class="px-4 py-3 text-center text-sm font-semibold text-slate-300">Total Installs</th>
            <th class="px-4 py-3 text-center text-sm font-semibold text-blue-400">Res Storage Equity</th>
            <th class="px-4 py-3 text-center text-sm font-semibold text-purple-400">Equity Resiliency</th>
            <th class="px-4 py-3 text-center text-sm font-semibold text-emerald-400">RSSE</th>
            <th class="px-4 py-3 text-center text-sm font-semibold text-slate-400">Other/None</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-700/30">
          <tr class="bg-slate-700/30 font-bold">
            <td class="px-4 py-3 font-semibold">TOTAL</td>
            <td class="px-4 py-3 text-center text-xl">${totals.total}</td>
            <td class="px-4 py-3 text-center text-xl text-blue-400">${totals.resStorage}</td>
            <td class="px-4 py-3 text-center text-xl text-purple-400">${totals.equityResiliency}</td>
            <td class="px-4 py-3 text-center text-xl text-emerald-400">${totals.rsse}</td>
            <td class="px-4 py-3 text-center text-xl text-slate-400">${totals.other}</td>
          </tr>
          ${budgetData.map(m => `
            <tr class="hover:bg-slate-800/50">
              <td class="px-4 py-3 font-medium">${formatMonthLabel(m.month)}</td>
              <td class="px-4 py-3 text-center text-xl font-bold">${m.total}</td>
              <td class="px-4 py-3 text-center text-xl font-bold text-blue-400">${m.resStorage}</td>
              <td class="px-4 py-3 text-center text-xl font-bold text-purple-400">${m.equityResiliency}</td>
              <td class="px-4 py-3 text-center text-xl font-bold text-emerald-400">${m.rsse}</td>
              <td class="px-4 py-3 text-center text-xl font-bold text-slate-400">${m.other}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    <p class="text-xs text-slate-500 mt-4">RSSE = Residential Solar and Storage Equity ‚Ä¢ Categories determined from SGIP "Budget Category" field</p>
  `;
}

function renderActionItems() {
  const ai = getActionItems();
  return `
    <div class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-amber-400">‚ö° Action Items Dashboard</h3>
      <p class="text-sm text-slate-400 mt-1">Projects requiring attention based on workflow status</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      <div class="bg-slate-800/50 rounded-lg border border-red-500/30 p-4">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold text-red-400">üö´ Not Permitted</h4>
          <span class="text-2xl font-bold text-red-400">${ai.notPermitted.length}</span>
        </div>
        <p class="text-xs text-slate-400">Permitting status is not completed</p>
      </div>
      <div class="bg-slate-800/50 rounded-lg border border-orange-500/30 p-4">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold text-orange-400">üîå Meter Collar Needed</h4>
          <span class="text-2xl font-bold text-orange-400">${ai.meterCollar.length}</span>
        </div>
        <p class="text-xs text-slate-400">Inspection status is meter collar needed</p>
      </div>
      <div class="bg-slate-800/50 rounded-lg border border-blue-500/30 p-4">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold text-blue-400">üîç Awaiting Inspection</h4>
          <span class="text-2xl font-bold text-blue-400">${ai.awaitingInspection.length}</span>
        </div>
        <p class="text-xs text-slate-400">Inspection not passed or scheduled</p>
      </div>
      <div class="bg-slate-800/50 rounded-lg border border-purple-500/30 p-4">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold text-purple-400">üìÑ PTO'd but not ICF'd</h4>
          <span class="text-2xl font-bold text-purple-400">${ai.ptoButNoIcf.length}</span>
        </div>
        <p class="text-xs text-slate-400">PTO complete, ICF not in review/inspection/payment</p>
      </div>
      <div class="bg-slate-800/50 rounded-lg border border-cyan-500/30 p-4">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold text-cyan-400">‚úÖ Inspection Passed, No PTO</h4>
          <span class="text-2xl font-bold text-cyan-400">${ai.inspectionPassedNoPto.length}</span>
        </div>
        <p class="text-xs text-slate-400">Inspection passed but PTO not complete</p>
      </div>
    </div>

    ${ai.ptoButNoIcf.length > 0 ? `
    <div class="mb-6">
      <h4 class="text-lg font-semibold text-purple-400 mb-3">üìÑ PTO'd but not ICF'd (${ai.ptoButNoIcf.length})</h4>
      <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
        <div class="table-container overflow-x-auto" style="max-height: 400px;">
          <table class="w-full text-sm">
            <thead class="sticky-header"><tr>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Customer</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Install</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">PTO Date</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">ICF Progress</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Installer</th>
            </tr></thead>
            <tbody class="divide-y divide-slate-700/30">
              ${ai.ptoButNoIcf.map(d => `
                <tr class="hover:bg-slate-800/50">
                  <td class="px-3 py-2">${customerCell(d)}</td>
                  <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                  <td class="px-3 py-2 text-xs mono text-green-400">${d.ptoDate}</td>
                  <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs" style="background:${getStageInfo(d.sgipProgress||'Not Started').color}20;color:${getStageInfo(d.sgipProgress||'Not Started').color}">${d.sgipProgress || 'Not Started'}</span></td>
                  <td class="px-3 py-2 text-xs text-slate-400">${d.installer || '‚Äî'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    ` : ''}

    ${ai.inspectionPassedNoPto.length > 0 ? `
    <div class="mb-6">
      <h4 class="text-lg font-semibold text-cyan-400 mb-3">‚úÖ Inspection Passed, No PTO (${ai.inspectionPassedNoPto.length})</h4>
      <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
        <div class="table-container overflow-x-auto" style="max-height: 400px;">
          <table class="w-full text-sm">
            <thead class="sticky-header"><tr>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Customer</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Install</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Inspection</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Permit</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Installer</th>
            </tr></thead>
            <tbody class="divide-y divide-slate-700/30">
              ${ai.inspectionPassedNoPto.map(d => `
                <tr class="hover:bg-slate-800/50">
                  <td class="px-3 py-2">${customerCell(d)}</td>
                  <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                  <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border bg-green-900/50 text-green-400 border-green-800">Passed</span></td>
                  <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getPermitStyle(d.permitStatus)}">${d.permitStatus || '‚Äî'}</span></td>
                  <td class="px-3 py-2 text-xs text-slate-400">${d.installer || '‚Äî'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    ` : ''}

    ${ai.meterCollar.length > 0 ? `
    <div class="mb-6">
      <h4 class="text-lg font-semibold text-orange-400 mb-3">üîå Meter Collar Needed (${ai.meterCollar.length})</h4>
      <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
        <div class="table-container overflow-x-auto" style="max-height: 400px;">
          <table class="w-full text-sm">
            <thead class="sticky-header"><tr>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Customer</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Install</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Permit</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Installer</th>
            </tr></thead>
            <tbody class="divide-y divide-slate-700/30">
              ${ai.meterCollar.map(d => `
                <tr class="hover:bg-slate-800/50">
                  <td class="px-3 py-2">${customerCell(d)}</td>
                  <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                  <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getPermitStyle(d.permitStatus)}">${d.permitStatus || '‚Äî'}</span></td>
                  <td class="px-3 py-2 text-xs text-slate-400">${d.installer || '‚Äî'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    ` : ''}
  `;
}

// PTO Funnel Functions
function setPtoSubTab(tab) { state.ptoSubTab = tab; state.ptoSortBy = null; render(); }
function setPtoSort(col) { if (state.ptoSortBy === col) state.ptoSortDir = state.ptoSortDir === 'asc' ? 'desc' : 'asc'; else { state.ptoSortBy = col; state.ptoSortDir = 'desc'; } render(); }

function getPtoFunnelData() {
  const allDeals = getAllInstalled();
  const now = new Date();
  
  // Helper to calculate days since a date
  const daysSince = (dateStr) => {
    if (!dateStr) return null;
    const d = parseDate(dateStr);
    if (!d) return null;
    return Math.floor((now - d) / (1000 * 60 * 60 * 24));
  };
  
  // Helper to check if PTO is complete
  const hasPto = (d) => d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None';
  
  // Helper to check if PTO is submitted
  const hasPtoSubmitted = (d) => d.ptoSubmittedDate && d.ptoSubmittedDate !== '(No value)' && d.ptoSubmittedDate !== 'None';
  
  // 1. Permit Not Approved
  const permitNotApproved = allDeals.filter(d => d.permitStatus !== 'Approved')
    .map(d => ({ ...d, daysSinceInstall: daysSince(d.installDate) }));
  
  // 2. Inspection Scheduled/Requested
  const inspectionScheduled = allDeals.filter(d => 
    d.inspectionStatus === 'Scheduled' || d.inspectionStatus === 'Requested'
  ).map(d => ({ ...d, daysSinceInstall: daysSince(d.installDate) }));
  
  // 3. Inspection Not Complete (Failed, Pending HO Action, or no status)
  const inspectionNotComplete = allDeals.filter(d => {
    const status = d.inspectionStatus;
    return d.permitStatus === 'Approved' && 
           (status === 'Failed' || status === 'Pending HO Action' || !status || status === '(No value)');
  }).map(d => ({ ...d, daysSinceInstall: daysSince(d.installDate) }));
  
  // 4. Meter Collar Needed
  const meterCollarNeeded = allDeals.filter(d => 
    d.inspectionStatus === 'Meter Collar Needed' || 
    (d.inspectionStatus && d.inspectionStatus.toLowerCase().includes('meter collar'))
  ).map(d => ({ ...d, daysSinceInstall: daysSince(d.installDate) }));
  
  // 5. PTO Status - Not yet approved, but permit approved AND inspection passed
  const ptoNotApproved = allDeals.filter(d => 
    !hasPto(d) && 
    d.permitStatus === 'Approved' && 
    d.inspectionStatus === 'Passed'
  );
  const ptoSubmitted = ptoNotApproved.filter(d => hasPtoSubmitted(d))
    .map(d => ({ ...d, daysSinceSubmitted: daysSince(d.ptoSubmittedDate), daysSinceInstall: daysSince(d.installDate) }));
  const ptoNotSubmitted = ptoNotApproved.filter(d => !hasPtoSubmitted(d))
    .map(d => ({ ...d, daysSinceInstall: daysSince(d.installDate) }));
  
  return { permitNotApproved, inspectionScheduled, inspectionNotComplete, meterCollarNeeded, ptoSubmitted, ptoNotSubmitted };
}

function sortPtoData(deals, sortBy, sortDir) {
  if (!sortBy) return deals;
  return [...deals].sort((a, b) => {
    let av, bv;
    if (sortBy === 'customer') { av = a.customerName || ''; bv = b.customerName || ''; }
    else if (sortBy === 'utility') { av = getUtility(a) || ''; bv = getUtility(b) || ''; }
    else if (sortBy === 'installer') { av = a.installer || ''; bv = b.installer || ''; }
    else if (sortBy === 'installDate') { const da = parseDate(a.installDate), db = parseDate(b.installDate); av = da ? da.getTime() : 0; bv = db ? db.getTime() : 0; }
    else if (sortBy === 'daysSinceInstall') { av = a.daysSinceInstall ?? -1; bv = b.daysSinceInstall ?? -1; }
    else if (sortBy === 'daysSinceSubmitted') { av = a.daysSinceSubmitted ?? -1; bv = b.daysSinceSubmitted ?? -1; }
    else if (sortBy === 'ptoSubmittedDate') { const da = parseDate(a.ptoSubmittedDate), db = parseDate(b.ptoSubmittedDate); av = da ? da.getTime() : 0; bv = db ? db.getTime() : 0; }
    else if (sortBy === 'permitStatus') { av = a.permitStatus || ''; bv = b.permitStatus || ''; }
    else if (sortBy === 'inspectionStatus') { av = a.inspectionStatus || ''; bv = b.inspectionStatus || ''; }
    else return 0;
    if (typeof av === 'string') return sortDir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
    return sortDir === 'asc' ? av - bv : bv - av;
  });
}

function ptoSortHeader(label, col) {
  const active = state.ptoSortBy === col;
  return `<th class="px-3 py-2 text-left text-xs font-semibold uppercase cursor-pointer hover:text-slate-200 ${active ? 'text-cyan-400' : 'text-slate-400'}" onclick="setPtoSort('${col}')">${label} ${active ? (state.ptoSortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>`;
}

function renderPtoFunnelTab() {
  const data = getPtoFunnelData();
  const total = data.permitNotApproved.length + data.inspectionScheduled.length + data.inspectionNotComplete.length + data.meterCollarNeeded.length + data.ptoSubmitted.length + data.ptoNotSubmitted.length;
  const tabs = [
    { key: 'summary', label: 'üìä Summary', count: total, color: 'slate' },
    { key: 'permitNotApproved', label: 'Permit Not Approved', count: data.permitNotApproved.length, color: 'red' },
    { key: 'inspectionScheduled', label: 'Inspection Scheduled', count: data.inspectionScheduled.length, color: 'blue' },
    { key: 'inspectionNotComplete', label: 'Inspection Not Complete', count: data.inspectionNotComplete.length, color: 'amber' },
    { key: 'meterCollar', label: 'Meter Collar Needed', count: data.meterCollarNeeded.length, color: 'orange' },
    { key: 'ptoStatus', label: 'PTO Status', count: data.ptoSubmitted.length + data.ptoNotSubmitted.length, color: 'cyan' }
  ];
  
  return `
    <div class="flex gap-2 mb-4 flex-wrap">
      ${tabs.map(t => `
        <button onclick="setPtoSubTab('${t.key}')" class="subtab px-3 py-1.5 rounded-lg text-sm font-medium border ${state.ptoSubTab === t.key ? `active border-${t.color}-500/40 text-${t.color}-400` : 'border-slate-700/50 text-slate-400'}">
          ${t.label} <span class="ml-1 px-1.5 py-0.5 rounded text-xs ${state.ptoSubTab === t.key ? `bg-${t.color}-500/20` : 'bg-slate-700'}">${t.count}</span>
        </button>
      `).join('')}
    </div>
    ${state.ptoSubTab === 'summary' ? renderPtoFunnelSummary(data) :
      state.ptoSubTab === 'permitNotApproved' ? renderPermitNotApproved(data.permitNotApproved) : 
      state.ptoSubTab === 'inspectionScheduled' ? renderInspectionScheduled(data.inspectionScheduled) :
      state.ptoSubTab === 'inspectionNotComplete' ? renderInspectionNotComplete(data.inspectionNotComplete) :
      state.ptoSubTab === 'meterCollar' ? renderMeterCollarNeeded(data.meterCollarNeeded) :
      renderPtoStatus(data.ptoSubmitted, data.ptoNotSubmitted)}
  `;
}

function renderPtoFunnelSummary(data) {
  const calcIncentive = (deals) => deals.reduce((sum, d) => sum + parseNum(d.currentIncentive || d.finalIncentive), 0);
  
  const categories = [
    { label: 'Permit Not Approved', count: data.permitNotApproved.length, amount: calcIncentive(data.permitNotApproved), color: 'red', key: 'permitNotApproved' },
    { label: 'Inspection Scheduled', count: data.inspectionScheduled.length, amount: calcIncentive(data.inspectionScheduled), color: 'blue', key: 'inspectionScheduled' },
    { label: 'Inspection Not Complete', count: data.inspectionNotComplete.length, amount: calcIncentive(data.inspectionNotComplete), color: 'amber', key: 'inspectionNotComplete' },
    { label: 'Meter Collar Needed', count: data.meterCollarNeeded.length, amount: calcIncentive(data.meterCollarNeeded), color: 'orange', key: 'meterCollar' },
    { label: 'PTO Submitted', count: data.ptoSubmitted.length, amount: calcIncentive(data.ptoSubmitted), color: 'blue', key: 'ptoStatus' },
    { label: 'PTO Not Submitted', count: data.ptoNotSubmitted.length, amount: calcIncentive(data.ptoNotSubmitted), color: 'amber', key: 'ptoStatus' }
  ];
  
  const total = categories.reduce((sum, c) => sum + c.count, 0);
  const totalIncentive = categories.reduce((sum, c) => sum + c.amount, 0);
  
  return `
    <div class="bg-slate-500/10 border border-slate-500/30 rounded-lg p-4 mb-4">
      <div>
        <h3 class="font-semibold text-slate-200">üéØ PTO Funnel Summary</h3>
        <p class="text-sm text-slate-400 mt-1">Projects not yet PTO approved, grouped by current status</p>
      </div>
    </div>
    
    <!-- Current Counts -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 mb-6">
      ${categories.map(c => `
        <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 cursor-pointer hover:border-${c.color}-500/50 transition-all" onclick="setPtoSubTab('${c.key}')">
          <p class="text-slate-400 text-xs uppercase mb-1">${c.label}</p>
          <p class="text-2xl font-bold text-${c.color}-400">${c.count}</p>
          <p class="text-xs text-${c.color}-400/70 mt-1">${fmtCurrency(c.amount)}</p>
        </div>
      `).join('')}
      <div class="bg-slate-700/50 rounded-lg p-4 border border-slate-500/50">
        <p class="text-slate-400 text-xs uppercase mb-1">Total in Funnel</p>
        <p class="text-2xl font-bold text-white">${total}</p>
        <p class="text-xs text-slate-300/70 mt-1">${fmtCurrency(totalIncentive)}</p>
      </div>
    </div>
  `;
}

function renderPermitNotApproved(deals) {
  const sorted = sortPtoData(deals, state.ptoSortBy || 'daysSinceInstall', state.ptoSortDir);
  const totalIncentive = deals.reduce((sum, d) => sum + parseNum(d.currentIncentive || d.finalIncentive), 0);
  return `
    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-red-400">üö´ Permit Not Approved</h3>
      <p class="text-sm text-slate-400 mt-1">Projects where permit has not been approved</p>
      <div class="mt-3 flex gap-6">
        <div>
          <div class="text-2xl font-bold text-red-400">${deals.length}</div>
          <div class="text-xs text-slate-400">projects</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-red-400">${fmtCurrency(totalIncentive)}</div>
          <div class="text-xs text-slate-400">total incentive</div>
        </div>
      </div>
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
      <div class="table-container overflow-x-auto" style="max-height: 600px;">
        <table class="w-full text-sm">
          <thead class="sticky-header"><tr>
            ${ptoSortHeader('Customer', 'customer')}
            ${ptoSortHeader('Utility', 'utility')}
            ${ptoSortHeader('Install Date', 'installDate')}
            ${ptoSortHeader('Days Since Install', 'daysSinceInstall')}
            ${ptoSortHeader('Permit Status', 'permitStatus')}
            ${ptoSortHeader('Installer', 'installer')}
          </tr></thead>
          <tbody class="divide-y divide-slate-700/30">
            ${sorted.length === 0 ? '<tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">No projects in this category</td></tr>' : sorted.map(d => `
              <tr class="hover:bg-slate-800/50">
                <td class="px-3 py-2">${customerCell(d)}${d.applicationCode ? '<br><span class="text-xs text-slate-500 mono">'+d.applicationCode+'</span>' : ''}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getUtilityStyle(getUtility(d))}">${getUtility(d) || '‚Äî'}</span></td>
                <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                <td class="px-3 py-2 font-bold ${d.daysSinceInstall > 30 ? 'text-red-400' : d.daysSinceInstall > 14 ? 'text-amber-400' : 'text-slate-300'}">${d.daysSinceInstall !== null ? d.daysSinceInstall + 'd' : '‚Äî'}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs bg-red-900/50 text-red-400 border border-red-800">${d.permitStatus || 'Not Set'}</span></td>
                <td class="px-3 py-2 text-xs">${d.installer || '‚Äî'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderInspectionScheduled(deals) {
  const sorted = sortPtoData(deals, state.ptoSortBy || 'daysSinceInstall', state.ptoSortDir);
  const totalIncentive = deals.reduce((sum, d) => sum + parseNum(d.currentIncentive || d.finalIncentive), 0);
  return `
    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-blue-400">üìÖ Inspection Scheduled/Requested</h3>
      <p class="text-sm text-slate-400 mt-1">Projects with inspection scheduled or requested</p>
      <p class="text-xs text-slate-500 mt-1">Note: Inspection scheduled date not currently available from HubSpot</p>
      <div class="mt-3 flex gap-6">
        <div>
          <div class="text-2xl font-bold text-blue-400">${deals.length}</div>
          <div class="text-xs text-slate-400">projects</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-blue-400">${fmtCurrency(totalIncentive)}</div>
          <div class="text-xs text-slate-400">total incentive</div>
        </div>
      </div>
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
      <div class="table-container overflow-x-auto" style="max-height: 600px;">
        <table class="w-full text-sm">
          <thead class="sticky-header"><tr>
            ${ptoSortHeader('Customer', 'customer')}
            ${ptoSortHeader('Utility', 'utility')}
            ${ptoSortHeader('Install Date', 'installDate')}
            ${ptoSortHeader('Days Since Install', 'daysSinceInstall')}
            ${ptoSortHeader('Inspection Status', 'inspectionStatus')}
            ${ptoSortHeader('Installer', 'installer')}
          </tr></thead>
          <tbody class="divide-y divide-slate-700/30">
            ${sorted.length === 0 ? '<tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">No projects in this category</td></tr>' : sorted.map(d => `
              <tr class="hover:bg-slate-800/50">
                <td class="px-3 py-2">${customerCell(d)}${d.applicationCode ? '<br><span class="text-xs text-slate-500 mono">'+d.applicationCode+'</span>' : ''}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getUtilityStyle(getUtility(d))}">${getUtility(d) || '‚Äî'}</span></td>
                <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                <td class="px-3 py-2 font-bold ${d.daysSinceInstall > 30 ? 'text-red-400' : d.daysSinceInstall > 14 ? 'text-amber-400' : 'text-slate-300'}">${d.daysSinceInstall !== null ? d.daysSinceInstall + 'd' : '‚Äî'}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs bg-blue-900/50 text-blue-400 border border-blue-800">${d.inspectionStatus}</span></td>
                <td class="px-3 py-2 text-xs">${d.installer || '‚Äî'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderInspectionNotComplete(deals) {
  const sorted = sortPtoData(deals, state.ptoSortBy || 'daysSinceInstall', state.ptoSortDir);
  const totalIncentive = deals.reduce((sum, d) => sum + parseNum(d.currentIncentive || d.finalIncentive), 0);
  return `
    <div class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-amber-400">‚è≥ Inspection Not Complete</h3>
      <p class="text-sm text-slate-400 mt-1">Projects with permit approved but inspection failed, pending, or not scheduled</p>
      <div class="mt-3 flex gap-6">
        <div>
          <div class="text-2xl font-bold text-amber-400">${deals.length}</div>
          <div class="text-xs text-slate-400">projects</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-amber-400">${fmtCurrency(totalIncentive)}</div>
          <div class="text-xs text-slate-400">total incentive</div>
        </div>
      </div>
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
      <div class="table-container overflow-x-auto" style="max-height: 600px;">
        <table class="w-full text-sm">
          <thead class="sticky-header"><tr>
            ${ptoSortHeader('Customer', 'customer')}
            ${ptoSortHeader('Utility', 'utility')}
            ${ptoSortHeader('Install Date', 'installDate')}
            ${ptoSortHeader('Days Since Install', 'daysSinceInstall')}
            ${ptoSortHeader('Inspection Status', 'inspectionStatus')}
            ${ptoSortHeader('Installer', 'installer')}
          </tr></thead>
          <tbody class="divide-y divide-slate-700/30">
            ${sorted.length === 0 ? '<tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">No projects in this category</td></tr>' : sorted.map(d => `
              <tr class="hover:bg-slate-800/50">
                <td class="px-3 py-2">${customerCell(d)}${d.applicationCode ? '<br><span class="text-xs text-slate-500 mono">'+d.applicationCode+'</span>' : ''}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getUtilityStyle(getUtility(d))}">${getUtility(d) || '‚Äî'}</span></td>
                <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                <td class="px-3 py-2 font-bold ${d.daysSinceInstall > 30 ? 'text-red-400' : d.daysSinceInstall > 14 ? 'text-amber-400' : 'text-slate-300'}">${d.daysSinceInstall !== null ? d.daysSinceInstall + 'd' : '‚Äî'}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs bg-amber-900/50 text-amber-400 border border-amber-800">${d.inspectionStatus || 'Not Set'}</span></td>
                <td class="px-3 py-2 text-xs">${d.installer || '‚Äî'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderMeterCollarNeeded(deals) {
  const sorted = sortPtoData(deals, state.ptoSortBy || 'daysSinceInstall', state.ptoSortDir);
  const totalIncentive = deals.reduce((sum, d) => sum + parseNum(d.currentIncentive || d.finalIncentive), 0);
  return `
    <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-orange-400">üîß Meter Collar Needed</h3>
      <p class="text-sm text-slate-400 mt-1">Projects waiting for meter collar installation</p>
      <div class="mt-3 flex gap-6">
        <div>
          <div class="text-2xl font-bold text-orange-400">${deals.length}</div>
          <div class="text-xs text-slate-400">projects</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-orange-400">${fmtCurrency(totalIncentive)}</div>
          <div class="text-xs text-slate-400">total incentive</div>
        </div>
      </div>
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
      <div class="table-container overflow-x-auto" style="max-height: 600px;">
        <table class="w-full text-sm">
          <thead class="sticky-header"><tr>
            ${ptoSortHeader('Customer', 'customer')}
            ${ptoSortHeader('Utility', 'utility')}
            ${ptoSortHeader('Install Date', 'installDate')}
            ${ptoSortHeader('Days Since Install', 'daysSinceInstall')}
            ${ptoSortHeader('Installer', 'installer')}
          </tr></thead>
          <tbody class="divide-y divide-slate-700/30">
            ${sorted.length === 0 ? '<tr><td colspan="5" class="px-3 py-8 text-center text-slate-500">No projects in this category</td></tr>' : sorted.map(d => `
              <tr class="hover:bg-slate-800/50">
                <td class="px-3 py-2">${customerCell(d)}${d.applicationCode ? '<br><span class="text-xs text-slate-500 mono">'+d.applicationCode+'</span>' : ''}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getUtilityStyle(getUtility(d))}">${getUtility(d) || '‚Äî'}</span></td>
                <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                <td class="px-3 py-2 font-bold ${d.daysSinceInstall > 30 ? 'text-red-400' : d.daysSinceInstall > 14 ? 'text-amber-400' : 'text-slate-300'}">${d.daysSinceInstall !== null ? d.daysSinceInstall + 'd' : '‚Äî'}</td>
                <td class="px-3 py-2 text-xs">${d.installer || '‚Äî'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderPtoStatus(ptoSubmitted, ptoNotSubmitted) {
  const sortedSubmitted = sortPtoData(ptoSubmitted, state.ptoSortBy || 'daysSinceSubmitted', state.ptoSortDir);
  const sortedNotSubmitted = sortPtoData(ptoNotSubmitted, state.ptoSortBy || 'daysSinceInstall', state.ptoSortDir);
  const totalIncentiveSubmitted = ptoSubmitted.reduce((sum, d) => sum + parseNum(d.currentIncentive || d.finalIncentive), 0);
  const totalIncentiveNotSubmitted = ptoNotSubmitted.reduce((sum, d) => sum + parseNum(d.currentIncentive || d.finalIncentive), 0);
  
  return `
    <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-cyan-400">üìã PTO Status</h3>
      <p class="text-sm text-slate-400 mt-1">Projects with permit approved & inspection passed, awaiting PTO approval</p>
      <div class="mt-3 flex gap-6">
        <div>
          <div class="text-2xl font-bold text-blue-400">${ptoSubmitted.length}</div>
          <div class="text-xs text-slate-400">submitted (${fmtCurrency(totalIncentiveSubmitted)})</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-amber-400">${ptoNotSubmitted.length}</div>
          <div class="text-xs text-slate-400">not submitted (${fmtCurrency(totalIncentiveNotSubmitted)})</div>
        </div>
      </div>
    </div>
    
    <!-- PTO Submitted -->
    <div class="mb-6">
      <h4 class="text-lg font-semibold text-blue-400 mb-3">‚úÖ PTO Submitted (${ptoSubmitted.length})</h4>
      <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
        <div class="table-container overflow-x-auto" style="max-height: 400px;">
          <table class="w-full text-sm">
            <thead class="sticky-header"><tr>
              ${ptoSortHeader('Customer', 'customer')}
              ${ptoSortHeader('Utility', 'utility')}
              ${ptoSortHeader('Install Date', 'installDate')}
              ${ptoSortHeader('PTO Submitted', 'ptoSubmittedDate')}
              ${ptoSortHeader('Days Waiting', 'daysSinceSubmitted')}
              ${ptoSortHeader('Installer', 'installer')}
            </tr></thead>
            <tbody class="divide-y divide-slate-700/30">
              ${sortedSubmitted.length === 0 ? '<tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">No projects in this category</td></tr>' : sortedSubmitted.map(d => `
                <tr class="hover:bg-slate-800/50">
                  <td class="px-3 py-2">${customerCell(d)}${d.applicationCode ? '<br><span class="text-xs text-slate-500 mono">'+d.applicationCode+'</span>' : ''}</td>
                  <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getUtilityStyle(getUtility(d))}">${getUtility(d) || '‚Äî'}</span></td>
                  <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                  <td class="px-3 py-2 text-xs mono text-blue-400">${d.ptoSubmittedDate || '‚Äî'}</td>
                  <td class="px-3 py-2 font-bold ${d.daysSinceSubmitted > 30 ? 'text-red-400' : d.daysSinceSubmitted > 14 ? 'text-amber-400' : 'text-slate-300'}">${d.daysSinceSubmitted !== null ? d.daysSinceSubmitted + 'd' : '‚Äî'}</td>
                  <td class="px-3 py-2 text-xs">${d.installer || '‚Äî'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- PTO Not Submitted -->
    <div>
      <h4 class="text-lg font-semibold text-amber-400 mb-3">‚è≥ PTO Not Submitted (${ptoNotSubmitted.length})</h4>
      <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
        <div class="table-container overflow-x-auto" style="max-height: 400px;">
          <table class="w-full text-sm">
            <thead class="sticky-header"><tr>
              ${ptoSortHeader('Customer', 'customer')}
              ${ptoSortHeader('Utility', 'utility')}
              ${ptoSortHeader('Install Date', 'installDate')}
              ${ptoSortHeader('Days Since Install', 'daysSinceInstall')}
              ${ptoSortHeader('Inspection Status', 'inspectionStatus')}
              ${ptoSortHeader('Installer', 'installer')}
            </tr></thead>
            <tbody class="divide-y divide-slate-700/30">
              ${sortedNotSubmitted.length === 0 ? '<tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">No projects in this category</td></tr>' : sortedNotSubmitted.map(d => `
                <tr class="hover:bg-slate-800/50">
                  <td class="px-3 py-2">${customerCell(d)}${d.applicationCode ? '<br><span class="text-xs text-slate-500 mono">'+d.applicationCode+'</span>' : ''}</td>
                  <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getUtilityStyle(getUtility(d))}">${getUtility(d) || '‚Äî'}</span></td>
                  <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                  <td class="px-3 py-2 font-bold ${d.daysSinceInstall > 30 ? 'text-red-400' : d.daysSinceInstall > 14 ? 'text-amber-400' : 'text-slate-300'}">${d.daysSinceInstall !== null ? d.daysSinceInstall + 'd' : '‚Äî'}</td>
                  <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs ${d.inspectionStatus === 'Passed' ? 'bg-green-900/50 text-green-400 border border-green-800' : 'bg-slate-700 text-slate-400 border border-slate-600'}">${d.inspectionStatus || 'Not Set'}</span></td>
                  <td class="px-3 py-2 text-xs">${d.installer || '‚Äî'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

// ICF Deep Dive Functions
function getIcfDeepDiveData() {
  const allDeals = getAllInstalled();
  const now = new Date();
  
  // Helper to check if has PTO
  const hasPto = (d) => d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None';
  
  // Helper to get status from fullyQualifiedState/sgipProgress
  const getStatus = (d) => (d.sgipProgress || '').toLowerCase();
  
  // Helper to calculate days since a date
  const daysSince = (dateStr) => {
    if (!dateStr) return null;
    const d = parseDate(dateStr);
    if (!d) return null;
    return Math.floor((now - d) / (1000 * 60 * 60 * 24));
  };
  
  // 1. PTO'd but ICF not yet submitted (still in RRF statuses or ICF Draft)
  const ptoNoIcf = allDeals.filter(d => {
    if (!hasPto(d)) return false;
    const status = getStatus(d);
    return status.includes('rrf') || status === 'icf: draft' || status.includes('icf draft');
  }).map(d => ({ ...d, daysSincePto: daysSince(d.ptoDate) }));
  
  // 2. Revisions required (ICF Suspended or ICF Inspection Suspended)
  const revisions = allDeals.filter(d => {
    const status = getStatus(d);
    return status.includes('icf suspended') || status.includes('icf: suspended') || 
           status.includes('inspection suspended');
  }).map(d => {
    const status = getStatus(d);
    const suspendedType = status.includes('inspection suspended') ? 'ICF Inspection Suspended' : 'ICF Suspended';
    return { ...d, suspendedType, daysSinceSuspended: daysSince(d.icfSuspendedDate) };
  });
  
  // 3. ICF Submitted (ICF Submitted or ICF Resubmitted status)
  const icfSubmitted = allDeals.filter(d => {
    const status = getStatus(d);
    return status === 'icf: submitted' || status === 'icf submitted' || 
           status === 'icf: resubmitted' || status === 'icf resubmitted';
  }).map(d => {
    // Days is from resubmitted date if exists, otherwise from submitted date
    const effectiveDate = d.icfResubmittedDate || d.icfSubmittedDate;
    return { ...d, daysPending: daysSince(effectiveDate) };
  });
  
  // 4. ICF Review (ICF Review or ICF Technical Review)
  const icfReview = allDeals.filter(d => {
    const status = getStatus(d);
    return status === 'icf: review' || status === 'icf review' || 
           status === 'icf: technical review' || status === 'icf technical review';
  }).map(d => {
    const effectiveDate = d.icfResubmittedDate || d.icfSubmittedDate;
    return { ...d, daysSinceSubmitted: daysSince(effectiveDate) };
  });
  
  // 5. ICF Inspection
  const icfInspection = allDeals.filter(d => {
    const status = getStatus(d);
    return (status === 'icf: inspection' || status === 'icf inspection') && 
           !status.includes('suspended');
  });
  
  // 6. Pending Payment (ICF Pending Payment)
  const pendingPayment = allDeals.filter(d => {
    const status = getStatus(d);
    return status === 'icf: pending payment' || status === 'icf pending payment';
  }).map(d => ({ ...d, daysSinceApproved: daysSince(d.icfPendingPaymentDate) }));
  
  // 7. Payment Complete
  const paymentComplete = allDeals.filter(d => {
    const status = getStatus(d);
    return status === 'payment: completed' || status === 'payment completed';
  });
  
  return { ptoNoIcf, revisions, icfSubmitted, icfReview, icfInspection, pendingPayment, paymentComplete };
}

function sortIcfData(deals, sortBy, sortDir) {
  if (!sortBy) return deals;
  return [...deals].sort((a, b) => {
    let av, bv;
    if (sortBy === 'customer') { av = a.customerName || ''; bv = b.customerName || ''; }
    else if (sortBy === 'utility') { av = getUtility(a) || ''; bv = getUtility(b) || ''; }
    else if (sortBy === 'installDate') { const da = parseDate(a.installDate), db = parseDate(b.installDate); av = da ? da.getTime() : 0; bv = db ? db.getTime() : 0; }
    else if (sortBy === 'ptoDate') { const da = parseDate(a.ptoDate), db = parseDate(b.ptoDate); av = da ? da.getTime() : 0; bv = db ? db.getTime() : 0; }
    else if (sortBy === 'daysSincePto') { av = a.daysSincePto ?? -1; bv = b.daysSincePto ?? -1; }
    else if (sortBy === 'daysSinceSuspended') { av = a.daysSinceSuspended ?? -1; bv = b.daysSinceSuspended ?? -1; }
    else if (sortBy === 'daysPending') { av = a.daysPending ?? -1; bv = b.daysPending ?? -1; }
    else if (sortBy === 'daysSinceSubmitted') { av = a.daysSinceSubmitted ?? -1; bv = b.daysSinceSubmitted ?? -1; }
    else if (sortBy === 'icfSubmittedDate') { const da = parseDate(a.icfSubmittedDate), db = parseDate(b.icfSubmittedDate); av = da ? da.getTime() : 0; bv = db ? db.getTime() : 0; }
    else if (sortBy === 'icfSuspendedDate') { const da = parseDate(a.icfSuspendedDate), db = parseDate(b.icfSuspendedDate); av = da ? da.getTime() : 0; bv = db ? db.getTime() : 0; }
    else if (sortBy === 'icfInspectionDate') { const da = parseDate(a.icfInspectionDate), db = parseDate(b.icfInspectionDate); av = da ? da.getTime() : 0; bv = db ? db.getTime() : 0; }
    else if (sortBy === 'inspectionDate') { const da = parseDate(a.inspectionDate), db = parseDate(b.inspectionDate); av = da ? da.getTime() : 0; bv = db ? db.getTime() : 0; }
    else if (sortBy === 'icfPendingPaymentDate') { const da = parseDate(a.icfPendingPaymentDate), db = parseDate(b.icfPendingPaymentDate); av = da ? da.getTime() : 0; bv = db ? db.getTime() : 0; }
    else if (sortBy === 'daysSinceApproved') { av = a.daysSinceApproved ?? -1; bv = b.daysSinceApproved ?? -1; }
    else if (sortBy === 'paymentCompletedDate') { const da = parseDate(a.paymentCompletedDate), db = parseDate(b.paymentCompletedDate); av = da ? da.getTime() : 0; bv = db ? db.getTime() : 0; }
    else if (sortBy === 'paymentAmount') { av = parseNum(a.paymentAmount); bv = parseNum(b.paymentAmount); }
    else if (sortBy === 'incentive') { av = parseNum(a.finalIncentive || a.currentIncentive); bv = parseNum(b.finalIncentive || b.currentIncentive); }
    else return 0;
    if (typeof av === 'string') return sortDir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
    return sortDir === 'asc' ? av - bv : bv - av;
  });
}

function icfSortHeader(label, col) {
  const active = state.icfSortBy === col;
  return `<th class="px-3 py-2 text-left text-xs font-semibold uppercase cursor-pointer hover:text-slate-200 ${active ? 'text-cyan-400' : 'text-slate-400'}" onclick="setIcfSort('${col}')">${label} ${active ? (state.icfSortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>`;
}

function renderIcfDeepDiveTab() {
  const data = getIcfDeepDiveData();
  const total = data.ptoNoIcf.length + data.revisions.length + data.icfSubmitted.length + data.icfReview.length + data.icfInspection.length + data.pendingPayment.length;
  const tabs = [
    { key: 'summary', label: 'üìä Summary', count: total, color: 'slate' },
    { key: 'ptoNoIcf', label: 'PTO\'d, No ICF', count: data.ptoNoIcf.length, color: 'amber' },
    { key: 'revisions', label: 'Revisions Required', count: data.revisions.length, color: 'red' },
    { key: 'icfSubmitted', label: 'ICF Submitted', count: data.icfSubmitted.length, color: 'blue' },
    { key: 'icfReview', label: 'ICF Review', count: data.icfReview.length, color: 'purple' },
    { key: 'icfInspection', label: 'ICF Inspection', count: data.icfInspection.length, color: 'cyan' },
    { key: 'pendingPayment', label: 'Pending Payment', count: data.pendingPayment.length, color: 'emerald' },
    { key: 'paymentComplete', label: 'Payment Complete', count: data.paymentComplete.length, color: 'green' }
  ];
  
  return `
    <div class="flex gap-2 mb-4 flex-wrap">
      ${tabs.map(t => `
        <button onclick="setIcfSubTab('${t.key}')" class="subtab px-3 py-1.5 rounded-lg text-sm font-medium border ${state.icfSubTab === t.key ? `active border-${t.color}-500/40 text-${t.color}-400` : 'border-slate-700/50 text-slate-400'}">
          ${t.label} <span class="ml-1 px-1.5 py-0.5 rounded text-xs ${state.icfSubTab === t.key ? `bg-${t.color}-500/20` : 'bg-slate-700'}">${t.count}</span>
        </button>
      `).join('')}
    </div>
    ${state.icfSubTab === 'summary' ? renderIcfSummary(data) :
      state.icfSubTab === 'ptoNoIcf' ? renderPtoNoIcf(data.ptoNoIcf) : 
      state.icfSubTab === 'revisions' ? renderRevisions(data.revisions) :
      state.icfSubTab === 'icfSubmitted' ? renderIcfSubmittedDeep(data.icfSubmitted) :
      state.icfSubTab === 'icfReview' ? renderIcfReview(data.icfReview) :
      state.icfSubTab === 'icfInspection' ? renderIcfInspection(data.icfInspection) :
      state.icfSubTab === 'pendingPayment' ? renderPendingPayment(data.pendingPayment) :
      renderPaymentComplete(data.paymentComplete)}
  `;
}

// ICF Daily Snapshots
let ICF_SNAPSHOTS = [];

async function loadIcfSnapshots() {
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/icf_daily_snapshots?select=*&order=snapshot_date.desc&limit=30`, {
      headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
    });
    if (response.ok) {
      ICF_SNAPSHOTS = await response.json();
    }
  } catch (e) { console.error('Failed to load ICF snapshots:', e); }
}

async function saveIcfSnapshot(data) {
  const today = new Date().toISOString().split('T')[0];
  const total = data.ptoNoIcf.length + data.revisions.length + data.icfSubmitted.length + data.icfReview.length + data.icfInspection.length + data.pendingPayment.length;
  
  const snapshot = {
    snapshot_date: today,
    pto_no_icf: data.ptoNoIcf.length,
    revisions: data.revisions.length,
    icf_submitted: data.icfSubmitted.length,
    icf_review: data.icfReview.length,
    icf_inspection: data.icfInspection.length,
    pending_payment: data.pendingPayment.length,
    total: total
  };
  
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/icf_daily_snapshots`, {
      method: 'POST',
      headers: { 
        'apikey': SUPABASE_ANON_KEY, 
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'resolution=merge-duplicates'
      },
      body: JSON.stringify(snapshot)
    });
    if (response.ok) {
      await loadIcfSnapshots();
      render();
      return true;
    }
  } catch (e) { console.error('Failed to save ICF snapshot:', e); }
  return false;
}

function formatSnapshotDate(dateStr) {
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
}

function renderIcfSummary(data) {
  const total = data.ptoNoIcf.length + data.revisions.length + data.icfSubmitted.length + data.icfReview.length + data.icfInspection.length + data.pendingPayment.length;
  
  const calcIncentive = (deals) => deals.reduce((sum, d) => sum + parseNum(d.currentIncentive || d.finalIncentive), 0);
  const calcPayment = (deals) => deals.reduce((sum, d) => sum + parseNum(d.paymentAmount), 0);
  
  const pipelineCategories = [
    { label: "PTO'd, No ICF", count: data.ptoNoIcf.length, amount: calcIncentive(data.ptoNoIcf), color: 'amber', key: 'ptoNoIcf' },
    { label: 'Revisions Required', count: data.revisions.length, amount: calcIncentive(data.revisions), color: 'red', key: 'revisions' },
    { label: 'ICF Submitted', count: data.icfSubmitted.length, amount: calcIncentive(data.icfSubmitted), color: 'blue', key: 'icfSubmitted' },
    { label: 'ICF Review', count: data.icfReview.length, amount: calcIncentive(data.icfReview), color: 'purple', key: 'icfReview' },
    { label: 'ICF Inspection', count: data.icfInspection.length, amount: calcIncentive(data.icfInspection), color: 'cyan', key: 'icfInspection' },
    { label: 'Pending Payment', count: data.pendingPayment.length, amount: calcIncentive(data.pendingPayment), color: 'emerald', key: 'pendingPayment' }
  ];
  
  const totalIncentive = pipelineCategories.reduce((sum, c) => sum + c.amount, 0);
  const paymentComplete = { label: 'Payment Complete', count: data.paymentComplete.length, amount: calcPayment(data.paymentComplete), color: 'green', key: 'paymentComplete' };
  
  // Check if we have today's snapshot
  const today = new Date().toISOString().split('T')[0];
  const hasToday = ICF_SNAPSHOTS.some(s => s.snapshot_date === today);
  
  return `
    <div class="bg-slate-500/10 border border-slate-500/30 rounded-lg p-4 mb-4">
      <div>
        <h3 class="font-semibold text-slate-200">üìä ICF Pipeline Summary</h3>
        <p class="text-sm text-slate-400 mt-1">Current snapshot of all ICF pipeline stages ‚Ä¢ Auto-saved daily at 11:59 PM PST</p>
      </div>
    </div>
    
    <!-- Current Counts -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3 mb-6">
      ${pipelineCategories.map(c => `
        <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 cursor-pointer hover:border-${c.color}-500/50 transition-all" onclick="setIcfSubTab('${c.key}')">
          <p class="text-slate-400 text-xs uppercase mb-1">${c.label}</p>
          <p class="text-2xl font-bold text-${c.color}-400">${c.count}</p>
          <p class="text-xs text-${c.color}-400/70 mt-1">${fmtCurrency(c.amount)}</p>
        </div>
      `).join('')}
      <div class="bg-slate-700/50 rounded-lg p-4 border border-slate-500/50">
        <p class="text-slate-400 text-xs uppercase mb-1">Total Pipeline</p>
        <p class="text-2xl font-bold text-white">${total}</p>
        <p class="text-xs text-slate-300/70 mt-1">${fmtCurrency(totalIncentive)}</p>
      </div>
      <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 cursor-pointer hover:border-green-500/50 transition-all" onclick="setIcfSubTab('paymentComplete')">
        <p class="text-slate-400 text-xs uppercase mb-1">${paymentComplete.label}</p>
        <p class="text-2xl font-bold text-green-400">${paymentComplete.count}</p>
        <p class="text-xs text-green-400/70 mt-1">${fmtCurrency(paymentComplete.amount)}</p>
      </div>
    </div>
    
    <!-- Historical Data -->
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
      <div class="px-4 py-3 border-b border-slate-700/50">
        <h4 class="font-semibold text-slate-300">üìÖ Daily Snapshots</h4>
        <p class="text-xs text-slate-500 mt-1">Historical tracking at 11:59 PM PST daily</p>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-slate-700 bg-slate-900/50">
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Date</th>
              <th class="px-4 py-3 text-center text-xs font-semibold text-amber-400 uppercase">PTO'd, No ICF</th>
              <th class="px-4 py-3 text-center text-xs font-semibold text-red-400 uppercase">Revisions</th>
              <th class="px-4 py-3 text-center text-xs font-semibold text-blue-400 uppercase">Submitted</th>
              <th class="px-4 py-3 text-center text-xs font-semibold text-purple-400 uppercase">Review</th>
              <th class="px-4 py-3 text-center text-xs font-semibold text-cyan-400 uppercase">Inspection</th>
              <th class="px-4 py-3 text-center text-xs font-semibold text-emerald-400 uppercase">Pending Pay</th>
              <th class="px-4 py-3 text-center text-xs font-semibold text-slate-300 uppercase">Total</th>
              <th class="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Change</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-700/30">
            ${ICF_SNAPSHOTS.length === 0 ? `
              <tr><td colspan="9" class="px-4 py-8 text-center text-slate-500">No snapshots yet. Click "Save Today's Snapshot" to start tracking.</td></tr>
            ` : ICF_SNAPSHOTS.map((s, i) => {
              const prev = ICF_SNAPSHOTS[i + 1];
              const change = prev ? s.total - prev.total : null;
              return `
                <tr class="hover:bg-slate-800/50">
                  <td class="px-4 py-3 font-medium">${formatSnapshotDate(s.snapshot_date)}</td>
                  <td class="px-4 py-3 text-center text-amber-400">${s.pto_no_icf}</td>
                  <td class="px-4 py-3 text-center text-red-400">${s.revisions}</td>
                  <td class="px-4 py-3 text-center text-blue-400">${s.icf_submitted}</td>
                  <td class="px-4 py-3 text-center text-purple-400">${s.icf_review}</td>
                  <td class="px-4 py-3 text-center text-cyan-400">${s.icf_inspection}</td>
                  <td class="px-4 py-3 text-center text-emerald-400">${s.pending_payment}</td>
                  <td class="px-4 py-3 text-center font-bold">${s.total}</td>
                  <td class="px-4 py-3 text-center ${change === null ? 'text-slate-500' : change > 0 ? 'text-red-400' : change < 0 ? 'text-emerald-400' : 'text-slate-400'}">
                    ${change === null ? '‚Äî' : change > 0 ? '+' + change : change}
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderPtoNoIcf(deals) {
  const sorted = sortIcfData(deals, state.icfSortBy || 'daysSincePto', state.icfSortDir);
  const totalIncentive = deals.reduce((sum, d) => sum + parseNum(d.currentIncentive || d.finalIncentive), 0);
  return `
    <div class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-amber-400">üìã PTO'd but ICF Not Yet Submitted</h3>
      <p class="text-sm text-slate-400 mt-1">Projects with PTO completed but still in RRF stages or ICF Draft status</p>
      <div class="mt-3 flex gap-6">
        <div>
          <div class="text-2xl font-bold text-amber-400">${deals.length}</div>
          <div class="text-xs text-slate-400">projects awaiting ICF submission</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-amber-400">${fmtCurrency(totalIncentive)}</div>
          <div class="text-xs text-slate-400">total incentive</div>
        </div>
      </div>
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
      <div class="table-container overflow-x-auto" style="max-height: 600px;">
        <table class="w-full text-sm">
          <thead class="sticky-header"><tr>
            ${icfSortHeader('Customer', 'customer')}
            ${icfSortHeader('Utility', 'utility')}
            ${icfSortHeader('Install Date', 'installDate')}
            ${icfSortHeader('PTO Date', 'ptoDate')}
            ${icfSortHeader('Days Since PTO', 'daysSincePto')}
            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Current Status</th>
          </tr></thead>
          <tbody class="divide-y divide-slate-700/30">
            ${sorted.length === 0 ? '<tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">No projects in this category</td></tr>' : sorted.map(d => `
              <tr class="hover:bg-slate-800/50">
                <td class="px-3 py-2">${customerCell(d)}${d.applicationCode ? '<br><span class="text-xs text-slate-500 mono">'+d.applicationCode+'</span>' : ''}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getUtilityStyle(getUtility(d))}">${getUtility(d) || '‚Äî'}</span></td>
                <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                <td class="px-3 py-2 text-xs mono text-green-400">${d.ptoDate || '‚Äî'}</td>
                <td class="px-3 py-2 font-bold ${d.daysSincePto > 30 ? 'text-red-400' : d.daysSincePto > 14 ? 'text-amber-400' : 'text-slate-300'}">${d.daysSincePto !== null ? d.daysSincePto + 'd' : '‚Äî'}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs bg-amber-900/50 text-amber-400 border border-amber-800">${d.sgipProgress || '‚Äî'}</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderRevisions(deals) {
  const sorted = sortIcfData(deals, state.icfSortBy || 'daysSinceSuspended', state.icfSortDir);
  const totalIncentive = deals.reduce((sum, d) => sum + parseNum(d.currentIncentive || d.finalIncentive), 0);
  return `
    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-red-400">‚ö†Ô∏è Revisions Required</h3>
      <p class="text-sm text-slate-400 mt-1">Projects in ICF Suspended or ICF Inspection Suspended status</p>
      <div class="mt-3 flex gap-6">
        <div>
          <div class="text-2xl font-bold text-red-400">${deals.length}</div>
          <div class="text-xs text-slate-400">projects needing revisions</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-red-400">${fmtCurrency(totalIncentive)}</div>
          <div class="text-xs text-slate-400">total incentive</div>
        </div>
      </div>
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
      <div class="table-container overflow-x-auto" style="max-height: 600px;">
        <table class="w-full text-sm">
          <thead class="sticky-header"><tr>
            ${icfSortHeader('Customer', 'customer')}
            ${icfSortHeader('Utility', 'utility')}
            ${icfSortHeader('Install Date', 'installDate')}
            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Suspended Type</th>
            ${icfSortHeader('Suspended Date', 'icfSuspendedDate')}
            ${icfSortHeader('Days Suspended', 'daysSinceSuspended')}
          </tr></thead>
          <tbody class="divide-y divide-slate-700/30">
            ${sorted.length === 0 ? '<tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">No projects in this category</td></tr>' : sorted.map(d => `
              <tr class="hover:bg-slate-800/50">
                <td class="px-3 py-2">${customerCell(d)}${d.applicationCode ? '<br><span class="text-xs text-slate-500 mono">'+d.applicationCode+'</span>' : ''}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getUtilityStyle(getUtility(d))}">${getUtility(d) || '‚Äî'}</span></td>
                <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs ${d.suspendedType.includes('Inspection') ? 'bg-orange-900/50 text-orange-400 border border-orange-800' : 'bg-red-900/50 text-red-400 border border-red-800'}">${d.suspendedType}</span></td>
                <td class="px-3 py-2 text-xs mono">${d.icfSuspendedDate || '‚Äî'}</td>
                <td class="px-3 py-2 font-bold ${d.daysSinceSuspended > 30 ? 'text-red-400' : d.daysSinceSuspended > 14 ? 'text-amber-400' : 'text-slate-300'}">${d.daysSinceSuspended !== null ? d.daysSinceSuspended + 'd' : '‚Äî'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderIcfSubmittedDeep(deals) {
  const sorted = sortIcfData(deals, state.icfSortBy || 'daysPending', state.icfSortDir);
  const totalIncentive = deals.reduce((sum, d) => sum + parseNum(d.currentIncentive || d.finalIncentive), 0);
  return `
    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-blue-400">üì§ ICF Submitted</h3>
      <p class="text-sm text-slate-400 mt-1">Projects with ICF Submitted or ICF Resubmitted status</p>
      <div class="mt-3 flex gap-6">
        <div>
          <div class="text-2xl font-bold text-blue-400">${deals.length}</div>
          <div class="text-xs text-slate-400">projects with ICF submitted</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-blue-400">${fmtCurrency(totalIncentive)}</div>
          <div class="text-xs text-slate-400">total incentive</div>
        </div>
      </div>
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
      <div class="table-container overflow-x-auto" style="max-height: 600px;">
        <table class="w-full text-sm">
          <thead class="sticky-header"><tr>
            ${icfSortHeader('Customer', 'customer')}
            ${icfSortHeader('Utility', 'utility')}
            ${icfSortHeader('Install Date', 'installDate')}
            ${icfSortHeader('ICF Submitted', 'icfSubmittedDate')}
            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Resubmitted</th>
            ${icfSortHeader('Days Pending', 'daysPending')}
          </tr></thead>
          <tbody class="divide-y divide-slate-700/30">
            ${sorted.length === 0 ? '<tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">No projects in this category</td></tr>' : sorted.map(d => `
              <tr class="hover:bg-slate-800/50">
                <td class="px-3 py-2">${customerCell(d)}${d.applicationCode ? '<br><span class="text-xs text-slate-500 mono">'+d.applicationCode+'</span>' : ''}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getUtilityStyle(getUtility(d))}">${getUtility(d) || '‚Äî'}</span></td>
                <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                <td class="px-3 py-2 text-xs mono">${d.icfSubmittedDate || '‚Äî'}</td>
                <td class="px-3 py-2 text-xs mono">${d.icfResubmittedDate || '‚Äî'}</td>
                <td class="px-3 py-2 font-bold ${d.daysPending > 45 ? 'text-red-400' : d.daysPending > 30 ? 'text-amber-400' : 'text-slate-300'}">${d.daysPending !== null ? d.daysPending + 'd' : '‚Äî'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderIcfReview(deals) {
  const sorted = sortIcfData(deals, state.icfSortBy || 'daysSinceSubmitted', state.icfSortDir);
  const totalIncentive = deals.reduce((sum, d) => sum + parseNum(d.currentIncentive || d.finalIncentive), 0);
  return `
    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-purple-400">üîç ICF Review</h3>
      <p class="text-sm text-slate-400 mt-1">Projects in ICF Review or ICF Technical Review status</p>
      <div class="mt-3 flex gap-6">
        <div>
          <div class="text-2xl font-bold text-purple-400">${deals.length}</div>
          <div class="text-xs text-slate-400">projects under review</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-purple-400">${fmtCurrency(totalIncentive)}</div>
          <div class="text-xs text-slate-400">total incentive</div>
        </div>
      </div>
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
      <div class="table-container overflow-x-auto" style="max-height: 600px;">
        <table class="w-full text-sm">
          <thead class="sticky-header"><tr>
            ${icfSortHeader('Customer', 'customer')}
            ${icfSortHeader('Utility', 'utility')}
            ${icfSortHeader('Install Date', 'installDate')}
            <th class="px-3 py-2 text-left text-xs font-semibold text-slate-400 uppercase">Review Type</th>
            ${icfSortHeader('ICF Submitted', 'icfSubmittedDate')}
            ${icfSortHeader('Days Since Submitted', 'daysSinceSubmitted')}
          </tr></thead>
          <tbody class="divide-y divide-slate-700/30">
            ${sorted.length === 0 ? '<tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">No projects in this category</td></tr>' : sorted.map(d => `
              <tr class="hover:bg-slate-800/50">
                <td class="px-3 py-2">${customerCell(d)}${d.applicationCode ? '<br><span class="text-xs text-slate-500 mono">'+d.applicationCode+'</span>' : ''}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getUtilityStyle(getUtility(d))}">${getUtility(d) || '‚Äî'}</span></td>
                <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs ${(d.sgipProgress || '').toLowerCase().includes('technical') ? 'bg-violet-900/50 text-violet-400 border border-violet-800' : 'bg-purple-900/50 text-purple-400 border border-purple-800'}">${(d.sgipProgress || '').toLowerCase().includes('technical') ? 'Technical Review' : 'Review'}</span></td>
                <td class="px-3 py-2 text-xs mono">${d.icfResubmittedDate || d.icfSubmittedDate || '‚Äî'}</td>
                <td class="px-3 py-2 font-bold ${d.daysSinceSubmitted > 45 ? 'text-red-400' : d.daysSinceSubmitted > 30 ? 'text-amber-400' : 'text-slate-300'}">${d.daysSinceSubmitted !== null ? d.daysSinceSubmitted + 'd' : '‚Äî'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderIcfInspection(deals) {
  const sorted = sortIcfData(deals, state.icfSortBy || 'icfInspectionDate', state.icfSortDir);
  const totalIncentive = deals.reduce((sum, d) => sum + parseNum(d.currentIncentive || d.finalIncentive), 0);
  return `
    <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-cyan-400">üîé ICF Inspection</h3>
      <p class="text-sm text-slate-400 mt-1">Projects in ICF Inspection status</p>
      <div class="mt-3 flex gap-6">
        <div>
          <div class="text-2xl font-bold text-cyan-400">${deals.length}</div>
          <div class="text-xs text-slate-400">projects awaiting inspection</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-cyan-400">${fmtCurrency(totalIncentive)}</div>
          <div class="text-xs text-slate-400">total incentive</div>
        </div>
      </div>
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
      <div class="table-container overflow-x-auto" style="max-height: 600px;">
        <table class="w-full text-sm">
          <thead class="sticky-header"><tr>
            ${icfSortHeader('Customer', 'customer')}
            ${icfSortHeader('Utility', 'utility')}
            ${icfSortHeader('Install Date', 'installDate')}
            ${icfSortHeader('ICF Inspection Date', 'icfInspectionDate')}
            ${icfSortHeader('Inspection Date', 'inspectionDate')}
          </tr></thead>
          <tbody class="divide-y divide-slate-700/30">
            ${sorted.length === 0 ? '<tr><td colspan="5" class="px-3 py-8 text-center text-slate-500">No projects in this category</td></tr>' : sorted.map(d => `
              <tr class="hover:bg-slate-800/50">
                <td class="px-3 py-2">${customerCell(d)}${d.applicationCode ? '<br><span class="text-xs text-slate-500 mono">'+d.applicationCode+'</span>' : ''}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getUtilityStyle(getUtility(d))}">${getUtility(d) || '‚Äî'}</span></td>
                <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                <td class="px-3 py-2 text-xs mono">${d.icfInspectionDate || '‚Äî'}</td>
                <td class="px-3 py-2 text-xs mono text-cyan-400">${d.inspectionDate || '‚Äî'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderPendingPayment(deals) {
  const sorted = sortIcfData(deals, state.icfSortBy || 'daysSinceApproved', state.icfSortDir);
  const totalIncentive = deals.reduce((sum, d) => sum + parseNum(d.finalIncentive || d.currentIncentive), 0);
  return `
    <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-emerald-400">üí∞ Pending Payment</h3>
      <p class="text-sm text-slate-400 mt-1">Projects in ICF Pending Payment status</p>
      <div class="mt-3 flex gap-6">
        <div>
          <div class="text-2xl font-bold text-emerald-400">${deals.length}</div>
          <div class="text-xs text-slate-400">projects awaiting payment</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-emerald-400">${fmtCurrency(totalIncentive)}</div>
          <div class="text-xs text-slate-400">total incentive</div>
        </div>
      </div>
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
      <div class="table-container overflow-x-auto" style="max-height: 600px;">
        <table class="w-full text-sm">
          <thead class="sticky-header"><tr>
            ${icfSortHeader('Customer', 'customer')}
            ${icfSortHeader('Utility', 'utility')}
            ${icfSortHeader('Install Date', 'installDate')}
            ${icfSortHeader('ICF Approved Date', 'icfPendingPaymentDate')}
            ${icfSortHeader('Days', 'daysSinceApproved')}
            ${icfSortHeader('Incentive', 'incentive')}
          </tr></thead>
          <tbody class="divide-y divide-slate-700/30">
            ${sorted.length === 0 ? '<tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">No projects in this category</td></tr>' : sorted.map(d => `
              <tr class="hover:bg-slate-800/50">
                <td class="px-3 py-2">${customerCell(d)}${d.applicationCode ? '<br><span class="text-xs text-slate-500 mono">'+d.applicationCode+'</span>' : ''}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getUtilityStyle(getUtility(d))}">${getUtility(d) || '‚Äî'}</span></td>
                <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                <td class="px-3 py-2 text-xs mono">${d.icfPendingPaymentDate || '‚Äî'}</td>
                <td class="px-3 py-2 font-bold ${d.daysSinceApproved > 60 ? 'text-red-400' : d.daysSinceApproved > 30 ? 'text-amber-400' : 'text-slate-300'}">${d.daysSinceApproved !== null ? d.daysSinceApproved + 'd' : '‚Äî'}</td>
                <td class="px-3 py-2 text-right font-bold text-emerald-400">${d.finalIncentive || d.currentIncentive || '‚Äî'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderPaymentComplete(deals) {
  const sorted = sortIcfData(deals, state.icfSortBy || 'paymentCompletedDate', state.icfSortDir);
  const totalPayment = deals.reduce((sum, d) => sum + parseNum(d.paymentAmount), 0);
  return `
    <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 mb-4">
      <h3 class="font-semibold text-green-400">‚úÖ Payment Complete</h3>
      <p class="text-sm text-slate-400 mt-1">Projects with completed payments</p>
      <div class="mt-3 flex gap-6">
        <div>
          <div class="text-2xl font-bold text-green-400">${deals.length}</div>
          <div class="text-xs text-slate-400">projects paid</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-green-400">${fmtCurrency(totalPayment)}</div>
          <div class="text-xs text-slate-400">total paid</div>
        </div>
      </div>
    </div>
    <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
      <div class="table-container overflow-x-auto" style="max-height: 600px;">
        <table class="w-full text-sm">
          <thead class="sticky-header"><tr>
            ${icfSortHeader('Customer', 'customer')}
            ${icfSortHeader('Utility', 'utility')}
            ${icfSortHeader('Install Date', 'installDate')}
            ${icfSortHeader('ICF Approved Date', 'icfPendingPaymentDate')}
            ${icfSortHeader('Payment Completed Date', 'paymentCompletedDate')}
            ${icfSortHeader('Payment Amount', 'paymentAmount')}
          </tr></thead>
          <tbody class="divide-y divide-slate-700/30">
            ${sorted.length === 0 ? '<tr><td colspan="6" class="px-3 py-8 text-center text-slate-500">No projects in this category</td></tr>' : sorted.map(d => `
              <tr class="hover:bg-slate-800/50">
                <td class="px-3 py-2">${customerCell(d)}${d.applicationCode ? '<br><span class="text-xs text-slate-500 mono">'+d.applicationCode+'</span>' : ''}</td>
                <td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getUtilityStyle(getUtility(d))}">${getUtility(d) || '‚Äî'}</span></td>
                <td class="px-3 py-2 text-xs mono">${d.installDate || '‚Äî'}</td>
                <td class="px-3 py-2 text-xs mono">${d.icfPendingPaymentDate || '‚Äî'}</td>
                <td class="px-3 py-2 text-xs mono text-green-400">${d.paymentCompletedDate || '‚Äî'}</td>
                <td class="px-3 py-2 text-right font-bold text-green-400">${d.paymentAmount ? fmtCurrency(parseNum(d.paymentAmount)) : '‚Äî'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

// Password Protection
const DASHBOARD_PASSWORD = 'GoodEnergy1@';
let isAuthenticated = false;

function checkPassword(event) {
  event.preventDefault();
  const input = document.getElementById('passwordInput');
  const error = document.getElementById('passwordError');
  
  if (input.value === DASHBOARD_PASSWORD) {
    isAuthenticated = true;
    document.getElementById('loginScreen').classList.add('hidden');
    sessionStorage.setItem('haven_authenticated', 'true');
    init();
  } else {
    error.classList.remove('hidden');
    input.value = '';
    input.focus();
  }
}

async function init() {
  document.getElementById('app').innerHTML = '<div class="flex items-center justify-center h-64"><div class="text-center"><div class="text-2xl mb-2">‚ü≥</div><p class="text-slate-400">Loading...</p></div></div>';
  await Promise.all([loadCorrectionsFromSupabase(), loadSgipFromSupabase(), loadFromSupabase(), loadIcfSnapshots()]);
  mergeData();
}

// Check if already authenticated in this session
if (sessionStorage.getItem('haven_authenticated') === 'true') {
  document.getElementById('loginScreen').classList.add('hidden');
  init();
}
  </script>
</body>
</html>
