<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haven Energy - Post-Install Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    .editable { cursor: pointer; transition: all 0.15s; }
    .editable:hover { background: rgba(16, 185, 129, 0.1); border-radius: 4px; }
    .edit-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; z-index: 50; min-width: 250px; max-height: 400px; overflow-y: auto; background: #1e293b; border: 1px solid #334155; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); margin-top: 4px; }
    .dropdown:hover .dropdown-menu { display: block; }
    .checkbox-item { padding: 6px 12px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px; }
    .checkbox-item:hover { background: #334155; }
    .checkbox-item input { accent-color: #10b981; width: 16px; height: 16px; }
    .filter-active { color: #10b981 !important; }
    .table-container { max-height: calc(100vh - 380px); overflow-y: auto; }
    .sticky-header th { position: sticky; top: 0; background: #0f172a; z-index: 10; }
    .upload-zone { border: 2px dashed #475569; transition: all 0.2s; }
    .upload-zone:hover, .upload-zone.dragover { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
    .sync-btn { animation: none; }
    .sync-btn.syncing { animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
  <div id="uploadModal" class="edit-modal hidden">
    <div class="bg-slate-800 rounded-xl p-6 max-w-2xl w-full mx-4 border border-slate-700">
      <h2 class="text-xl font-bold mb-4">ðŸ“¤ Update SGIP Data</h2>
      <div>
        <h3 class="font-semibold text-emerald-400 mb-2">SGIP Data (CSV)</h3>
        <p class="text-sm text-slate-400 mb-3">HubSpot syncs automatically. Upload your SGIP CSV to merge with HubSpot data.</p>
        <div id="sgipUploadZone" class="upload-zone rounded-lg p-6 text-center cursor-pointer"
             onclick="document.getElementById('sgipFileInput').click()"
             ondragover="event.preventDefault(); this.classList.add('dragover')"
             ondragleave="this.classList.remove('dragover')"
             ondrop="event.preventDefault(); this.classList.remove('dragover'); handleSgipFile(event.dataTransfer.files[0])">
          <div class="text-3xl mb-2">ðŸ“„</div>
          <p class="text-sm text-slate-400">Drag & drop SGIP CSV here<br>or click to browse</p>
          <input type="file" id="sgipFileInput" accept=".csv" class="hidden" onchange="handleSgipFile(this.files[0])">
        </div>
        <p id="sgipStatus" class="text-xs text-slate-500 mt-2"></p>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="closeUploadModal()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Close</button>
      </div>
    </div>
  </div>

  <div id="editModal" class="edit-modal hidden">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700">
      <h3 id="editModalTitle" class="text-lg font-bold mb-4">Edit Field</h3>
      <div id="editModalContent"></div>
      <div class="flex gap-3 mt-6">
        <button onclick="saveEdit()" class="flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-medium">Save</button>
        <button onclick="closeEditModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">Cancel</button>
      </div>
    </div>
  </div>

  <div id="app">Loading...</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <script>
// Supabase config
const SUPABASE_URL = 'https://vnxerxefgodekwjdxfqc.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_BjuP0L7Bw2_903MXWqf6Ag_c5QOuB3r';
const HUBSPOT_PORTAL_ID = '23929498';

let DATA = { matched: [], hubspotWithoutSgip: [] };
let HUBSPOT_DATA = [];
let SGIP_DATA = [];
let SEARCH_INDEX = [];
let state = { 
  tab: 'matched', 
  search: '', 
  filters: { permitStatus: [], inspectionStatus: [], ptoStatus: [], sgipStage: [], sgipStatus: [], icfProgress: [], installer: [] },
  sortBy: 'daysSinceInstall', 
  sortDir: 'desc', 
  editingDeal: null, 
  editingField: null,
  syncing: false,
  lastSync: null,
  lastSgipUpdate: null
};

let searchTimeout = null;

// ============ SUPABASE FUNCTIONS ============

async function loadFromSupabase() {
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/deals?select=*`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    const deals = await response.json();
    
    if (Array.isArray(deals)) {
      HUBSPOT_DATA = deals.map(d => ({
        dealId: String(d.id),
        dealName: d.deal_name,
        customerName: parseCustomerName(d.deal_name),
        email: d.email || '',
        installDate: d.install_date,
        permitStatus: mapPermit(d.permit_status),
        ptoDate: d.pto_date,
        inspectionStatus: mapInspection(d.inspection_status),
        sgipStatusHubspot: d.sgip_status_hubspot,
        installer: d.installer
      }));
      
      // Get last sync time
      const syncResponse = await fetch(`${SUPABASE_URL}/rest/v1/sync_log?select=completed_at&order=completed_at.desc&limit=1`, {
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
      });
      const syncLog = await syncResponse.json();
      if (syncLog?.[0]?.completed_at) {
        state.lastSync = new Date(syncLog[0].completed_at).toLocaleString();
      }
      
      mergeData();
      return true;
    }
  } catch (e) {
    console.error('Failed to load from Supabase:', e);
  }
  return false;
}

async function triggerSync() {
  state.syncing = true;
  render();
  
  try {
    const response = await fetch(`${SUPABASE_URL}/functions/v1/sync-hubspot`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const result = await response.json();
    
    if (result.success) {
      state.lastSync = new Date().toLocaleString();
      await loadFromSupabase();
    } else {
      alert('Sync failed: ' + (result.error || 'Unknown error'));
    }
  } catch (e) {
    alert('Sync failed: ' + e.message);
  }
  
  state.syncing = false;
  render();
}

// ============ DATA PROCESSING ============

function parseCustomerName(dealName) {
  if (!dealName) return null;
  let name = dealName.split(':')[0].trim();
  name = name.replace(/\s*\(.*?\)\s*/g, '').trim();
  if (name.includes(',')) {
    const [last, first] = name.split(',', 2);
    return first ? `${first.trim()} ${last.trim()}` : last.trim();
  }
  return name;
}

const permitMap = { 'DONE: Permit approved': 'Approved', 'Permit Rejected': 'Rejected', 'Permit Submitted': 'Submitted', 'Permit Resubmitted': 'Resubmitted', 'Permit revisions in progress': 'Revisions in progress' };
const inspectionMap = { 'Inspection passed': 'Passed', 'Inspection failed': 'Failed', 'Inspection Scheduled': 'Scheduled', 'Inspection requested': 'Requested', 'Inspection Pending HO Action': 'Pending HO Action' };
function mapPermit(s) { return permitMap[s] || s; }
function mapInspection(s) { return inspectionMap[s] || s; }

function getIcfProgress(stage, status) {
  if (stage === "RRF") {
    if (status === "Draft") return "RRF Draft";
    if (["Submitted", "Review", "Technical Review", "Equipment Review"].includes(status)) return "RRF Under Review";
    if (["Suspended", "Resubmitted"].includes(status)) return "RRF Suspended";
    if (["Confirmed", "Reserved"].includes(status)) return "RRF Confirmed";
  } else if (stage === "ICF") {
    if (status === "Draft") return "ICF Draft";
    if (["Submitted", "Review", "Technical Review"].includes(status)) return "ICF Under Review";
    if (["Suspended", "Inspection Suspended", "Resubmitted"].includes(status)) return "ICF Suspended";
    if (status === "Inspection") return "ICF Inspection";
    if (status === "Pending Payment") return "Pending Payment";
  } else if (stage === "Payment") {
    return status === "Completed" ? "Payment Completed" : "Payment Processing";
  } else if (stage === "Cancelled") return "Cancelled";
  return "Not Started";
}

function mergeData() {
  const sgipByEmail = {};
  SGIP_DATA.forEach(s => {
    const email = (s.email || '').toLowerCase().trim();
    if (email) sgipByEmail[email] = s;
  });

  const matched = [];
  const hubspotWithoutSgip = [];

  HUBSPOT_DATA.forEach(h => {
    const email = (h.email || '').toLowerCase().trim();
    const sgip = sgipByEmail[email] || {};
    
    const record = {
      ...h,
      applicationCode: sgip.applicationCode || '',
      sgipStage: sgip.sgipStage || '',
      sgipStatus: sgip.sgipStatus || '',
      currentIncentive: sgip.currentIncentive || '',
      finalIncentive: sgip.finalIncentive || '',
      nextDueDate: sgip.nextDueDate || '',
      siteAddress: sgip.siteAddress || '',
      utility: sgip.utility || '',
      icfProgress: getIcfProgress(sgip.sgipStage || '', sgip.sgipStatus || '')
    };

    if (sgip.applicationCode) {
      matched.push(record);
    } else {
      hubspotWithoutSgip.push(record);
    }
  });

  DATA = { matched, hubspotWithoutSgip };
  buildSearchIndex();
}

function buildSearchIndex() {
  SEARCH_INDEX = DATA.matched.map((d, i) => ({
    idx: i,
    text: [d.dealName||'', d.customerName||'', d.applicationCode||'', d.email||'', d.installer||'', d.siteAddress||''].join(' ').toLowerCase()
  }));
}

// ============ FILE UPLOAD ============

function showUploadModal() {
  document.getElementById('uploadModal').classList.remove('hidden');
  document.getElementById('sgipStatus').textContent = state.lastSgipUpdate ? `Last updated: ${state.lastSgipUpdate}` : 'No SGIP data loaded yet';
}
function closeUploadModal() { document.getElementById('uploadModal').classList.add('hidden'); }

function handleSgipFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const rows = parseCSV(e.target.result);
      if (rows.length > 1) {
        const headers = rows[0];
        const emailIdx = headers.findIndex(h => h && h.toLowerCase().includes('host customer email'));
        const codeIdx = headers.findIndex(h => h && h.toLowerCase().includes('application code'));
        const stageIdx = headers.findIndex(h => h && h.toLowerCase() === 'stage');
        const statusIdx = headers.findIndex(h => h && h.toLowerCase() === 'status');
        const incentiveIdx = headers.findIndex(h => h && h.toLowerCase().includes('current incentive'));
        const finalIdx = headers.findIndex(h => h && h.toLowerCase().includes('final incentive'));
        const nextDueIdx = headers.findIndex(h => h && h.toLowerCase().includes('next due'));
        const addressIdx = headers.findIndex(h => h && h.toLowerCase().includes('site address'));
        const utilityIdx = headers.findIndex(h => h && h.toLowerCase().includes('electric utility'));

        SGIP_DATA = [];
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          const email = (row[emailIdx] || '').toLowerCase().trim();
          if (email) {
            SGIP_DATA.push({
              email,
              applicationCode: row[codeIdx] || '',
              sgipStage: row[stageIdx] || '',
              sgipStatus: row[statusIdx] || '',
              currentIncentive: row[incentiveIdx] || '',
              finalIncentive: row[finalIdx] || '',
              nextDueDate: row[nextDueIdx] || '',
              siteAddress: row[addressIdx] || '',
              utility: row[utilityIdx] || ''
            });
          }
        }
        
        state.lastSgipUpdate = new Date().toLocaleString();
        document.getElementById('sgipStatus').innerHTML = `<span class="text-emerald-400">âœ“ Loaded ${SGIP_DATA.length} SGIP records</span>`;
        mergeData();
        render();
      }
    } catch (err) {
      document.getElementById('sgipStatus').innerHTML = `<span class="text-red-400">Error: ${err.message}</span>`;
    }
  };
  reader.readAsText(file);
}

function parseCSV(text) {
  const lines = text.split('\n');
  const result = [];
  for (let line of lines) {
    const row = [];
    let inQuote = false, cell = '';
    for (let c of line) {
      if (c === '"') inQuote = !inQuote;
      else if (c === ',' && !inQuote) { row.push(cell.trim()); cell = ''; }
      else cell += c;
    }
    row.push(cell.trim());
    if (row.some(c => c)) result.push(row);
  }
  return result;
}

// ============ UI HELPERS ============

const STAGES = [
  { key: 'Not Started', label: 'Not Started', color: '#64748b', stage: 0 },
  { key: 'RRF Draft', label: 'RRF Draft', color: '#f59e0b', stage: 1 },
  { key: 'RRF Under Review', label: 'RRF Review', color: '#3b82f6', stage: 1 },
  { key: 'RRF Suspended', label: 'RRF Suspended', color: '#ef4444', stage: 1 },
  { key: 'RRF Confirmed', label: 'RRF Confirmed', color: '#10b981', stage: 2 },
  { key: 'ICF Draft', label: 'ICF Draft', color: '#f59e0b', stage: 3 },
  { key: 'ICF Under Review', label: 'ICF Review', color: '#3b82f6', stage: 3 },
  { key: 'ICF Suspended', label: 'ICF Suspended', color: '#ef4444', stage: 3 },
  { key: 'ICF Inspection', label: 'ICF Inspection', color: '#8b5cf6', stage: 4 },
  { key: 'Pending Payment', label: 'Pending Payment', color: '#06b6d4', stage: 4 },
  { key: 'Payment Completed', label: 'Paid', color: '#22c55e', stage: 5 },
];

const getStageInfo = k => STAGES.find(s => s.key === k) || STAGES[0];
const parseNum = v => v ? parseFloat(String(v).replace(/[$,]/g, '')) || 0 : 0;
const fmtCurrency = v => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(v);
const getDaysSince = d => { if (!d || d === 'None') return null; try { return Math.floor((new Date() - new Date(d)) / 86400000); } catch { return null; } };
const parseDate = d => { if (!d || d === 'None' || d === '(No value)') return null; try { if (String(d).includes('/')) { const [m, day, y] = String(d).split('/'); return new Date(2000 + parseInt(y), parseInt(m) - 1, parseInt(day)); } return new Date(d); } catch { return null; } };
const getHubSpotUrl = id => id ? `https://app.hubspot.com/contacts/${HUBSPOT_PORTAL_ID}/deal/${id}` : null;

function getFilterCounts(field, transform = v => v) {
  const counts = {};
  DATA.matched.forEach(d => { let val = transform(d[field]); if (!val || val === '(No value)' || val === 'None') val = '(empty)'; counts[val] = (counts[val] || 0) + 1; });
  return Object.entries(counts).sort((a,b) => b[1] - a[1]);
}

function getFilteredData() {
  let indices = state.search ? SEARCH_INDEX.filter(s => s.text.includes(state.search.toLowerCase())).map(s => s.idx) : DATA.matched.map((_, i) => i);
  let r = indices.map(i => ({ ...DATA.matched[i], _index: i, daysSinceInstall: getDaysSince(DATA.matched[i].installDate) }));
  
  if (state.filters.permitStatus.length > 0) r = r.filter(d => state.filters.permitStatus.includes(d.permitStatus || '(empty)') || (!d.permitStatus && state.filters.permitStatus.includes('(empty)')));
  if (state.filters.inspectionStatus.length > 0) r = r.filter(d => { let v = d.inspectionStatus; if (!v || v === '(No value)') v = '(empty)'; return state.filters.inspectionStatus.includes(v); });
  if (state.filters.ptoStatus.length > 0) r = r.filter(d => { const has = d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None'; return state.filters.ptoStatus.includes(has ? 'Complete' : 'Pending'); });
  if (state.filters.sgipStage.length > 0) r = r.filter(d => state.filters.sgipStage.includes(d.sgipStage || '(empty)'));
  if (state.filters.sgipStatus.length > 0) r = r.filter(d => state.filters.sgipStatus.includes(d.sgipStatus || '(empty)'));
  if (state.filters.icfProgress.length > 0) r = r.filter(d => state.filters.icfProgress.includes(d.icfProgress));
  if (state.filters.installer.length > 0) r = r.filter(d => { let v = d.installer; if (!v || v === '(No value)') v = '(empty)'; return state.filters.installer.includes(v); });

  r.sort((a, b) => {
    let av, bv;
    if (state.sortBy === 'daysSinceInstall') { av = a.daysSinceInstall ?? -1; bv = b.daysSinceInstall ?? -1; }
    else if (state.sortBy === 'installDate') { const da = parseDate(a.installDate), db = parseDate(b.installDate); av = da ? da.getTime() : (state.sortDir === 'asc' ? Infinity : -Infinity); bv = db ? db.getTime() : (state.sortDir === 'asc' ? Infinity : -Infinity); }
    else if (state.sortBy === 'incentive') { av = parseNum(a.currentIncentive); bv = parseNum(b.currentIncentive); }
    else if (state.sortBy === 'name') { av = a.customerName || ''; bv = b.customerName || ''; }
    else if (state.sortBy === 'stage') { av = getStageInfo(a.icfProgress).stage; bv = getStageInfo(b.icfProgress).stage; }
    else if (state.sortBy === 'nextDue') { const da = parseDate(a.nextDueDate), db = parseDate(b.nextDueDate); av = da ? da.getTime() : (state.sortDir === 'asc' ? Infinity : -Infinity); bv = db ? db.getTime() : (state.sortDir === 'asc' ? Infinity : -Infinity); }
    if (typeof av === 'string') return state.sortDir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
    return state.sortDir === 'asc' ? av - bv : bv - av;
  });
  return r;
}

function getStats() {
  const m = DATA.matched;
  return { total: m.length, paid: m.filter(d => d.icfProgress === 'Payment Completed').length, suspended: m.filter(d => (d.icfProgress || '').includes('Suspended')).length, totalIncentive: m.reduce((s, d) => s + parseNum(d.currentIncentive), 0), paidIncentive: m.filter(d => d.icfProgress === 'Payment Completed').reduce((s, d) => s + parseNum(d.finalIncentive), 0), ptoComplete: m.filter(d => d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None').length, permitted: m.filter(d => d.permitStatus === 'Approved').length, noSgip: DATA.hubspotWithoutSgip.length };
}

const getPermitStyle = s => { if (!s) return 'bg-slate-800 text-slate-500 border-slate-700'; if (s === 'Approved') return 'bg-green-900/50 text-green-400 border-green-800'; if (s === 'Rejected') return 'bg-red-900/50 text-red-400 border-red-800'; if (s === 'Submitted' || s === 'Resubmitted') return 'bg-blue-900/50 text-blue-400 border-blue-800'; return 'bg-amber-900/50 text-amber-400 border-amber-800'; };
const getInspectionStyle = s => { if (!s || s === '(No value)') return 'bg-slate-800 text-slate-500 border-slate-700'; if (s === 'Passed') return 'bg-green-900/50 text-green-400 border-green-800'; if (s === 'Failed' || (s && s.includes('Needed')) || s === 'Pending HO Action') return 'bg-red-900/50 text-red-400 border-red-800'; if (s === 'Scheduled' || s === 'Requested') return 'bg-blue-900/50 text-blue-400 border-blue-800'; return 'bg-amber-900/50 text-amber-400 border-amber-800'; };
const getPTOStyle = d => (!d || d === '(No value)' || d === 'None') ? 'bg-slate-800 text-slate-500 border-slate-700' : 'bg-green-900/50 text-green-400 border-green-800';
const getDaysColor = d => d === null ? 'text-slate-600' : d > 90 ? 'text-red-400' : d > 60 ? 'text-amber-400' : d > 30 ? 'text-yellow-400' : 'text-slate-300';

function setTab(t) { state.tab = t; state.search = ''; render(); }
function updateSearch(v) { state.search = v; if (searchTimeout) clearTimeout(searchTimeout); searchTimeout = setTimeout(() => render(), 150); }
function setSort(col) { if (state.sortBy === col) state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc'; else { state.sortBy = col; state.sortDir = 'desc'; } render(); }
function toggleFilter(key, val) { const idx = state.filters[key].indexOf(val); if (idx >= 0) state.filters[key].splice(idx, 1); else state.filters[key].push(val); render(); }
function selectAllFilter(key, options) { state.filters[key] = options.map(o => o[0]); render(); }
function clearFilterKey(key) { state.filters[key] = []; render(); }
function clearFilters() { Object.keys(state.filters).forEach(k => state.filters[k] = []); state.search = ''; render(); }
function hasActiveFilters() { return state.search || Object.values(state.filters).some(v => v.length > 0); }

const PERMIT_OPTIONS = ['Approved', 'Rejected', 'Submitted', 'Resubmitted', 'Revisions in progress'];
const INSPECTION_OPTIONS = ['Passed', 'Failed', 'Scheduled', 'Requested', 'Pending HO Action'];

function openEditModal(idx, field) {
  const deal = getFilteredData()[idx];
  state.editingDeal = idx; state.editingField = field;
  const modal = document.getElementById('editModal');
  document.getElementById('editModalTitle').textContent = `Edit ${field === 'inspectionStatus' ? 'Inspection' : field === 'permitStatus' ? 'Permit' : 'PTO'}`;
  let html = '';
  if (field === 'inspectionStatus') html = `<select id="editValue" class="w-full px-4 py-2 rounded-lg bg-slate-900 border border-slate-700">${INSPECTION_OPTIONS.map(o => `<option ${deal.inspectionStatus === o ? 'selected' : ''}>${o}</option>`).join('')}</select>`;
  else if (field === 'permitStatus') html = `<select id="editValue" class="w-full px-4 py-2 rounded-lg bg-slate-900 border border-slate-700">${PERMIT_OPTIONS.map(o => `<option ${deal.permitStatus === o ? 'selected' : ''}>${o}</option>`).join('')}</select>`;
  else if (field === 'ptoDate') html = `<input type="date" id="editValue" class="w-full px-4 py-2 rounded-lg bg-slate-900 border border-slate-700" value="${deal.ptoDate || ''}">`;
  html += `<p class="text-xs text-slate-500 mt-2">${deal.customerName || deal.dealName}</p>`;
  document.getElementById('editModalContent').innerHTML = html;
  modal.classList.remove('hidden');
}
function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }
function saveEdit() {
  const val = document.getElementById('editValue').value;
  const deal = getFilteredData()[state.editingDeal];
  const idx = DATA.matched.findIndex(d => d.email === deal.email && d.dealName === deal.dealName);
  if (idx >= 0) DATA.matched[idx][state.editingField] = val;
  buildSearchIndex(); closeEditModal(); render();
}

function filterHeader(label, filterKey, sortKey, options, editable = false) {
  const cnt = state.filters[filterKey].length;
  const isFiltered = cnt > 0;
  const isSorted = state.sortBy === sortKey;
  return `<th class="px-2 py-3 text-left text-xs font-semibold uppercase"><div class="dropdown"><span class="cursor-pointer hover:text-slate-200 ${isFiltered ? 'filter-active' : 'text-slate-400'}">${label}${isSorted ? (state.sortDir === 'asc' ? ' â†‘' : ' â†“') : ''}${isFiltered ? ` (${cnt})` : ''}${editable ? ' âœŽ' : ''}<svg class="w-3 h-3 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></span><div class="dropdown-menu" onclick="event.stopPropagation()">${sortKey ? `<div class="p-2 border-b border-slate-700"><div class="text-[10px] text-slate-500 uppercase mb-1">Sort</div><div class="dropdown-item rounded ${isSorted && state.sortDir === 'desc' ? 'active' : ''}" onclick="setSort('${sortKey}')">Highest First</div><div class="dropdown-item rounded ${isSorted && state.sortDir === 'asc' ? 'active' : ''}" onclick="state.sortBy='${sortKey}';state.sortDir='asc';render();">Lowest First</div></div>` : ''}<div class="p-2"><div class="flex justify-between items-center mb-2"><div class="text-[10px] text-slate-500 uppercase">Filter</div><div class="flex gap-1"><button onclick="selectAllFilter('${filterKey}',${JSON.stringify(options).replace(/"/g,'&quot;')})" class="text-[10px] px-2 py-0.5 bg-slate-700 hover:bg-slate-600 rounded">All</button><button onclick="clearFilterKey('${filterKey}')" class="text-[10px] px-2 py-0.5 bg-slate-700 hover:bg-slate-600 rounded">None</button></div></div>${options.map(([v,c]) => `<label class="checkbox-item rounded"><input type="checkbox" ${state.filters[filterKey].includes(v) ? 'checked' : ''} onchange="toggleFilter('${filterKey}','${v.replace(/'/g,"\\'")}')"><span class="flex-1">${v.length > 25 ? v.slice(0,23)+'..' : v}</span><span class="text-slate-500">(${c})</span></label>`).join('')}</div></div></div></th>`;
}

function customerCell(d) {
  const url = getHubSpotUrl(d.dealId);
  const name = d.customerName || d.dealName || 'â€”';
  return url ? `<a href="${url}" target="_blank" class="font-medium text-cyan-400 hover:text-cyan-300 hover:underline">${name}</a>` : `<span class="font-medium">${name}</span>`;
}

function render() {
  const stats = getStats();
  const filtered = state.tab === 'matched' ? getFilteredData() : DATA.hubspotWithoutSgip;
  const stageCounts = {}; DATA.matched.forEach(d => stageCounts[d.icfProgress] = (stageCounts[d.icfProgress] || 0) + 1);
  const activeStages = STAGES.filter(s => stageCounts[s.key] > 0);

  const permitOpts = getFilterCounts('permitStatus');
  const inspectOpts = getFilterCounts('inspectionStatus', v => (!v || v === '(No value)') ? '(empty)' : v);
  const ptoOpts = [['Complete', DATA.matched.filter(d => d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None').length], ['Pending', DATA.matched.filter(d => !d.ptoDate || d.ptoDate === '(No value)' || d.ptoDate === 'None').length]];
  const sgipStageOpts = getFilterCounts('sgipStage', v => v || '(empty)');
  const sgipStatusOpts = getFilterCounts('sgipStatus', v => v || '(empty)');
  const icfOpts = STAGES.filter(s => stageCounts[s.key] > 0).map(s => [s.key, stageCounts[s.key]]);
  const installerOpts = getFilterCounts('installer', v => (!v || v === '(No value)') ? '(empty)' : v);

  document.getElementById('app').innerHTML = `
    <div class="bg-slate-800/80 border-b border-slate-700/50 sticky top-0 z-30">
      <div class="max-w-[1920px] mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-emerald-500 to-cyan-500 flex items-center justify-center"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div>
          <div><h1 class="text-lg font-bold bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">Haven Energy</h1><p class="text-xs text-slate-400">Post-Install Portal</p></div>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="triggerSync()" class="sync-btn ${state.syncing ? 'syncing' : ''} px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-500 rounded-lg font-medium" ${state.syncing ? 'disabled' : ''}>${state.syncing ? 'âŸ³ Syncing...' : 'âŸ³ Sync HubSpot'}</button>
          <button onclick="showUploadModal()" class="px-3 py-1.5 text-xs bg-emerald-600 hover:bg-emerald-500 rounded-lg font-medium">ðŸ“¤ Upload SGIP</button>
          ${state.lastSync ? `<span class="text-xs text-slate-500">Last sync: ${state.lastSync}</span>` : ''}
        </div>
      </div>
    </div>
    <div class="max-w-[1920px] mx-auto px-4 py-4">
      <div class="flex gap-2 mb-4">
        <button onclick="setTab('matched')" class="px-4 py-2 rounded-lg text-sm font-medium ${state.tab === 'matched' ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/40' : 'bg-slate-800/50 text-slate-400 border border-slate-700/50'}">Matched (${DATA.matched.length})</button>
        <button onclick="setTab('noSgip')" class="px-4 py-2 rounded-lg text-sm font-medium ${state.tab === 'noSgip' ? 'bg-amber-500/20 text-amber-400 border border-amber-500/40' : 'bg-slate-800/50 text-slate-400 border border-slate-700/50'}">HubSpot Without SGIP (${DATA.hubspotWithoutSgip.length})</button>
      </div>
      ${state.tab === 'matched' ? `
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2 mb-4">
          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Total</p><p class="text-lg font-bold">${stats.total}</p></div>
          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Permitted</p><p class="text-lg font-bold">${stats.permitted}</p></div>
          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">PTO Done</p><p class="text-lg font-bold">${stats.ptoComplete}</p></div>
          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Pipeline</p><p class="text-lg font-bold">${fmtCurrency(stats.totalIncentive)}</p></div>
          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Paid</p><p class="text-lg font-bold text-emerald-400">${fmtCurrency(stats.paidIncentive)}</p></div>
          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Suspended</p><p class="text-lg font-bold text-red-400">${stats.suspended}</p></div>
          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">No SGIP</p><p class="text-lg font-bold text-amber-400">${stats.noSgip}</p></div>
        </div>
        ${activeStages.length > 0 ? `<div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50 mb-4"><div class="flex rounded overflow-hidden h-6 bg-slate-900">${activeStages.map(s => { const cnt = stageCounts[s.key] || 0, pct = (cnt / DATA.matched.length) * 100; return pct < 0.5 ? '' : `<div style="width:${pct}%;background:${s.color};min-width:18px" class="flex items-center justify-center text-white text-xs font-bold">${cnt}</div>`; }).join('')}</div><div class="flex flex-wrap gap-2 mt-2">${activeStages.map(s => `<span class="flex items-center gap-1 text-xs"><span class="w-2 h-2 rounded-full" style="background:${s.color}"></span><span class="text-slate-500">${s.label}</span></span>`).join('')}</div></div>` : ''}
        <div class="flex flex-wrap gap-3 mb-4 items-center">
          <input type="text" placeholder="Search customer, code, email, installer..." class="flex-1 min-w-[250px] max-w-md px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm" value="${state.search}" oninput="updateSearch(this.value)">
          ${hasActiveFilters() ? `<button onclick="clearFilters()" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm font-medium">âœ• Clear Filters</button>` : ''}
        </div>
        <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
          <div class="px-3 py-2 border-b border-slate-700/50 text-sm"><span class="font-semibold">${filtered.length}</span> deals ${hasActiveFilters() ? '<span class="text-emerald-400">(filtered)</span>' : ''} <span class="text-slate-500 text-xs ml-2">â€¢ Click name to open HubSpot</span></div>
          <div class="table-container overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="sticky-header"><tr>
                <th class="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer" onclick="setSort('name')">Customer ${state.sortBy === 'name' ? (state.sortDir === 'asc' ? 'â†‘' : 'â†“') : ''}</th>
                <th class="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer" onclick="setSort('installDate')">Install ${state.sortBy === 'installDate' ? (state.sortDir === 'asc' ? 'â†‘' : 'â†“') : ''}</th>
                <th class="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer" onclick="setSort('daysSinceInstall')">Days ${state.sortBy === 'daysSinceInstall' ? (state.sortDir === 'asc' ? 'â†‘' : 'â†“') : ''}</th>
                ${filterHeader('Permit', 'permitStatus', null, permitOpts, true)}
                ${filterHeader('Inspection', 'inspectionStatus', null, inspectOpts, true)}
                ${filterHeader('PTO', 'ptoStatus', null, ptoOpts, true)}
                ${filterHeader('SGIP Stage', 'sgipStage', null, sgipStageOpts)}
                ${filterHeader('SGIP Status', 'sgipStatus', null, sgipStatusOpts)}
                ${filterHeader('ICF Progress', 'icfProgress', 'stage', icfOpts)}
                <th class="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer" onclick="setSort('nextDue')">Next Due ${state.sortBy === 'nextDue' ? (state.sortDir === 'asc' ? 'â†‘' : 'â†“') : ''}</th>
                <th class="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer" onclick="setSort('incentive')">Incentive ${state.sortBy === 'incentive' ? (state.sortDir === 'asc' ? 'â†‘' : 'â†“') : ''}</th>
                ${filterHeader('Installer', 'installer', null, installerOpts)}
              </tr></thead>
              <tbody class="divide-y divide-slate-700/30">${filtered.length === 0 ? '<tr><td colspan="12" class="p-8 text-center text-slate-500">No deals found. Click "Sync HubSpot" and upload SGIP CSV.</td></tr>' : filtered.map((d, i) => {
                const info = getStageInfo(d.icfProgress);
                return `<tr class="hover:bg-slate-800/50">
                  <td class="px-2 py-2"><div class="min-w-[150px]">${customerCell(d)}${d.applicationCode?`<br><span class="text-xs text-slate-500 mono">${d.applicationCode}</span>`:''}</div></td>
                  <td class="px-2 py-2 text-xs mono">${d.installDate||'â€”'}</td>
                  <td class="px-2 py-2"><span class="font-semibold ${getDaysColor(d.daysSinceInstall)}">${d.daysSinceInstall!==null?d.daysSinceInstall+'d':'â€”'}</span></td>
                  <td class="px-2 py-2"><span class="editable px-1.5 py-0.5 rounded text-xs border ${getPermitStyle(d.permitStatus)}" onclick="openEditModal(${i},'permitStatus')">${d.permitStatus||'â€”'}</span></td>
                  <td class="px-2 py-2"><span class="editable px-1.5 py-0.5 rounded text-xs border ${getInspectionStyle(d.inspectionStatus)}" onclick="openEditModal(${i},'inspectionStatus')">${d.inspectionStatus&&d.inspectionStatus!=='(No value)'?d.inspectionStatus:'â€”'}</span></td>
                  <td class="px-2 py-2"><span class="editable px-1.5 py-0.5 rounded text-xs border ${getPTOStyle(d.ptoDate)}" onclick="openEditModal(${i},'ptoDate')">${d.ptoDate&&d.ptoDate!=='(No value)'&&d.ptoDate!=='None'?d.ptoDate:'Pending'}</span></td>
                  <td class="px-2 py-2 text-xs">${d.sgipStage||'â€”'}</td>
                  <td class="px-2 py-2 text-xs text-slate-400">${d.sgipStatus||'â€”'}</td>
                  <td class="px-2 py-2"><span class="px-1.5 py-0.5 rounded text-xs font-medium" style="background:${info.color}20;color:${info.color}">${info.label}</span></td>
                  <td class="px-2 py-2 text-xs mono">${d.nextDueDate||'â€”'}</td>
                  <td class="px-2 py-2 text-right"><span class="${d.icfProgress==='Payment Completed'?'text-emerald-400':'text-slate-300'}">${d.currentIncentive||'â€”'}</span></td>
                  <td class="px-2 py-2 text-xs text-slate-400">${d.installer||'â€”'}</td>
                </tr>`;
              }).join('')}</tbody>
            </table>
          </div>
        </div>
      ` : `
        <div class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 mb-4"><h3 class="font-semibold text-amber-400">HubSpot Installs Without SGIP Match</h3><p class="text-sm text-slate-400 mt-1">${DATA.hubspotWithoutSgip.length} deals - upload SGIP CSV to match by email.</p></div>
        <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
          <div class="table-container overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="sticky-header"><tr><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Customer</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Email</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Install</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Permit</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Inspection</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Installer</th></tr></thead>
              <tbody class="divide-y divide-slate-700/30">${filtered.map(d => `<tr class="hover:bg-slate-800/50"><td class="px-3 py-2">${customerCell(d)}</td><td class="px-3 py-2 text-xs mono text-slate-400">${d.email||'â€”'}</td><td class="px-3 py-2 mono text-xs">${d.installDate||'â€”'}</td><td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getPermitStyle(d.permitStatus)}">${d.permitStatus||'â€”'}</span></td><td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getInspectionStyle(d.inspectionStatus)}">${d.inspectionStatus||'â€”'}</span></td><td class="px-3 py-2 text-xs text-slate-400">${d.installer||'â€”'}</td></tr>`).join('')}</tbody>
            </table>
          </div>
        </div>
      `}
    </div>
  `;
}

// Initialize
async function init() {
  document.getElementById('app').innerHTML = '<div class="flex items-center justify-center h-64"><div class="text-center"><div class="text-2xl mb-2">âŸ³</div><p class="text-slate-400">Loading from Supabase...</p></div></div>';
  await loadFromSupabase();
  render();
}

init();
  </script>
</body>
</html>
