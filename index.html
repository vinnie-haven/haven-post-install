<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haven Energy - Post-Install Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    .edit-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; z-index: 50; min-width: 250px; max-height: 400px; overflow-y: auto; background: #1e293b; border: 1px solid #334155; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); margin-top: 4px; }
    .dropdown:hover .dropdown-menu { display: block; }
    .checkbox-item { padding: 6px 12px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px; }
    .checkbox-item:hover { background: #334155; }
    .checkbox-item input { accent-color: #10b981; width: 16px; height: 16px; }
    .filter-active { color: #10b981 !important; }
    .table-container { max-height: calc(100vh - 380px); overflow-y: auto; }
    .sticky-header th { position: sticky; top: 0; background: #0f172a; z-index: 10; }
    .upload-zone { border: 2px dashed #475569; transition: all 0.2s; min-height: 80px; }
    .upload-zone:hover, .upload-zone.dragover { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
    .editable { cursor: pointer; transition: all 0.15s; }
    .editable:hover { background: rgba(16, 185, 129, 0.1); border-radius: 4px; }
    .sync-btn.syncing { animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
  <div id="uploadModal" class="edit-modal hidden">
    <div class="bg-slate-800 rounded-xl p-6 max-w-lg w-full mx-4 border border-slate-700">
      <h2 class="text-xl font-bold mb-4">üì§ Update SGIP Data</h2>
      <p class="text-sm text-slate-400 mb-3">Upload a new SGIP export to replace the saved data.</p>
      
      <div class="mb-4">
        <h3 class="font-semibold text-cyan-400 mb-2">SGIP Export (CSV)</h3>
        <div id="sgipUploadZone" class="upload-zone rounded-lg p-3 text-center cursor-pointer flex flex-col items-center justify-center">
          <p class="text-xs text-slate-400">Drop SGIP .csv here</p>
        </div>
        <p id="sgipStatus" class="text-xs text-slate-500 mt-1"></p>
      </div>
      
      <div id="matchStats" class="p-3 bg-slate-900 rounded-lg text-xs hidden">
        <div class="font-semibold mb-1">Match Statistics:</div>
        <div id="matchStatsContent"></div>
      </div>
      
      <div class="flex gap-3 mt-4">
        <button onclick="closeUploadModal()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Close</button>
      </div>
    </div>
  </div>

  <div id="correctionModal" class="edit-modal hidden">
    <div class="bg-slate-800 rounded-xl p-6 max-w-lg w-full mx-4 border border-slate-700">
      <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Manage Corrections</h2>
      <p class="text-sm text-slate-400 mb-3">Upload a correction sheet to permanently save manual matches and exclusions.</p>
      
      <div id="currentCorrections" class="mb-4 p-3 bg-slate-900 rounded-lg text-xs">
        <div class="font-semibold mb-1">Current Corrections in Database:</div>
        <div id="correctionCounts"></div>
      </div>
      
      <div class="mb-4">
        <h3 class="font-semibold text-amber-400 mb-2">Upload New Corrections (Excel)</h3>
        <p class="text-xs text-slate-400 mb-2">Columns: Email, SGIP Status (code, "Not in SGIP portal", or "Not an SGIP project")</p>
        <div id="correctionUploadZone" class="upload-zone rounded-lg p-3 text-center cursor-pointer flex flex-col items-center justify-center">
          <p class="text-xs text-slate-400">Drop correction .xlsx here</p>
        </div>
        <p id="correctionUploadStatus" class="text-xs text-slate-500 mt-1"></p>
      </div>
      
      <div class="flex gap-3 mt-4">
        <button onclick="closeCorrectionModal()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Close</button>
      </div>
    </div>
  </div>

  <div id="editModal" class="edit-modal hidden">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700">
      <h3 id="editModalTitle" class="text-lg font-bold mb-4">Edit Field</h3>
      <div id="editModalContent"></div>
      <div class="flex gap-3 mt-6">
        <button onclick="saveEdit()" class="flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-medium">Save</button>
        <button onclick="closeEditModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">Cancel</button>
      </div>
    </div>
  </div>

  <div id="app">Loading...</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <script>
// Supabase config
const SUPABASE_URL = 'https://vnxerxefgodekwjdxfqc.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_BjuP0L7Bw2_903MXWqf6Ag_c5QOuB3r';
const HUBSPOT_PORTAL_ID = '23929498';

let DATA = { matched: [], hubspotWithoutSgip: [] };
let HUBSPOT_DATA = [];
let SGIP_DATA = [];
let CORRECTIONS = { manualMatches: {}, notInSgip: new Set(), notSgipProject: new Set() };
let SEARCH_INDEX = [];
let MATCH_STATS = { byEmail: 0, byAddress: 0, byManual: 0, noMatch: 0, excluded: 0 };
let state = { 
  tab: 'matched', 
  search: '', 
  filters: { permitStatus: [], inspectionStatus: [], ptoStatus: [], sgipStage: [], sgipStatus: [], icfProgress: [], installer: [] },
  sortBy: 'daysSinceInstall', 
  sortDir: 'desc', 
  editingDeal: null, 
  editingField: null,
  syncing: false,
  lastSync: null,
  sgipLoaded: false,
  sgipLastUpdated: null
};

let searchTimeout = null;

// ============ SUPABASE FUNCTIONS ============

async function loadSgipFromSupabase() {
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/sgip_applications?select=*`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    const applications = await response.json();
    
    if (Array.isArray(applications) && applications.length > 0) {
      SGIP_DATA = applications.map(a => ({
        email: (a.email || '').toLowerCase().trim(),
        applicationCode: a.application_code || '',
        sgipStage: a.stage || '',
        sgipStatus: a.status || '',
        currentIncentive: a.current_incentive || '',
        finalIncentive: a.final_incentive || '',
        nextDueDate: a.next_due_date || '',
        siteAddress: a.site_address || '',
        utility: a.utility || ''
      }));
      
      state.sgipLoaded = true;
      
      // Get last updated time
      const maxUpdated = applications.reduce((max, a) => {
        const t = new Date(a.updated_at).getTime();
        return t > max ? t : max;
      }, 0);
      if (maxUpdated) {
        state.sgipLastUpdated = new Date(maxUpdated).toLocaleString();
      }
      
      console.log('SGIP loaded from Supabase:', SGIP_DATA.length, 'records');
      return true;
    }
  } catch (e) {
    console.error('Failed to load SGIP from Supabase:', e);
  }
  return false;
}

async function saveSgipToSupabase(sgipData) {
  if (!sgipData || sgipData.length === 0) return false;
  
  const records = sgipData.map(s => ({
    application_code: s.applicationCode,
    email: s.email,
    stage: s.sgipStage,
    status: s.sgipStatus,
    current_incentive: s.currentIncentive,
    final_incentive: s.finalIncentive,
    next_due_date: s.nextDueDate,
    site_address: s.siteAddress,
    utility: s.utility,
    updated_at: new Date().toISOString()
  })).filter(r => r.application_code); // Must have application code
  
  if (records.length === 0) return false;
  
  try {
    // Delete all existing records first
    await fetch(`${SUPABASE_URL}/rest/v1/sgip_applications?application_code=neq.IMPOSSIBLE`, {
      method: 'DELETE',
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    
    // Insert in batches of 500
    for (let i = 0; i < records.length; i += 500) {
      const batch = records.slice(i, i + 500);
      const response = await fetch(`${SUPABASE_URL}/rest/v1/sgip_applications`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'resolution=merge-duplicates'
        },
        body: JSON.stringify(batch)
      });
      
      if (!response.ok) {
        const err = await response.text();
        console.error('Failed to save SGIP batch:', err);
        return false;
      }
    }
    
    state.sgipLastUpdated = new Date().toLocaleString();
    console.log('Saved', records.length, 'SGIP records to Supabase');
    return true;
  } catch (e) {
    console.error('Failed to save SGIP:', e);
    return false;
  }
}

async function loadCorrectionsFromSupabase() {
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/corrections?select=*`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    const corrections = await response.json();
    
    if (Array.isArray(corrections)) {
      CORRECTIONS = { manualMatches: {}, notInSgip: new Set(), notSgipProject: new Set() };
      
      corrections.forEach(c => {
        const email = c.email.toLowerCase().trim();
        if (c.correction_type === 'manual_match' && c.sgip_code) {
          CORRECTIONS.manualMatches[email] = c.sgip_code;
        } else if (c.correction_type === 'not_in_portal') {
          CORRECTIONS.notInSgip.add(email);
        } else if (c.correction_type === 'not_sgip_project') {
          CORRECTIONS.notSgipProject.add(email);
        }
      });
      
      console.log('Corrections loaded:', Object.keys(CORRECTIONS.manualMatches).length, 'manual,', 
                  CORRECTIONS.notInSgip.size, 'not in portal,', CORRECTIONS.notSgipProject.size, 'excluded');
      return true;
    }
  } catch (e) {
    console.error('Failed to load corrections:', e);
  }
  return false;
}

async function saveCorrectionsToSupabase(newCorrections) {
  const records = [];
  
  for (const [email, code] of Object.entries(newCorrections.manualMatches)) {
    records.push({ email: email.toLowerCase().trim(), correction_type: 'manual_match', sgip_code: code });
  }
  for (const email of newCorrections.notInSgip) {
    records.push({ email: email.toLowerCase().trim(), correction_type: 'not_in_portal', sgip_code: null });
  }
  for (const email of newCorrections.notSgipProject) {
    records.push({ email: email.toLowerCase().trim(), correction_type: 'not_sgip_project', sgip_code: null });
  }
  
  if (records.length === 0) return false;
  
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/corrections`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'resolution=merge-duplicates'
      },
      body: JSON.stringify(records)
    });
    
    if (response.ok) {
      console.log('Saved', records.length, 'corrections');
      return true;
    }
  } catch (e) {
    console.error('Failed to save corrections:', e);
  }
  return false;
}

async function loadFromSupabase() {
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/deals?select=*`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    const deals = await response.json();
    
    if (Array.isArray(deals)) {
      HUBSPOT_DATA = deals.map(d => ({
        dealId: String(d.id),
        dealName: d.deal_name,
        customerName: parseCustomerName(d.deal_name),
        email: (d.email || '').toLowerCase().trim(),
        installDate: d.install_date,
        permitStatus: mapPermit(d.permit_status),
        ptoDate: d.pto_date,
        inspectionStatus: mapInspection(d.inspection_status),
        sgipStatusHubspot: d.sgip_status_hubspot,
        installer: d.installer
      }));
      
      const syncResponse = await fetch(`${SUPABASE_URL}/rest/v1/sync_log?select=completed_at&order=completed_at.desc&limit=1`, {
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
      });
      const syncLog = await syncResponse.json();
      if (syncLog?.[0]?.completed_at) {
        state.lastSync = new Date(syncLog[0].completed_at).toLocaleString();
      }
      
      return true;
    }
  } catch (e) {
    console.error('Failed to load from Supabase:', e);
  }
  return false;
}

async function triggerSync() {
  state.syncing = true;
  render();
  
  try {
    const response = await fetch(`${SUPABASE_URL}/functions/v1/sync-hubspot`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const result = await response.json();
    
    if (result.success) {
      state.lastSync = new Date().toLocaleString();
      await loadFromSupabase();
      mergeData();
      alert(`Synced ${result.deals_synced} deals, ${result.emails_fetched} emails`);
    } else {
      alert('Sync failed: ' + (result.error || 'Unknown error'));
    }
  } catch (e) {
    alert('Sync failed: ' + e.message);
  }
  
  state.syncing = false;
  render();
}

// ============ ADDRESS NORMALIZATION ============

function normalizeAddress(addr) {
  if (!addr) return '';
  let normalized = addr.split('\n')[0].split(',')[0];
  normalized = normalized.toLowerCase().trim()
    .replace(/\s+/g, ' ')
    .replace(/\bstreet\b/g, 'st')
    .replace(/\bavenue\b/g, 'ave')
    .replace(/\bdrive\b/g, 'dr')
    .replace(/\broad\b/g, 'rd')
    .replace(/\bcourt\b/g, 'ct')
    .replace(/\bcircle\b/g, 'cir')
    .replace(/\blane\b/g, 'ln')
    .replace(/\bplace\b/g, 'pl')
    .replace(/\bboulevard\b/g, 'blvd')
    .replace(/\./g, '')
    .replace(/,/g, '')
    .trim();
  return normalized;
}

function extractAddressFromDealName(dealName) {
  if (!dealName) return '';
  const parts = dealName.split(':');
  if (parts.length > 1) {
    return normalizeAddress(parts[1].trim());
  }
  return '';
}

// ============ DATA PROCESSING ============

function parseCustomerName(dealName) {
  if (!dealName) return null;
  let name = dealName.split(':')[0].trim();
  name = name.replace(/\s*\(.*?\)\s*/g, '').trim();
  if (name.includes(',')) {
    const [last, first] = name.split(',', 2);
    return first ? `${first.trim()} ${last.trim()}` : last.trim();
  }
  return name;
}

const permitMap = { 'DONE: Permit approved': 'Approved', 'Permit Rejected': 'Rejected', 'Permit Submitted': 'Submitted', 'Permit Resubmitted': 'Resubmitted', 'Permit revisions in progress': 'Revisions in progress' };
const inspectionMap = { 'Inspection passed': 'Passed', 'Inspection failed': 'Failed', 'Inspection Scheduled': 'Scheduled', 'Inspection requested': 'Requested', 'Inspection Pending HO Action': 'Pending HO Action' };
function mapPermit(s) { return permitMap[s] || s; }
function mapInspection(s) { return inspectionMap[s] || s; }

function getIcfProgress(stage, status) {
  if (stage === "RRF") {
    if (status === "Draft") return "RRF Draft";
    if (["Submitted", "Review", "Technical Review", "Equipment Review"].includes(status)) return "RRF Under Review";
    if (["Suspended", "Resubmitted"].includes(status)) return "RRF Suspended";
    if (["Confirmed", "Reserved"].includes(status)) return "RRF Confirmed";
  } else if (stage === "ICF") {
    if (status === "Draft") return "ICF Draft";
    if (["Submitted", "Review", "Technical Review"].includes(status)) return "ICF Under Review";
    if (["Suspended", "Inspection Suspended", "Resubmitted"].includes(status)) return "ICF Suspended";
    if (status === "Inspection") return "ICF Inspection";
    if (status === "Pending Payment") return "Pending Payment";
  } else if (stage === "Payment") {
    return status === "Completed" ? "Payment Completed" : "Payment Processing";
  } else if (stage === "Cancelled") return "Cancelled";
  return "Not Started";
}

function mergeData() {
  const sgipByEmail = {};
  const sgipByAddress = {};
  const sgipByCode = {};
  
  SGIP_DATA.forEach(s => {
    const email = (s.email || '').toLowerCase().trim();
    if (email) sgipByEmail[email] = s;
    
    const addr = normalizeAddress(s.siteAddress);
    if (addr) sgipByAddress[addr] = s;
    
    if (s.applicationCode) sgipByCode[s.applicationCode] = s;
  });

  const matched = [];
  const hubspotWithoutSgip = [];
  MATCH_STATS = { byEmail: 0, byAddress: 0, byManual: 0, noMatch: 0, excluded: 0 };

  HUBSPOT_DATA.forEach(h => {
    const email = (h.email || '').toLowerCase().trim();
    const hubspotAddr = extractAddressFromDealName(h.dealName);
    
    if (CORRECTIONS.notSgipProject.has(email)) {
      MATCH_STATS.excluded++;
      return;
    }
    
    const isNotInPortal = CORRECTIONS.notInSgip.has(email);
    
    let sgip = null;
    let matchType = null;
    
    if (CORRECTIONS.manualMatches[email]) {
      const code = CORRECTIONS.manualMatches[email];
      sgip = sgipByCode[code];
      if (sgip) matchType = 'manual';
    }
    
    if (!sgip && !isNotInPortal) {
      sgip = sgipByEmail[email];
      if (sgip) matchType = 'email';
    }
    
    if (!sgip && !isNotInPortal && hubspotAddr) {
      sgip = sgipByAddress[hubspotAddr];
      if (sgip) matchType = 'address';
    }
    
    const record = {
      ...h,
      applicationCode: sgip?.applicationCode || '',
      sgipStage: sgip?.sgipStage || '',
      sgipStatus: sgip?.sgipStatus || '',
      currentIncentive: sgip?.currentIncentive || '',
      finalIncentive: sgip?.finalIncentive || '',
      nextDueDate: sgip?.nextDueDate || '',
      siteAddress: sgip?.siteAddress || '',
      utility: sgip?.utility || '',
      icfProgress: getIcfProgress(sgip?.sgipStage || '', sgip?.sgipStatus || ''),
      matchType: matchType,
      notInPortal: isNotInPortal
    };

    if (sgip?.applicationCode) {
      matched.push(record);
      if (matchType === 'email') MATCH_STATS.byEmail++;
      else if (matchType === 'address') MATCH_STATS.byAddress++;
      else if (matchType === 'manual') MATCH_STATS.byManual++;
    } else {
      hubspotWithoutSgip.push(record);
      MATCH_STATS.noMatch++;
    }
  });

  DATA = { matched, hubspotWithoutSgip };
  buildSearchIndex();
  updateMatchStatsDisplay();
  render();
}

function updateMatchStatsDisplay() {
  const statsDiv = document.getElementById('matchStats');
  const contentDiv = document.getElementById('matchStatsContent');
  if (statsDiv && contentDiv) {
    statsDiv.classList.remove('hidden');
    contentDiv.innerHTML = `
      <span class="text-emerald-400">‚úì ${MATCH_STATS.byEmail} by email</span> ¬∑ 
      <span class="text-cyan-400">‚úì ${MATCH_STATS.byAddress} by address</span> ¬∑ 
      <span class="text-purple-400">‚úì ${MATCH_STATS.byManual} manual</span><br>
      <span class="text-amber-400">${MATCH_STATS.noMatch} unmatched</span> ¬∑ 
      <span class="text-slate-500">${MATCH_STATS.excluded} excluded</span>
    `;
  }
}

function buildSearchIndex() {
  SEARCH_INDEX = DATA.matched.map((d, i) => ({
    idx: i,
    text: [d.dealName||'', d.customerName||'', d.applicationCode||'', d.email||'', d.installer||'', d.siteAddress||''].join(' ').toLowerCase()
  }));
}

// ============ FILE UPLOAD ============

function showUploadModal() {
  document.getElementById('uploadModal').classList.remove('hidden');
  document.getElementById('sgipStatus').innerHTML = state.sgipLoaded 
    ? `<span class="text-emerald-400">‚úì ${SGIP_DATA.length} records (saved ${state.sgipLastUpdated || 'unknown'})</span>` 
    : '<span class="text-slate-500">Not loaded</span>';
  updateMatchStatsDisplay();
  setTimeout(setupSgipUpload, 50);
}

function closeUploadModal() { 
  document.getElementById('uploadModal').classList.add('hidden'); 
}

function showCorrectionModal() {
  document.getElementById('correctionModal').classList.remove('hidden');
  document.getElementById('correctionCounts').innerHTML = `
    <span class="text-purple-400">${Object.keys(CORRECTIONS.manualMatches).length} manual matches</span> ¬∑ 
    <span class="text-amber-400">${CORRECTIONS.notInSgip.size} not in portal</span> ¬∑ 
    <span class="text-slate-500">${CORRECTIONS.notSgipProject.size} excluded</span>
  `;
  document.getElementById('correctionUploadStatus').innerHTML = '';
  setTimeout(setupCorrectionUpload, 50);
}

function closeCorrectionModal() { 
  document.getElementById('correctionModal').classList.add('hidden'); 
}

function setupSgipUpload() {
  const sgipZone = document.getElementById('sgipUploadZone');
  if (sgipZone._initialized) return;
  sgipZone._initialized = true;
  
  const sgipInput = document.createElement('input');
  sgipInput.type = 'file';
  sgipInput.accept = '.csv';
  sgipInput.style.display = 'none';
  sgipZone.appendChild(sgipInput);
  sgipZone.onclick = () => sgipInput.click();
  sgipZone.ondragover = (e) => { e.preventDefault(); sgipZone.classList.add('dragover'); };
  sgipZone.ondragleave = () => sgipZone.classList.remove('dragover');
  sgipZone.ondrop = (e) => { e.preventDefault(); sgipZone.classList.remove('dragover'); handleSgipFile(e.dataTransfer.files[0]); };
  sgipInput.onchange = () => handleSgipFile(sgipInput.files[0]);
}

function setupCorrectionUpload() {
  const corrZone = document.getElementById('correctionUploadZone');
  if (corrZone._initialized) return;
  corrZone._initialized = true;
  
  const corrInput = document.createElement('input');
  corrInput.type = 'file';
  corrInput.accept = '.xlsx,.xls';
  corrInput.style.display = 'none';
  corrZone.appendChild(corrInput);
  corrZone.onclick = () => corrInput.click();
  corrZone.ondragover = (e) => { e.preventDefault(); corrZone.classList.add('dragover'); };
  corrZone.ondragleave = () => corrZone.classList.remove('dragover');
  corrZone.ondrop = (e) => { e.preventDefault(); corrZone.classList.remove('dragover'); handleCorrectionFile(e.dataTransfer.files[0]); };
  corrInput.onchange = () => handleCorrectionFile(corrInput.files[0]);
}

async function handleSgipFile(file) {
  if (!file) return;
  document.getElementById('sgipStatus').innerHTML = '<span class="text-blue-400">Processing...</span>';
  
  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: async function(results) {
      const newSgipData = results.data.map(row => ({
        email: (row['Host Customer Email'] || '').toLowerCase().trim(),
        applicationCode: row['Application Code'] || '',
        sgipStage: row['Stage'] || '',
        sgipStatus: row['Status'] || '',
        currentIncentive: row['Current Incentive ($)'] || '',
        finalIncentive: row['Final Incentive (ICF)'] || '',
        nextDueDate: row['Next Due Date'] || '',
        siteAddress: row['Site Address'] || '',
        utility: row['Electric Utility'] || ''
      })).filter(s => s.applicationCode);
      
      document.getElementById('sgipStatus').innerHTML = '<span class="text-blue-400">Saving to database...</span>';
      
      const saved = await saveSgipToSupabase(newSgipData);
      
      if (saved) {
        SGIP_DATA = newSgipData;
        state.sgipLoaded = true;
        document.getElementById('sgipStatus').innerHTML = `<span class="text-emerald-400">‚úì Saved ${SGIP_DATA.length} records!</span>`;
        mergeData();
      } else {
        document.getElementById('sgipStatus').innerHTML = `<span class="text-red-400">Failed to save. Check console.</span>`;
      }
    },
    error: function(err) {
      document.getElementById('sgipStatus').innerHTML = `<span class="text-red-400">Error: ${err.message}</span>`;
    }
  });
}

async function handleCorrectionFile(file) {
  if (!file) return;
  document.getElementById('correctionUploadStatus').innerHTML = '<span class="text-blue-400">Processing...</span>';
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const workbook = XLSX.read(e.target.result, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
      
      let headerIdx = 0;
      for (let i = 0; i < Math.min(5, rows.length); i++) {
        if (rows[i].some(c => String(c).toLowerCase().includes('email'))) {
          headerIdx = i;
          break;
        }
      }
      
      const headers = rows[headerIdx].map(h => String(h).toLowerCase().trim());
      const emailIdx = headers.findIndex(h => h.includes('email'));
      const sgipIdx = headers.findIndex(h => h.includes('sgip'));
      
      const newCorrections = { manualMatches: {}, notInSgip: new Set(), notSgipProject: new Set() };
      
      for (let i = headerIdx + 1; i < rows.length; i++) {
        const row = rows[i];
        const email = (row[emailIdx] || '').toLowerCase().trim();
        const sgipStatus = (row[sgipIdx] || '').trim();
        
        if (!email) continue;
        
        if (sgipStatus.toLowerCase() === 'not an sgip project') {
          newCorrections.notSgipProject.add(email);
        } else if (sgipStatus.toLowerCase() === 'not in sgip portal') {
          newCorrections.notInSgip.add(email);
        } else if (sgipStatus && sgipStatus.includes('SGIP')) {
          newCorrections.manualMatches[email] = sgipStatus;
        }
      }
      
      const totalCount = Object.keys(newCorrections.manualMatches).length + newCorrections.notInSgip.size + newCorrections.notSgipProject.size;
      
      document.getElementById('correctionUploadStatus').innerHTML = '<span class="text-blue-400">Saving to database...</span>';
      
      const saved = await saveCorrectionsToSupabase(newCorrections);
      
      if (saved) {
        Object.assign(CORRECTIONS.manualMatches, newCorrections.manualMatches);
        newCorrections.notInSgip.forEach(e => CORRECTIONS.notInSgip.add(e));
        newCorrections.notSgipProject.forEach(e => CORRECTIONS.notSgipProject.add(e));
        
        document.getElementById('correctionUploadStatus').innerHTML = `<span class="text-emerald-400">‚úì Saved ${totalCount} corrections!</span>`;
        document.getElementById('correctionCounts').innerHTML = `
          <span class="text-purple-400">${Object.keys(CORRECTIONS.manualMatches).length} manual matches</span> ¬∑ 
          <span class="text-amber-400">${CORRECTIONS.notInSgip.size} not in portal</span> ¬∑ 
          <span class="text-slate-500">${CORRECTIONS.notSgipProject.size} excluded</span>
        `;
        
        mergeData();
      } else {
        document.getElementById('correctionUploadStatus').innerHTML = `<span class="text-red-400">Failed to save.</span>`;
      }
    } catch (err) {
      document.getElementById('correctionUploadStatus').innerHTML = `<span class="text-red-400">Error: ${err.message}</span>`;
    }
  };
  reader.readAsArrayBuffer(file);
}

// ============ UI HELPERS ============

const STAGES = [
  { key: 'Not Started', label: 'Not Started', color: '#64748b', stage: 0 },
  { key: 'RRF Draft', label: 'RRF Draft', color: '#f59e0b', stage: 1 },
  { key: 'RRF Under Review', label: 'RRF Review', color: '#3b82f6', stage: 1 },
  { key: 'RRF Suspended', label: 'RRF Suspended', color: '#ef4444', stage: 1 },
  { key: 'RRF Confirmed', label: 'RRF Confirmed', color: '#10b981', stage: 2 },
  { key: 'ICF Draft', label: 'ICF Draft', color: '#f59e0b', stage: 3 },
  { key: 'ICF Under Review', label: 'ICF Review', color: '#3b82f6', stage: 3 },
  { key: 'ICF Suspended', label: 'ICF Suspended', color: '#ef4444', stage: 3 },
  { key: 'ICF Inspection', label: 'ICF Inspection', color: '#8b5cf6', stage: 4 },
  { key: 'Pending Payment', label: 'Pending Payment', color: '#06b6d4', stage: 4 },
  { key: 'Payment Completed', label: 'Paid', color: '#22c55e', stage: 5 },
];

const getStageInfo = k => STAGES.find(s => s.key === k) || STAGES[0];
const parseNum = v => v ? parseFloat(String(v).replace(/[$,]/g, '')) || 0 : 0;
const fmtCurrency = v => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(v);
const getDaysSince = d => { if (!d || d === 'None') return null; try { return Math.floor((new Date() - new Date(d)) / 86400000); } catch { return null; } };
const parseDate = d => { if (!d || d === 'None' || d === '(No value)') return null; try { if (String(d).includes('/')) { const [m, day, y] = String(d).split('/'); return new Date(2000 + parseInt(y), parseInt(m) - 1, parseInt(day)); } return new Date(d); } catch { return null; } };
const getHubSpotUrl = id => id ? `https://app.hubspot.com/contacts/${HUBSPOT_PORTAL_ID}/deal/${id}` : null;

function getFilterCounts(field, transform = v => v) {
  const counts = {};
  DATA.matched.forEach(d => { let val = transform(d[field]); if (!val || val === '(No value)' || val === 'None') val = '(empty)'; counts[val] = (counts[val] || 0) + 1; });
  return Object.entries(counts).sort((a,b) => b[1] - a[1]);
}

function getFilteredData() {
  let indices = state.search ? SEARCH_INDEX.filter(s => s.text.includes(state.search.toLowerCase())).map(s => s.idx) : DATA.matched.map((_, i) => i);
  let r = indices.map(i => ({ ...DATA.matched[i], _index: i, daysSinceInstall: getDaysSince(DATA.matched[i].installDate) }));
  
  if (state.filters.permitStatus.length > 0) r = r.filter(d => state.filters.permitStatus.includes(d.permitStatus || '(empty)') || (!d.permitStatus && state.filters.permitStatus.includes('(empty)')));
  if (state.filters.inspectionStatus.length > 0) r = r.filter(d => { let v = d.inspectionStatus; if (!v || v === '(No value)') v = '(empty)'; return state.filters.inspectionStatus.includes(v); });
  if (state.filters.ptoStatus.length > 0) r = r.filter(d => { const has = d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None'; return state.filters.ptoStatus.includes(has ? 'Complete' : 'Pending'); });
  if (state.filters.sgipStage.length > 0) r = r.filter(d => state.filters.sgipStage.includes(d.sgipStage || '(empty)'));
  if (state.filters.sgipStatus.length > 0) r = r.filter(d => state.filters.sgipStatus.includes(d.sgipStatus || '(empty)'));
  if (state.filters.icfProgress.length > 0) r = r.filter(d => state.filters.icfProgress.includes(d.icfProgress));
  if (state.filters.installer.length > 0) r = r.filter(d => { let v = d.installer; if (!v || v === '(No value)') v = '(empty)'; return state.filters.installer.includes(v); });

  r.sort((a, b) => {
    let av, bv;
    if (state.sortBy === 'daysSinceInstall') { av = a.daysSinceInstall ?? -1; bv = b.daysSinceInstall ?? -1; }
    else if (state.sortBy === 'installDate') { const da = parseDate(a.installDate), db = parseDate(b.installDate); av = da ? da.getTime() : (state.sortDir === 'asc' ? Infinity : -Infinity); bv = db ? db.getTime() : (state.sortDir === 'asc' ? Infinity : -Infinity); }
    else if (state.sortBy === 'incentive') { av = parseNum(a.currentIncentive); bv = parseNum(b.currentIncentive); }
    else if (state.sortBy === 'name') { av = a.customerName || ''; bv = b.customerName || ''; }
    else if (state.sortBy === 'stage') { av = getStageInfo(a.icfProgress).stage; bv = getStageInfo(b.icfProgress).stage; }
    else if (state.sortBy === 'nextDue') { const da = parseDate(a.nextDueDate), db = parseDate(b.nextDueDate); av = da ? da.getTime() : (state.sortDir === 'asc' ? Infinity : -Infinity); bv = db ? db.getTime() : (state.sortDir === 'asc' ? Infinity : -Infinity); }
    if (typeof av === 'string') return state.sortDir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
    return state.sortDir === 'asc' ? av - bv : bv - av;
  });
  return r;
}

function getStats() {
  const m = DATA.matched;
  return { total: m.length, paid: m.filter(d => d.icfProgress === 'Payment Completed').length, suspended: m.filter(d => (d.icfProgress || '').includes('Suspended')).length, totalIncentive: m.reduce((s, d) => s + parseNum(d.currentIncentive), 0), paidIncentive: m.filter(d => d.icfProgress === 'Payment Completed').reduce((s, d) => s + parseNum(d.finalIncentive), 0), ptoComplete: m.filter(d => d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None').length, permitted: m.filter(d => d.permitStatus === 'Approved').length, noSgip: DATA.hubspotWithoutSgip.length };
}

const getPermitStyle = s => { if (!s) return 'bg-slate-800 text-slate-500 border-slate-700'; if (s === 'Approved') return 'bg-green-900/50 text-green-400 border-green-800'; if (s === 'Rejected') return 'bg-red-900/50 text-red-400 border-red-800'; if (s === 'Submitted' || s === 'Resubmitted') return 'bg-blue-900/50 text-blue-400 border-blue-800'; return 'bg-amber-900/50 text-amber-400 border-amber-800'; };
const getInspectionStyle = s => { if (!s || s === '(No value)') return 'bg-slate-800 text-slate-500 border-slate-700'; if (s === 'Passed') return 'bg-green-900/50 text-green-400 border-green-800'; if (s === 'Failed' || (s && s.includes('Needed')) || s === 'Pending HO Action') return 'bg-red-900/50 text-red-400 border-red-800'; if (s === 'Scheduled' || s === 'Requested') return 'bg-blue-900/50 text-blue-400 border-blue-800'; return 'bg-amber-900/50 text-amber-400 border-amber-800'; };
const getPTOStyle = d => (!d || d === '(No value)' || d === 'None') ? 'bg-slate-800 text-slate-500 border-slate-700' : 'bg-green-900/50 text-green-400 border-green-800';
const getDaysColor = d => d === null ? 'text-slate-600' : d > 90 ? 'text-red-400' : d > 60 ? 'text-amber-400' : d > 30 ? 'text-yellow-400' : 'text-slate-300';

function setTab(t) { state.tab = t; state.search = ''; render(); }
function updateSearch(v) { state.search = v; if (searchTimeout) clearTimeout(searchTimeout); searchTimeout = setTimeout(() => render(), 150); }
function setSort(col) { if (state.sortBy === col) state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc'; else { state.sortBy = col; state.sortDir = 'desc'; } render(); }
function toggleFilter(key, val) { const idx = state.filters[key].indexOf(val); if (idx >= 0) state.filters[key].splice(idx, 1); else state.filters[key].push(val); render(); }
function selectAllFilter(key, options) { state.filters[key] = options.map(o => o[0]); render(); }
function clearFilterKey(key) { state.filters[key] = []; render(); }
function clearFilters() { Object.keys(state.filters).forEach(k => state.filters[k] = []); state.search = ''; render(); }
function hasActiveFilters() { return state.search || Object.values(state.filters).some(v => v.length > 0); }

const PERMIT_OPTIONS = ['Approved', 'Rejected', 'Submitted', 'Resubmitted', 'Revisions in progress'];
const INSPECTION_OPTIONS = ['Passed', 'Failed', 'Scheduled', 'Requested', 'Pending HO Action'];

function openEditModal(idx, field) {
  const deal = getFilteredData()[idx];
  state.editingDeal = idx; state.editingField = field;
  document.getElementById('editModalTitle').textContent = `Edit ${field === 'inspectionStatus' ? 'Inspection' : field === 'permitStatus' ? 'Permit' : 'PTO'}`;
  let html = '';
  if (field === 'inspectionStatus') html = `<select id="editValue" class="w-full px-4 py-2 rounded-lg bg-slate-900 border border-slate-700">${INSPECTION_OPTIONS.map(o => `<option ${deal.inspectionStatus === o ? 'selected' : ''}>${o}</option>`).join('')}</select>`;
  else if (field === 'permitStatus') html = `<select id="editValue" class="w-full px-4 py-2 rounded-lg bg-slate-900 border border-slate-700">${PERMIT_OPTIONS.map(o => `<option ${deal.permitStatus === o ? 'selected' : ''}>${o}</option>`).join('')}</select>`;
  else if (field === 'ptoDate') html = `<input type="date" id="editValue" class="w-full px-4 py-2 rounded-lg bg-slate-900 border border-slate-700" value="${deal.ptoDate || ''}">`;
  html += `<p class="text-xs text-slate-500 mt-2">${deal.customerName || deal.dealName}</p>`;
  document.getElementById('editModalContent').innerHTML = html;
  document.getElementById('editModal').classList.remove('hidden');
}
function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }
function saveEdit() {
  const val = document.getElementById('editValue').value;
  const deal = getFilteredData()[state.editingDeal];
  const idx = DATA.matched.findIndex(d => d.dealId === deal.dealId);
  if (idx >= 0) DATA.matched[idx][state.editingField] = val;
  buildSearchIndex(); closeEditModal(); render();
}

function filterHeader(label, filterKey, sortKey, options, editable = false) {
  const cnt = state.filters[filterKey].length;
  const isFiltered = cnt > 0;
  const isSorted = state.sortBy === sortKey;
  return `<th class="px-2 py-3 text-left text-xs font-semibold uppercase"><div class="dropdown"><span class="cursor-pointer hover:text-slate-200 ${isFiltered ? 'filter-active' : 'text-slate-400'}">${label}${isSorted ? (state.sortDir === 'asc' ? ' ‚Üë' : ' ‚Üì') : ''}${isFiltered ? ` (${cnt})` : ''}${editable ? ' ‚úé' : ''}<svg class="w-3 h-3 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></span><div class="dropdown-menu" onclick="event.stopPropagation()">${sortKey ? `<div class="p-2 border-b border-slate-700"><div class="text-[10px] text-slate-500 uppercase mb-1">Sort</div><div class="dropdown-item rounded ${isSorted && state.sortDir === 'desc' ? 'active' : ''}" onclick="setSort('${sortKey}')">Highest First</div><div class="dropdown-item rounded ${isSorted && state.sortDir === 'asc' ? 'active' : ''}" onclick="state.sortBy='${sortKey}';state.sortDir='asc';render();">Lowest First</div></div>` : ''}<div class="p-2"><div class="flex justify-between items-center mb-2"><div class="text-[10px] text-slate-500 uppercase">Filter</div><div class="flex gap-1"><button onclick="selectAllFilter('${filterKey}',${JSON.stringify(options).replace(/"/g,'&quot;')})" class="text-[10px] px-2 py-0.5 bg-slate-700 hover:bg-slate-600 rounded">All</button><button onclick="clearFilterKey('${filterKey}')" class="text-[10px] px-2 py-0.5 bg-slate-700 hover:bg-slate-600 rounded">None</button></div></div>${options.map(([v,c]) => `<label class="checkbox-item rounded"><input type="checkbox" ${state.filters[filterKey].includes(v) ? 'checked' : ''} onchange="toggleFilter('${filterKey}','${v.replace(/'/g,"\\'")}')"><span class="flex-1">${v.length > 25 ? v.slice(0,23)+'..' : v}</span><span class="text-slate-500">(${c})</span></label>`).join('')}</div></div></div></th>`;
}

function customerCell(d) {
  const url = getHubSpotUrl(d.dealId);
  const name = d.customerName || d.dealName || '‚Äî';
  let badge = '';
  if (d.matchType === 'address') badge = '<span class="ml-1 text-[9px] px-1 py-0.5 bg-cyan-900/50 text-cyan-400 rounded">addr</span>';
  else if (d.matchType === 'manual') badge = '<span class="ml-1 text-[9px] px-1 py-0.5 bg-purple-900/50 text-purple-400 rounded">manual</span>';
  return url ? `<a href="${url}" target="_blank" class="font-medium text-cyan-400 hover:text-cyan-300 hover:underline">${name}</a>${badge}` : `<span class="font-medium">${name}</span>${badge}`;
}

function render() {
  const stats = getStats();
  const filtered = state.tab === 'matched' ? getFilteredData() : DATA.hubspotWithoutSgip;
  const stageCounts = {}; DATA.matched.forEach(d => stageCounts[d.icfProgress] = (stageCounts[d.icfProgress] || 0) + 1);
  const activeStages = STAGES.filter(s => stageCounts[s.key] > 0);

  const permitOpts = getFilterCounts('permitStatus');
  const inspectOpts = getFilterCounts('inspectionStatus', v => (!v || v === '(No value)') ? '(empty)' : v);
  const ptoOpts = [['Complete', DATA.matched.filter(d => d.ptoDate && d.ptoDate !== '(No value)' && d.ptoDate !== 'None').length], ['Pending', DATA.matched.filter(d => !d.ptoDate || d.ptoDate === '(No value)' || d.ptoDate === 'None').length]];
  const sgipStageOpts = getFilterCounts('sgipStage', v => v || '(empty)');
  const sgipStatusOpts = getFilterCounts('sgipStatus', v => v || '(empty)');
  const icfOpts = STAGES.filter(s => stageCounts[s.key] > 0).map(s => [s.key, stageCounts[s.key]]);
  const installerOpts = getFilterCounts('installer', v => (!v || v === '(No value)') ? '(empty)' : v);

  const correctionCount = Object.keys(CORRECTIONS.manualMatches).length + CORRECTIONS.notInSgip.size + CORRECTIONS.notSgipProject.size;

  document.getElementById('app').innerHTML = `
    <div class="bg-slate-800/80 border-b border-slate-700/50 sticky top-0 z-30">
      <div class="max-w-[1920px] mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-emerald-500 to-cyan-500 flex items-center justify-center"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div>
          <div><h1 class="text-lg font-bold bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">Haven Energy</h1><p class="text-xs text-slate-400">Post-Install Portal</p></div>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="triggerSync()" class="sync-btn ${state.syncing ? 'syncing' : ''} px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-500 rounded-lg font-medium" ${state.syncing ? 'disabled' : ''}>${state.syncing ? '‚ü≥ Syncing...' : '‚ü≥ Sync HubSpot'}</button>
          <button onclick="showUploadModal()" class="px-3 py-1.5 text-xs bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">üì§ Update SGIP</button>
          <button onclick="showCorrectionModal()" class="px-3 py-1.5 text-xs bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">‚öôÔ∏è Corrections ${correctionCount > 0 ? `(${correctionCount})` : ''}</button>
          <span class="text-xs text-slate-500">${state.lastSync ? `HubSpot: ${state.lastSync}` : ''} ${state.sgipLastUpdated ? `‚Ä¢ SGIP: ${state.sgipLastUpdated}` : ''}</span>
        </div>
      </div>
    </div>
    <div class="max-w-[1920px] mx-auto px-4 py-4">
      <div class="flex gap-2 mb-4">
        <button onclick="setTab('matched')" class="px-4 py-2 rounded-lg text-sm font-medium ${state.tab === 'matched' ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/40' : 'bg-slate-800/50 text-slate-400 border border-slate-700/50'}">Matched (${DATA.matched.length})</button>
        <button onclick="setTab('noSgip')" class="px-4 py-2 rounded-lg text-sm font-medium ${state.tab === 'noSgip' ? 'bg-amber-500/20 text-amber-400 border border-amber-500/40' : 'bg-slate-800/50 text-slate-400 border border-slate-700/50'}">Not in SGIP Portal (${DATA.hubspotWithoutSgip.length})</button>
      </div>
      ${state.tab === 'matched' ? `
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2 mb-4">
          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Total</p><p class="text-lg font-bold">${stats.total}</p></div>
          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Permitted</p><p class="text-lg font-bold">${stats.permitted}</p></div>
          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">PTO Done</p><p class="text-lg font-bold">${stats.ptoComplete}</p></div>
          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Pipeline</p><p class="text-lg font-bold">${fmtCurrency(stats.totalIncentive)}</p></div>
          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Paid</p><p class="text-lg font-bold text-emerald-400">${fmtCurrency(stats.paidIncentive)}</p></div>
          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">Suspended</p><p class="text-lg font-bold text-red-400">${stats.suspended}</p></div>
          <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50"><p class="text-slate-500 text-xs uppercase">No SGIP</p><p class="text-lg font-bold text-amber-400">${stats.noSgip}</p></div>
        </div>
        ${activeStages.length > 0 ? `<div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50 mb-4"><div class="flex rounded overflow-hidden h-6 bg-slate-900">${activeStages.map(s => { const cnt = stageCounts[s.key] || 0, pct = (cnt / DATA.matched.length) * 100; return pct < 0.5 ? '' : `<div style="width:${pct}%;background:${s.color};min-width:18px" class="flex items-center justify-center text-white text-xs font-bold">${cnt}</div>`; }).join('')}</div><div class="flex flex-wrap gap-2 mt-2">${activeStages.map(s => `<span class="flex items-center gap-1 text-xs"><span class="w-2 h-2 rounded-full" style="background:${s.color}"></span><span class="text-slate-500">${s.label}</span></span>`).join('')}</div></div>` : ''}
        <div class="flex flex-wrap gap-3 mb-4 items-center">
          <input type="text" placeholder="Search customer, code, email, installer..." class="flex-1 min-w-[250px] max-w-md px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm" value="${state.search}" oninput="updateSearch(this.value)">
          ${hasActiveFilters() ? `<button onclick="clearFilters()" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm font-medium">‚úï Clear Filters</button>` : ''}
        </div>
        <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
          <div class="px-3 py-2 border-b border-slate-700/50 text-sm"><span class="font-semibold">${filtered.length}</span> deals ${hasActiveFilters() ? '<span class="text-emerald-400">(filtered)</span>' : ''} <span class="text-slate-500 text-xs ml-2">‚Ä¢ <span class="text-cyan-400">addr</span>=address ‚Ä¢ <span class="text-purple-400">manual</span>=correction</span></div>
          <div class="table-container overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="sticky-header"><tr>
                <th class="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer" onclick="setSort('name')">Customer ${state.sortBy === 'name' ? (state.sortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>
                <th class="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer" onclick="setSort('installDate')">Install ${state.sortBy === 'installDate' ? (state.sortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>
                <th class="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer" onclick="setSort('daysSinceInstall')">Days ${state.sortBy === 'daysSinceInstall' ? (state.sortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>
                ${filterHeader('Permit', 'permitStatus', null, permitOpts, true)}
                ${filterHeader('Inspection', 'inspectionStatus', null, inspectOpts, true)}
                ${filterHeader('PTO', 'ptoStatus', null, ptoOpts, true)}
                ${filterHeader('SGIP Stage', 'sgipStage', null, sgipStageOpts)}
                ${filterHeader('SGIP Status', 'sgipStatus', null, sgipStatusOpts)}
                ${filterHeader('ICF Progress', 'icfProgress', 'stage', icfOpts)}
                <th class="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer" onclick="setSort('nextDue')">Next Due ${state.sortBy === 'nextDue' ? (state.sortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>
                <th class="px-2 py-3 text-left text-xs font-semibold text-slate-400 uppercase cursor-pointer" onclick="setSort('incentive')">Incentive ${state.sortBy === 'incentive' ? (state.sortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>
                ${filterHeader('Installer', 'installer', null, installerOpts)}
              </tr></thead>
              <tbody class="divide-y divide-slate-700/30">${filtered.length === 0 ? '<tr><td colspan="12" class="p-8 text-center text-slate-500">No deals found.</td></tr>' : filtered.map((d, i) => {
                const info = getStageInfo(d.icfProgress);
                return `<tr class="hover:bg-slate-800/50">
                  <td class="px-2 py-2"><div class="min-w-[150px]">${customerCell(d)}${d.applicationCode?`<br><span class="text-xs text-slate-500 mono">${d.applicationCode}</span>`:''}</div></td>
                  <td class="px-2 py-2 text-xs mono">${d.installDate||'‚Äî'}</td>
                  <td class="px-2 py-2"><span class="font-semibold ${getDaysColor(d.daysSinceInstall)}">${d.daysSinceInstall!==null?d.daysSinceInstall+'d':'‚Äî'}</span></td>
                  <td class="px-2 py-2"><span class="editable px-1.5 py-0.5 rounded text-xs border ${getPermitStyle(d.permitStatus)}" onclick="openEditModal(${i},'permitStatus')">${d.permitStatus||'‚Äî'}</span></td>
                  <td class="px-2 py-2"><span class="editable px-1.5 py-0.5 rounded text-xs border ${getInspectionStyle(d.inspectionStatus)}" onclick="openEditModal(${i},'inspectionStatus')">${d.inspectionStatus&&d.inspectionStatus!=='(No value)'?d.inspectionStatus:'‚Äî'}</span></td>
                  <td class="px-2 py-2"><span class="editable px-1.5 py-0.5 rounded text-xs border ${getPTOStyle(d.ptoDate)}" onclick="openEditModal(${i},'ptoDate')">${d.ptoDate&&d.ptoDate!=='(No value)'&&d.ptoDate!=='None'?d.ptoDate:'Pending'}</span></td>
                  <td class="px-2 py-2 text-xs">${d.sgipStage||'‚Äî'}</td>
                  <td class="px-2 py-2 text-xs text-slate-400">${d.sgipStatus||'‚Äî'}</td>
                  <td class="px-2 py-2"><span class="px-1.5 py-0.5 rounded text-xs font-medium" style="background:${info.color}20;color:${info.color}">${info.label}</span></td>
                  <td class="px-2 py-2 text-xs mono">${d.nextDueDate||'‚Äî'}</td>
                  <td class="px-2 py-2 text-right"><span class="${d.icfProgress==='Payment Completed'?'text-emerald-400':'text-slate-300'}">${d.currentIncentive||'‚Äî'}</span></td>
                  <td class="px-2 py-2 text-xs text-slate-400">${d.installer||'‚Äî'}</td>
                </tr>`;
              }).join('')}</tbody>
            </table>
          </div>
        </div>
      ` : `
        <div class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 mb-4"><h3 class="font-semibold text-amber-400">Not in SGIP Portal</h3><p class="text-sm text-slate-400 mt-1">${DATA.hubspotWithoutSgip.length} deals that couldn't be matched.</p></div>
        <div class="bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden">
          <div class="table-container overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="sticky-header"><tr><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Customer</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Email</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Install</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Permit</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Inspection</th><th class="px-3 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Installer</th></tr></thead>
              <tbody class="divide-y divide-slate-700/30">${filtered.map(d => `<tr class="hover:bg-slate-800/50"><td class="px-3 py-2">${customerCell(d)}</td><td class="px-3 py-2 text-xs mono text-slate-400">${d.email||'‚Äî'}</td><td class="px-3 py-2 mono text-xs">${d.installDate||'‚Äî'}</td><td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getPermitStyle(d.permitStatus)}">${d.permitStatus||'‚Äî'}</span></td><td class="px-3 py-2"><span class="px-1.5 py-0.5 rounded text-xs border ${getInspectionStyle(d.inspectionStatus)}">${d.inspectionStatus||'‚Äî'}</span></td><td class="px-3 py-2 text-xs text-slate-400">${d.installer||'‚Äî'}</td></tr>`).join('')}</tbody>
            </table>
          </div>
        </div>
      `}
    </div>
  `;
}

// Initialize
async function init() {
  document.getElementById('app').innerHTML = '<div class="flex items-center justify-center h-64"><div class="text-center"><div class="text-2xl mb-2">‚ü≥</div><p class="text-slate-400">Loading...</p></div></div>';
  
  // Load all data from Supabase
  await Promise.all([
    loadCorrectionsFromSupabase(),
    loadSgipFromSupabase(),
    loadFromSupabase()
  ]);
  
  mergeData();
}

init();
  </script>
</body>
</html>
